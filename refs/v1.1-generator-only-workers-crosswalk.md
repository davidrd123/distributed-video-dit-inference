# v1.1 “Generator-only Workers” — Crosswalk (Scope notes ↔ Library operator manuals)

Date: 2026-02-22  
Status: Anchor pass (reviewable)

## Purpose

When implementing or reviewing **TP v1.1 generator-only workers** (and the PP follow-ons it enables), the slow part is re-deriving the “ship checklist” from several long notes.

This doc maps:
- `scope-drd/notes/FA4/h200/tp/v1.1-generator-only-workers.md` sections → **which library topics to reread** (operator manuals), and
- where to go in `scope-drd/notes/FA4/h200/tp/` for the project-local ground truth.

Companion plan doc: `refs/tp-pp-operator-manual-packaging.md`.

## What to treat as source of truth

- **Design + invariants**: `scope-drd/notes/FA4/h200/tp/v1.1-generator-only-workers.md`
- **Failure taxonomy + guardrails**: `scope-drd/notes/FA4/h200/tp/explainers/06-failure-modes.md`
- **Control-plane mechanics (TP)**: `scope-drd/notes/FA4/h200/tp/explainers/03-broadcast-envelope.md`
- **v0 “what’s locked and why”**: `scope-drd/notes/FA4/h200/tp/explainers/07-v0-contract.md`
- **Deadlock audit for v1.1c**: `scope-drd/notes/FA4/h200/tp/5pro/10-v11-correctness-deadlock-audit/response.md`
- **PP follow-on (rank0-out-of-mesh) execution**: `scope-drd/notes/FA4/h200/tp/pp-next-steps.md`, `scope-drd/notes/FA4/h200/tp/pp-topology-pilot-plan.md`, `scope-drd/notes/FA4/h200/tp/pp0-bringup-runbook.md`

## Operator-manual topics (the “ship checklists”)

These are the library docs that should become 1-page enforceable checklists (contract + tripwires + break-it tests + instrumentation):

- Control-plane contract: `refs/topics/20-message-framing-versioning.md`
- Deadlocks (ordering, groups, stranding): `refs/topics/02-deadlock-patterns.md`
- Shutdown/draining: `refs/topics/03-graceful-shutdown.md`
- Backpressure/overlap (PP): `refs/topics/19-producer-consumer-backpressure.md`
- Idempotency/replay primitives (epochs, drops): `refs/topics/21-idempotency-and-replay.md`
- Determinism/drift detection: `refs/topics/04-determinism-across-ranks.md`
- KV-cache lifecycle: `refs/topics/22-kv-cache-management.md`

Minimal “physics cards” to reread when you need authoritative backing:
- `refs/resources/nccl-user-guide.md`
- `refs/resources/pytorch-cuda-semantics.md`
- `refs/resources/funcol-rfc-93173.md`
- `refs/resources/dynamo-deep-dive.md`

## Crosswalk: v1.1 scaffold → what to reread

All “v1.1 scaffold section” names in the left column are headings inside `scope-drd/notes/FA4/h200/tp/v1.1-generator-only-workers.md`.

| v1.1 scaffold section | Implementation / review question | Scope notes to consult | Library operator-manual topics |
|---|---|---|---|
| **Why v1.1 exists** (memory/startup/topology) | Are we optimizing the right thing (structural foundation vs FPS)? What’s the ROI gate? | `scope-drd/notes/FA4/h200/tp/bringup-run-log.md` (worker memory)<br>`scope-drd/notes/FA4/h200/tp/session-state.md` | `refs/topics/16-roofline-model.md` → `### Mental model`<br>`refs/topics/15-pipeline-scheduling-theory.md` → `### Mental model` |
| **Hard constraints** (identical inputs, lockstep, crash>hang) | What *must* be identical across ranks and why do failures become hang vs Franken-model? | `scope-drd/notes/FA4/h200/tp/explainers/06-failure-modes.md` (hang taxonomy + “crash > hang”)<br>`scope-drd/notes/FA4/h200/tp/explainers/07-v0-contract.md` (env parity principle) | `refs/topics/02-deadlock-patterns.md` → `### Practical checklist`<br>`refs/topics/04-determinism-across-ranks.md` → `### Practical checklist`<br>`refs/topics/03-graceful-shutdown.md` → `### Practical checklist` |
| **Phase A/B/C split** | What moves to rank0 vs what stays lockstep? What state must remain consistent? | `scope-drd/notes/FA4/h200/tp/v1.1-generator-only-workers.md` → `## The core move: split each chunk into three phases`<br>`scope-drd/notes/FA4/h200/tp/async-decode-overlap-scoping.md` (recompute coupling)<br>`scope-drd/notes/FA4/h200/tp/pp-topology-pilot-plan.md` (Stage0/Stage1 split) | `refs/topics/22-kv-cache-management.md` → `### Mental model` + `### Gotchas and failure modes`<br>`refs/topics/19-producer-consumer-backpressure.md` → `### Mental model` |
| **Control-plane shape** (`tp_plan`, `tp_envelope_version`, action choice) | How do we version and dispatch the worker path without introducing conditional-collective deadlocks? | `scope-drd/notes/FA4/h200/tp/explainers/03-broadcast-envelope.md` → `## The Two-Part Protocol` + `## The Three Actions`<br>`scope-drd/notes/FA4/h200/tp/5pro/10-v11-correctness-deadlock-audit/response.md` → `## Failure-mode audit` (FM-01..FM-04) | `refs/topics/20-message-framing-versioning.md` → `### Practical checklist` + `#### Worked example`<br>`refs/topics/02-deadlock-patterns.md` → `### Gotchas and failure modes` |
| **What must cross rank0 → workers** (“generator envelope”) | What is required every chunk vs only on updates? How do we ensure “no fallback” under v1 plan? | `scope-drd/notes/FA4/h200/tp/v1.1-generator-only-workers.md` → `## What must cross rank0 → workers (the “TP generator envelope”)`<br>`scope-drd/notes/FA4/h200/tp/explainers/03-broadcast-envelope.md` → `## What Gets Broadcast (and What Doesn't)` (tensor_specs) | `refs/topics/20-message-framing-versioning.md` → `#### Worked example`<br>`refs/topics/04-determinism-across-ranks.md` → `### Key concepts`<br>`refs/topics/22-kv-cache-management.md` → `### Key concepts` (recompute coupling) |
| **Risk-ranked milestones (v1.1a/b/c)** | What is the minimum wedge that reduces coupling risk without new hang surfaces? | `scope-drd/notes/FA4/h200/tp/v1.1-generator-only-workers.md` → `## MVP decomposition` + `## Risk-Ranked Bringup Plan`<br>`scope-drd/notes/FA4/h200/tp/bringup-run-log.md` (v1.1 matrix) | `refs/topics/22-kv-cache-management.md` → “Per-chunk phases” + “Required tensors”<br>`refs/topics/20-message-framing-versioning.md` → “Lockstep call-count checks” |
| **Invariants / tripwires** | Where do we assert call-count, plan parity, dtype support, monotonic IDs, “no nested tensors”? | `scope-drd/notes/FA4/h200/tp/v1.1-generator-only-workers.md` → `## Invariants / tripwires (what we’ll enforce)`<br>`scope-drd/notes/FA4/h200/tp/5pro/10-v11-correctness-deadlock-audit/response.md` → `## Extra “tripwire” you should add for v1.1c bringup` + `## Prioritized safeguard checklist`<br>`scope-drd/notes/FA4/h200/tp/explainers/06-failure-modes.md` | `refs/topics/02-deadlock-patterns.md` → `### Practical checklist` + `### Experiments to run`<br>`refs/topics/20-message-framing-versioning.md` → `### Practical checklist` + `### Experiments to run`<br>`refs/topics/04-determinism-across-ranks.md` → `### Practical checklist` |
| **Safeguards checklist (crash > hang)** | How do we guarantee “fail before broadcast/collectives,” and what watchdog/timeouts apply? | `scope-drd/notes/FA4/h200/tp/v1.1-generator-only-workers.md` → `## Safeguards Checklist (v1.1c “crash > hang”)`<br>`scope-drd/notes/FA4/h200/tp/pp-next-steps.md` → `### Step A1: Harden PP send semantics (anti-stranding)`<br>`scope-drd/notes/FA4/h200/tp/5pro/10-v11-correctness-deadlock-audit/response.md` → `## Prioritized safeguard checklist` | `refs/topics/03-graceful-shutdown.md` → `### Practical checklist`<br>`refs/topics/20-message-framing-versioning.md` → “Anti-stranding ordering” + `### Experiments to run` |
| **How we’ll measure progress** | What metrics prove success (memory/startup), and what counters catch regressions (graph breaks, unique graphs)? | `scope-drd/notes/FA4/h200/tp/v1.1-generator-only-workers.md` → `## How we’ll measure progress (no guessing)`<br>`scope-drd/notes/FA4/h200/tp/research-program.md` (compile regression gates)<br>`scope-drd/notes/FA4/h200/tp/bringup-run-log.md` (run matrix + measured ceilings) | `refs/topics/17-reading-profiler-traces.md` → `### Practical checklist` + `### Experiments to run`<br>`refs/topics/18-bandwidth-accounting.md` → `### Practical checklist` + `### Experiments to run`<br>`refs/topics/16-roofline-model.md` (perf regime framing) |
| **Flags / rollout** | Which flags must be env-parity-checked? Which flags can change call-count/collectives? | `scope-drd/notes/FA4/h200/tp/v1.1-generator-only-workers.md` → `## Proposed flags / rollout`<br>`scope-drd/notes/FA4/h200/tp/explainers/07-v0-contract.md` (parity principle)<br>`scope-drd/notes/FA4/h200/tp/5pro/10-v11-correctness-deadlock-audit/response.md` (FM-03) | `refs/topics/02-deadlock-patterns.md` → `### Key concepts` (env parity → call-order)<br>`refs/topics/20-message-framing-versioning.md` → `### Key concepts` (version fields) |
| **Implementation touchpoints** | Where are the high-risk code edges (override lifetime, in-block broadcasts, cache reset decisions)? | `scope-drd/notes/FA4/h200/tp/v1.1-generator-only-workers.md` → `## Implementation touchpoints (what changes where)`<br>`scope-drd/notes/FA4/h200/tp/5pro/10-v11-correctness-deadlock-audit/response.md` → `## Failure-mode audit` (FM list as audit checklist) | `refs/topics/22-kv-cache-management.md` → “Stale override reuse hazards” + failure table<br>`refs/topics/20-message-framing-versioning.md` → “Last-resort rule (anti-stranding)”<br>`refs/topics/02-deadlock-patterns.md` → `### Gotchas and failure modes` |

## Minimal break-it tests to standardize (shared across v1.1 + PP)

If we only standardize a few intentional failures, make them these:

1) **Anti-stranding test**: force meta serialization failure (`pickle.dumps`/stable JSON) and verify the sender fails *before* sending an `INFER` header (peer does not block).  
   Topics: `refs/topics/20-message-framing-versioning.md`, `refs/topics/02-deadlock-patterns.md`

2) **Call-count mismatch**: force `expected_generator_calls ± 1` and verify fail-fast before hanging.  
   Topics: `refs/topics/02-deadlock-patterns.md`, `refs/topics/22-kv-cache-management.md`

3) **Per-rank flag mismatch**: gate a collective behind a flag not env-parity-checked and observe hang; then add parity check and confirm deterministic behavior.  
   Topics: `refs/topics/02-deadlock-patterns.md`, `refs/topics/04-determinism-across-ranks.md`

4) **Stale-epoch result** (PP): delay a result across a hard cut and verify it is dropped by `cache_epoch` mismatch.  
   Topics: `refs/topics/21-idempotency-and-replay.md`, `refs/topics/19-producer-consumer-backpressure.md`

## v1.1-specific P0 checklist (from Deep Research reply)

If you’re implementing/reviewing `tp_plan=v1_generator_only`, skim this list before touching code. Source: `deep-research/2026-02-22/tp-v11-envelope-contract/reply.md` (P0 blockers + schema v1).

- **Plan explicitness**: `tp_plan` + `tp_envelope_version` are mandatory; never infer behavior from tensor presence.
- **Strict schema**: missing required field/tensor is a fatal error before broadcast (rank0) or before generator entry (worker); no best-effort fallbacks in v1.
- **Preflight-before-header**: picklability + dtype map + deterministic `tensor_specs` ordering + tensor materialization must complete before `INFER` header broadcast.
- **No ad-hoc broadcasts**: all cross-rank tensors must go through `tensor_specs` (no worker-side shape inference).
- **Call-count plan**: `tp_do_kv_recompute`, `tp_num_denoise_steps`, `tp_expected_generator_calls` + reset bits are mandatory and must be asserted on both sides.
- **Warmup is plan-aware**: warmup must not call the full pipeline on generator-only workers.

Worked example / schema snapshot: `refs/topics/20-message-framing-versioning.md` (Worked example section).

## Optional tripwire (from KV lifecycle deep-research reply)

- **KV lifecycle digest (scalars) all_gather every N chunks**: hash only the scalar lifecycle fields (`cache_epoch`, `current_start_frame`, `do_kv_recompute`, `num_denoise_steps`, `kv_cache_attention_bias`) plus a couple representative cache index values (`global_end_index`/`local_end_index` from one layer), and all_gather every 64–128 chunks. Cheap, and it catches the class of bugs where execution stays lockstep but cache state silently diverges.
  Topics: `refs/topics/22-kv-cache-management.md`, `refs/topics/04-determinism-across-ranks.md`

## TODOs (to make this crosswalk “complete”)

- Review/standardize `refs/topics/22-kv-cache-management.md` as a true operator manual (contract + tripwires + break-it tests + instrumentation), and keep it aligned with v1.1/PP field names.
- Standardize `refs/topics/04-determinism-across-ranks.md` to the operator-manual template (contract + tripwires + break-it tests + instrumentation).
- Convert + condense canonical basics so operator topics can cite them:
  - `sources/pytorch-distributed-api/raw/page.html` → Tier 2/3
  - `sources/cuda-async-execution/raw/page.html` → Tier 2/3
