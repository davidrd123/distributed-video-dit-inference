{"url":"https://api.github.com/repos/pytorch/pytorch/issues/93173","repository_url":"https://api.github.com/repos/pytorch/pytorch","labels_url":"https://api.github.com/repos/pytorch/pytorch/issues/93173/labels{/name}","comments_url":"https://api.github.com/repos/pytorch/pytorch/issues/93173/comments","events_url":"https://api.github.com/repos/pytorch/pytorch/issues/93173/events","html_url":"https://github.com/pytorch/pytorch/issues/93173","id":1560438891,"node_id":"I_kwDOA-j9z85dAmhr","number":93173,"title":"[RFC] PT2-Friendly Traceable, Functional Collective Communication APIs","user":{"login":"wconstab","id":4984825,"node_id":"MDQ6VXNlcjQ5ODQ4MjU=","avatar_url":"https://avatars.githubusercontent.com/u/4984825?v=4","gravatar_id":"","url":"https://api.github.com/users/wconstab","html_url":"https://github.com/wconstab","followers_url":"https://api.github.com/users/wconstab/followers","following_url":"https://api.github.com/users/wconstab/following{/other_user}","gists_url":"https://api.github.com/users/wconstab/gists{/gist_id}","starred_url":"https://api.github.com/users/wconstab/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wconstab/subscriptions","organizations_url":"https://api.github.com/users/wconstab/orgs","repos_url":"https://api.github.com/users/wconstab/repos","events_url":"https://api.github.com/users/wconstab/events{/privacy}","received_events_url":"https://api.github.com/users/wconstab/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":679953883,"node_id":"MDU6TGFiZWw2Nzk5NTM4ODM=","url":"https://api.github.com/repos/pytorch/pytorch/labels/oncall:%20distributed","name":"oncall: distributed","color":"f7e101","default":false,"description":"Add this issue/PR to distributed oncall triage queue"},{"id":1076922351,"node_id":"MDU6TGFiZWwxMDc2OTIyMzUx","url":"https://api.github.com/repos/pytorch/pytorch/labels/feature","name":"feature","color":"ffceba","default":false,"description":"A request for a proper, new feature."},{"id":1301347167,"node_id":"MDU6TGFiZWwxMzAxMzQ3MTY3","url":"https://api.github.com/repos/pytorch/pytorch/labels/triaged","name":"triaged","color":"006b75","default":false,"description":"This issue has been looked at a team member, and triaged and prioritized into an appropriate module"},{"id":4291178647,"node_id":"LA_kwDOA-j9z87_xjCX","url":"https://api.github.com/repos/pytorch/pytorch/labels/oncall:%20pt2","name":"oncall: pt2","color":"6385A2","default":false,"description":""},{"id":4347564645,"node_id":"LA_kwDOA-j9z88AAAABAyKSZQ","url":"https://api.github.com/repos/pytorch/pytorch/labels/module:%20ProxyTensor","name":"module: ProxyTensor","color":"306932","default":false,"description":"make_fx and related"},{"id":6265881698,"node_id":"LA_kwDOA-j9z88AAAABdXnEYg","url":"https://api.github.com/repos/pytorch/pytorch/labels/module:%20pt2-dispatcher","name":"module: pt2-dispatcher","color":"d4c5f9","default":false,"description":"PT2  dispatcher-related issues (e.g., aotdispatch, functionalization, faketensor, custom-op,"},{"id":8918020410,"node_id":"LA_kwDOA-j9z88AAAACE44xOg","url":"https://api.github.com/repos/pytorch/pytorch/labels/no-scrub","name":"no-scrub","color":"1089cf","default":false,"description":"Exclude from \"scrubbing\" exercises, e.g., for fundamental issues that donâ€™t need periodic check-in."}],"state":"closed","locked":false,"assignee":{"login":"wconstab","id":4984825,"node_id":"MDQ6VXNlcjQ5ODQ4MjU=","avatar_url":"https://avatars.githubusercontent.com/u/4984825?v=4","gravatar_id":"","url":"https://api.github.com/users/wconstab","html_url":"https://github.com/wconstab","followers_url":"https://api.github.com/users/wconstab/followers","following_url":"https://api.github.com/users/wconstab/following{/other_user}","gists_url":"https://api.github.com/users/wconstab/gists{/gist_id}","starred_url":"https://api.github.com/users/wconstab/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wconstab/subscriptions","organizations_url":"https://api.github.com/users/wconstab/orgs","repos_url":"https://api.github.com/users/wconstab/repos","events_url":"https://api.github.com/users/wconstab/events{/privacy}","received_events_url":"https://api.github.com/users/wconstab/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"wconstab","id":4984825,"node_id":"MDQ6VXNlcjQ5ODQ4MjU=","avatar_url":"https://avatars.githubusercontent.com/u/4984825?v=4","gravatar_id":"","url":"https://api.github.com/users/wconstab","html_url":"https://github.com/wconstab","followers_url":"https://api.github.com/users/wconstab/followers","following_url":"https://api.github.com/users/wconstab/following{/other_user}","gists_url":"https://api.github.com/users/wconstab/gists{/gist_id}","starred_url":"https://api.github.com/users/wconstab/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wconstab/subscriptions","organizations_url":"https://api.github.com/users/wconstab/orgs","repos_url":"https://api.github.com/users/wconstab/repos","events_url":"https://api.github.com/users/wconstab/events{/privacy}","received_events_url":"https://api.github.com/users/wconstab/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":44,"created_at":"2023-01-27T21:12:12Z","updated_at":"2025-07-12T17:56:43Z","closed_at":"2025-07-12T17:56:43Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### ðŸš€ Traceable Collectives!\r\n\r\nCollective APIs (e.g. all_reduce, all_gather, ...) are used in distributed PyTorch programs, but do not compose cleanly with compilers.  \r\n\r\nSpecifically, torchDynamo and the AotAutograd pipeline for decompositions and functionalization do not work with the existing c10d collective APIs\r\n* there are not functional variants of these collectives\r\n* ProcessGroup and Work objects interfere with graph tracing and pollute the IR with non-tensor objects\r\n\r\nXLA also currently has to implement some workarounds, to marry the XLA collective ops via lazy tensor tracing with the existing PyTorch / C10D side. They have to use a custom ProcessGroup implementation and swizzle PTD PG creation functions. \r\n\r\n**Goals**\r\n1) provide collectives that are **traceable** with the PT2 stack and XLA stack\r\n2) provide **functional** collectives, which are easier for IR transformations to reason about\r\n3) support **eager and compiled** flows with the same API\r\n4) use **plain data types** in the traced API\r\n5) allow tracing/compilation **without requiring process group init**\r\n6) **support different frontends** (DTensors, ProcessGroups, etc)\r\n7) support **autograd** for collective ops\r\n8) clean up c10d python bindings and dispatcher registrations\r\n\r\n**Non-goals**\r\n\r\n1) Introduce multiple stream semantics in inductor\r\n\r\n<img width=\"1530\" alt=\"image\" src=\"https://user-images.githubusercontent.com/4984825/216402330-b78e08ff-7d51-407b-aaee-f06aca9b60ec.png\">\r\n\r\n\r\n### New traceable collectives python API\r\n```\r\ndef collective(input:Tensor, *, group: GROUP_TYPE) -> AsyncTensor\r\n```\r\n`GROUP_TYPE` is a Union over List<rank>, DeviceMesh, ProcessGroup, etc.  It allows flexible usage by different frontends.\r\n\r\n`AsyncTensor` is a Tensor subclass that calls `wait()` automatically when the tensor is used by another op.\r\n\r\n### New Dispatcher Collectives\r\n\r\n```\r\naten::collective(Tensor, *, str tag, int[] ranks, int stride) -> Tensor`\r\n```\r\nThese are the ops that actually get traced into a graph and can be manipulated by compiler passes.\r\n\r\nThe collective ops are functional, but compilers may be able to convert them to inplace.  They are asynchronous.\r\n\r\nThese ops support meta device (for traceability), and support backwards via derivatives.yaml.\r\n\r\nThe semantics of these ops are that they return a real tensor, but you aren't allowed to access its data or storage.\r\n\r\n```\r\nc10d.wait(Tensor) -> Tensor\r\n```\r\n\r\n`wait()` must be called on the output of any collective before its underlying data or storage is accessed.\r\n* It is valid to peek at the size() or stride() (or probably other metadata) of a tensor returned from a collective, but not its data.  \r\n* wait() is the only way to make an output from collectives safe to use by other non collective ops\r\n* we are considering whether wait(collective(collective)) can be implemented safely, but by default we assume it is not\r\nThe semantics of wait are that you must only access the storage of the tensor returned from wait.  You can't think of wait as mutating its input tensor and making it safe to use.\r\n\r\n\r\n### Alternatives\r\n\r\nThe following style of API has also been considered.  Its main disadvantage is in requiring a user to first initialize a processgroup, but it is also opaque and not easily interchangeable with lists of ranks or DTensors. It doesn't allow us to easily represent MPMD collectives.\r\n\r\n```\r\npg = init_process_group()\r\npg_id = dist.register_process_group(pg)\r\ncollective(tensor, pg_id)\r\n```\r\n\r\n### Detailed Proposal\r\nSee [Traceable Collectives Design](https://docs.google.com/document/d/1Jqa68gvuVeFWZJFOiukmb58jAaUEET1GVMkd1GOMRT4/edit)\r\n\r\ncc @H-Huang @awgu @wanchaol @fegin @fduwjj @wz337 @d4l3k @chauhang @penguinwu @zou3519 @bdhirsh @mrshenli @pritamdamania87 @zhaojuanmao @satgera @rohan-varma @gqchen @aazzolini @osalpekar @jiayisuse @kwen2501 @XilunWu @ezyang @msaroufim @anijain2305 @soumith @ngimel","closed_by":{"login":"ezyang","id":13564,"node_id":"MDQ6VXNlcjEzNTY0","avatar_url":"https://avatars.githubusercontent.com/u/13564?v=4","gravatar_id":"","url":"https://api.github.com/users/ezyang","html_url":"https://github.com/ezyang","followers_url":"https://api.github.com/users/ezyang/followers","following_url":"https://api.github.com/users/ezyang/following{/other_user}","gists_url":"https://api.github.com/users/ezyang/gists{/gist_id}","starred_url":"https://api.github.com/users/ezyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ezyang/subscriptions","organizations_url":"https://api.github.com/users/ezyang/orgs","repos_url":"https://api.github.com/users/ezyang/repos","events_url":"https://api.github.com/users/ezyang/events{/privacy}","received_events_url":"https://api.github.com/users/ezyang/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pytorch/pytorch/issues/93173/reactions","total_count":37,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":19,"rocket":18,"eyes":0},"timeline_url":"https://api.github.com/repos/pytorch/pytorch/issues/93173/timeline","performed_via_github_app":null,"state_reason":"completed","pinned_comment":null}