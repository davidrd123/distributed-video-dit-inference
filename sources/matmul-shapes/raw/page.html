<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="norton-safeweb-site-verification" content="24usqpep0ejc5w6hod3dulxwciwp0djs6c6ufp96av3t4whuxovj72wfkdjxu82yacb7430qjm8adbd5ezlt4592dq4zrvadcn9j9n-0btgdzpiojfzno16-fnsnu7xd" />
        
        <link rel="preconnect" href="https://substackcdn.com" />
        

        
            <title data-rh="true">What Shapes Do Matrix Multiplications Like? [medium]</title>
            
            <meta data-rh="true" property="og:type" content="article"/><meta data-rh="true" property="og:title" content="What Shapes Do Matrix Multiplications Like? [medium]"/><meta data-rh="true" name="twitter:title" content="What Shapes Do Matrix Multiplications Like? [medium]"/><meta data-rh="true" name="description" content="Divining order from the chaos"/><meta data-rh="true" property="og:description" content="Divining order from the chaos"/><meta data-rh="true" name="twitter:description" content="Divining order from the chaos"/><meta data-rh="true" property="og:image" content="https://substackcdn.com/image/fetch/$s_!v5MG!,w_1200,h_675,c_fill,f_jpg,q_auto:good,fl_progressive:steep,g_auto/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png"/><meta data-rh="true" name="twitter:image" content="https://substackcdn.com/image/fetch/$s_!mgOo!,f_auto,q_auto:best,fl_progressive:steep/https%3A%2F%2Fthonking.substack.com%2Fapi%2Fv1%2Fpost_preview%2F142904770%2Ftwitter.jpg%3Fversion%3D4"/><meta data-rh="true" name="twitter:card" content="summary_large_image"/>
            
            
        

        

        <style>
          @layer legacy, tailwind, pencraftReset, pencraft;
        </style>

        
        <link rel="preload" as="style" href="https://substackcdn.com/bundle/theme/main.f0433fcbd2cdb51bad6f.css" />
        
        <link rel="preload" as="style" href="https://substackcdn.com/bundle/theme/color_links.c9908948e2f4e05476e6.css" />
        
        
        
        <link rel="preload" as="font" href="https://fonts.gstatic.com/s/spectral/v13/rnCr-xNNww_2s0amA9M5knjsS_ul.woff2" crossorigin />
        

        
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/382.22b8627a.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/56938.770097cf.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/39810.ae815702.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/88577.8a8242a0.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/56417.6677b2d7.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/26973.549a6383.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/45636.72254d29.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/96998.600b6fbf.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/28178.c20845bc.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/98651.82477242.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/31608.6ac03138.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/main.aba729d8.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/98651.82477242.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/28178.c20845bc.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/96998.600b6fbf.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/45636.72254d29.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/26973.549a6383.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/56417.6677b2d7.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/88577.8a8242a0.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/39810.ae815702.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/86379.813be60f.css" />
            
                <link rel="stylesheet" type="text/css" href="https://substackcdn.com/bundle/static/css/31608.6ac03138.css" />
            
        

        
        
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
        <meta name="author" content="Horace He" />
        <meta property="og:url" content="https://www.thonking.ai/p/what-shapes-do-matrix-multiplications" />
        
        
        <link rel="canonical" href="https://www.thonking.ai/p/what-shapes-do-matrix-multiplications" />
        

        

        

        

        
            
                <link rel="shortcut icon" href="https://substackcdn.com/image/fetch/$s_!XG94!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75186acd-1170-44e9-bc64-8cada907c5fa%2Ffavicon.ico">
            
        
            
                <link rel="icon" type="image/png" sizes="16x16" href="https://substackcdn.com/image/fetch/$s_!6HO8!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75186acd-1170-44e9-bc64-8cada907c5fa%2Ffavicon-16x16.png">
            
        
            
                <link rel="icon" type="image/png" sizes="32x32" href="https://substackcdn.com/image/fetch/$s_!YNIn!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75186acd-1170-44e9-bc64-8cada907c5fa%2Ffavicon-32x32.png">
            
        
            
                <link rel="icon" type="image/png" sizes="48x48" href="https://substackcdn.com/image/fetch/$s_!vLUd!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75186acd-1170-44e9-bc64-8cada907c5fa%2Ffavicon-48x48.png">
            
        
            
                <link rel="apple-touch-icon" sizes="57x57" href="https://substackcdn.com/image/fetch/$s_!Ftuq!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75186acd-1170-44e9-bc64-8cada907c5fa%2Fapple-touch-icon-57x57.png">
            
        
            
                <link rel="apple-touch-icon" sizes="60x60" href="https://substackcdn.com/image/fetch/$s_!UHof!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75186acd-1170-44e9-bc64-8cada907c5fa%2Fapple-touch-icon-60x60.png">
            
        
            
                <link rel="apple-touch-icon" sizes="72x72" href="https://substackcdn.com/image/fetch/$s_!leJH!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75186acd-1170-44e9-bc64-8cada907c5fa%2Fapple-touch-icon-72x72.png">
            
        
            
                <link rel="apple-touch-icon" sizes="76x76" href="https://substackcdn.com/image/fetch/$s_!Csri!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75186acd-1170-44e9-bc64-8cada907c5fa%2Fapple-touch-icon-76x76.png">
            
        
            
                <link rel="apple-touch-icon" sizes="114x114" href="https://substackcdn.com/image/fetch/$s_!HPLZ!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75186acd-1170-44e9-bc64-8cada907c5fa%2Fapple-touch-icon-114x114.png">
            
        
            
                <link rel="apple-touch-icon" sizes="120x120" href="https://substackcdn.com/image/fetch/$s_!bDDV!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75186acd-1170-44e9-bc64-8cada907c5fa%2Fapple-touch-icon-120x120.png">
            
        
            
                <link rel="apple-touch-icon" sizes="144x144" href="https://substackcdn.com/image/fetch/$s_!On3G!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75186acd-1170-44e9-bc64-8cada907c5fa%2Fapple-touch-icon-144x144.png">
            
        
            
                <link rel="apple-touch-icon" sizes="152x152" href="https://substackcdn.com/image/fetch/$s_!CUY-!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75186acd-1170-44e9-bc64-8cada907c5fa%2Fapple-touch-icon-152x152.png">
            
        
            
                <link rel="apple-touch-icon" sizes="167x167" href="https://substackcdn.com/image/fetch/$s_!HKb3!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75186acd-1170-44e9-bc64-8cada907c5fa%2Fapple-touch-icon-167x167.png">
            
        
            
                <link rel="apple-touch-icon" sizes="180x180" href="https://substackcdn.com/image/fetch/$s_!oRQ3!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75186acd-1170-44e9-bc64-8cada907c5fa%2Fapple-touch-icon-180x180.png">
            
        
            
                <link rel="apple-touch-icon" sizes="1024x1024" href="https://substackcdn.com/image/fetch/$s_!olEm!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F75186acd-1170-44e9-bc64-8cada907c5fa%2Fapple-touch-icon-1024x1024.png">
            
        
            
        
            
        
            
        

        

        
            <link rel="alternate" type="application/rss+xml" href="/feed" title="Thonk From First Principles"/>
        

        
        
          <style>
            @font-face{font-family:'Spectral';font-style:italic;font-weight:400;font-display:fallback;src:url(https://fonts.gstatic.com/s/spectral/v13/rnCt-xNNww_2s0amA9M8on7mTNmnUHowCw.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Spectral';font-style:italic;font-weight:400;font-display:fallback;src:url(https://fonts.gstatic.com/s/spectral/v13/rnCt-xNNww_2s0amA9M8onXmTNmnUHowCw.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Spectral';font-style:italic;font-weight:400;font-display:fallback;src:url(https://fonts.gstatic.com/s/spectral/v13/rnCt-xNNww_2s0amA9M8onTmTNmnUHowCw.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Spectral';font-style:italic;font-weight:400;font-display:fallback;src:url(https://fonts.gstatic.com/s/spectral/v13/rnCt-xNNww_2s0amA9M8onrmTNmnUHo.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Spectral';font-style:normal;font-weight:400;font-display:fallback;src:url(https://fonts.gstatic.com/s/spectral/v13/rnCr-xNNww_2s0amA9M9knjsS_ulYHs.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Spectral';font-style:normal;font-weight:400;font-display:fallback;src:url(https://fonts.gstatic.com/s/spectral/v13/rnCr-xNNww_2s0amA9M2knjsS_ulYHs.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Spectral';font-style:normal;font-weight:400;font-display:fallback;src:url(https://fonts.gstatic.com/s/spectral/v13/rnCr-xNNww_2s0amA9M3knjsS_ulYHs.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Spectral';font-style:normal;font-weight:400;font-display:fallback;src:url(https://fonts.gstatic.com/s/spectral/v13/rnCr-xNNww_2s0amA9M5knjsS_ul.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Spectral';font-style:normal;font-weight:600;font-display:fallback;src:url(https://fonts.gstatic.com/s/spectral/v13/rnCs-xNNww_2s0amA9vmtm3FafaPWnIIMrY.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Spectral';font-style:normal;font-weight:600;font-display:fallback;src:url(https://fonts.gstatic.com/s/spectral/v13/rnCs-xNNww_2s0amA9vmtm3OafaPWnIIMrY.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Spectral';font-style:normal;font-weight:600;font-display:fallback;src:url(https://fonts.gstatic.com/s/spectral/v13/rnCs-xNNww_2s0amA9vmtm3PafaPWnIIMrY.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Spectral';font-style:normal;font-weight:600;font-display:fallback;src:url(https://fonts.gstatic.com/s/spectral/v13/rnCs-xNNww_2s0amA9vmtm3BafaPWnII.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}
            
          </style>
        
        

        <style>:root{--color_theme_bg_pop:#99A2F1;--background_pop:#99A2F1;--cover_bg_color:#FFFFFF;--cover_bg_color_secondary:#f0f0f0;--background_pop_darken:#838eee;--print_on_pop:#ffffff;--color_theme_bg_pop_darken:#838eee;--color_theme_print_on_pop:#ffffff;--color_theme_bg_pop_20:rgba(153, 162, 241, 0.2);--color_theme_bg_pop_30:rgba(153, 162, 241, 0.3);--print_pop:#99a2f1;--color_theme_accent:#99a2f1;--cover_print_primary:#363737;--cover_print_secondary:#757575;--cover_print_tertiary:#b6b6b6;--cover_border_color:#99a2f1;--home_hero:newspaper;--home_posts:list;--background_contrast_1:#f0f0f0;--background_contrast_2:#dddddd;--background_contrast_3:#b7b7b7;--background_contrast_4:#929292;--background_contrast_5:#515151;--color_theme_detail:#e6e6e6;--background_contrast_pop:rgba(153, 162, 241, 0.4);--color_theme_bg_contrast_pop:rgba(153, 162, 241, 0.4);--theme_bg_is_dark:0;--background_pop_rgb:153, 162, 241;--color_theme_bg_pop_rgb:153, 162, 241;--color_theme_accent_rgb:153, 162, 241;}</style>

        
            <link rel="stylesheet" href="https://substackcdn.com/bundle/theme/main.f0433fcbd2cdb51bad6f.css" />
        
            <link rel="stylesheet" href="https://substackcdn.com/bundle/theme/color_links.c9908948e2f4e05476e6.css" />
        

        <style></style>

        

        

        

        
    </head>

    <body class="">
        

        

        

        

        <div id="entry">
            <div id="main" class="main typography use-theme-bg"><div class="pencraft pc-display-contents pc-reset pubTheme-yiXxQA"><div data-testid="navbar" class="main-menu"><div class="mainMenuContent-DME8DR"><div style="position:relative;height:71px;" class="pencraft pc-display-flex pc-gap-12 pc-paddingLeft-20 pc-paddingRight-20 pc-justifyContent-space-between pc-alignItems-center pc-reset border-bottom-detail-k1F6C4 topBar-pIF0J1"><div style="flex-basis:0px;flex-grow:1;" class="logoContainer-p12gJb"><a href="/" native class="pencraft pc-display-contents pc-reset"><div draggable="false" class="pencraft pc-display-flex pc-position-relative pc-reset"><div style="width:40px;height:40px;" class="pencraft pc-display-flex pc-reset bg-white-ZBV5av pc-borderRadius-sm overflow-hidden-WdpwT6 sizing-border-box-DggLA4"><picture class="pencraft pc-display-contents pc-reset"><source type="image/webp" sizes="40px" srcset="https://substackcdn.com/image/fetch/$s_!WNJs!,w_40,h_40,c_fill,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55e3b22f-cc6b-438a-be3d-8d17cc97c2f9_750x750.png 40w, https://substackcdn.com/image/fetch/$s_!WNJs!,w_80,h_80,c_fill,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55e3b22f-cc6b-438a-be3d-8d17cc97c2f9_750x750.png 80w, https://substackcdn.com/image/fetch/$s_!WNJs!,w_120,h_120,c_fill,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55e3b22f-cc6b-438a-be3d-8d17cc97c2f9_750x750.png 120w" style="display:none;"/><img style="object-fit:cover;width:40px;height:40px;" src="https://substackcdn.com/image/fetch/$s_!WNJs!,w_40,h_40,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55e3b22f-cc6b-438a-be3d-8d17cc97c2f9_750x750.png" srcset="https://substackcdn.com/image/fetch/$s_!WNJs!,w_40,h_40,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55e3b22f-cc6b-438a-be3d-8d17cc97c2f9_750x750.png 40w, https://substackcdn.com/image/fetch/$s_!WNJs!,w_80,h_80,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55e3b22f-cc6b-438a-be3d-8d17cc97c2f9_750x750.png 80w, https://substackcdn.com/image/fetch/$s_!WNJs!,w_120,h_120,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55e3b22f-cc6b-438a-be3d-8d17cc97c2f9_750x750.png 120w" sizes="40px" alt="Thonk From First Principles" draggable="false" class="pencraft pc-reset"/></picture></div></div></a></div><div style="flex-grow:0;" class="titleContainer-DJYq5v"><h1 class="pencraft pc-reset font-pub-headings-FE5byy reset-IxiVJZ title-oOnUGd"><a href="/" class="pencraft pc-display-contents pc-reset">Thonk From First Principles</a></h1></div><div style="flex-basis:0px;flex-grow:1;" class="pencraft pc-display-flex pc-justifyContent-flex-end pc-alignItems-center pc-reset"><div class="buttonsContainer-SJBuep"><div class="pencraft pc-display-flex pc-gap-8 pc-justifyContent-flex-end pc-alignItems-center pc-reset navbar-buttons"><div class="pencraft pc-display-flex pc-gap-4 pc-reset"><span data-state="closed"><button tabindex="0" type="button" aria-label="Search" class="pencraft pc-reset pencraft iconButton-mq_Et5 iconButtonBase-dJGHgN buttonBase-GK1x3M buttonStyle-r7yGCK size_md-gCDS3o priority_tertiary-rlke8z"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg></button></span><button tabindex="0" type="button" aria-label="Share Publication" id="radix-P0-4" aria-haspopup="menu" aria-expanded="false" data-state="closed" class="pencraft pc-reset pencraft iconButton-mq_Et5 iconButtonBase-dJGHgN buttonBase-GK1x3M buttonStyle-r7yGCK size_md-gCDS3o priority_tertiary-rlke8z"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-share"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" x2="12" y1="2" y2="15"></line></svg></button></div><button tabindex="0" type="button" data-testid="noncontributor-cta-button" class="pencraft pc-reset pencraft buttonBase-GK1x3M buttonText-X0uSmG buttonStyle-r7yGCK priority_primary-RfbeYt size_md-gCDS3o">Subscribe</button><button tabindex="0" data-native="true" type="button" data-href="https://substack.com/sign-in?redirect=%2Fp%2Fwhat-shapes-do-matrix-multiplications&amp;for_pub=thonking" class="pencraft pc-reset pencraft buttonBase-GK1x3M buttonText-X0uSmG buttonStyle-r7yGCK priority_tertiary-rlke8z size_md-gCDS3o">Sign in</button></div></div></div></div></div><div style="height:72px;"></div></div></div><div><script type="application/ld+json">{"@context":"https://schema.org","@type":"NewsArticle","url":"https://www.thonking.ai/p/what-shapes-do-matrix-multiplications","mainEntityOfPage":"https://www.thonking.ai/p/what-shapes-do-matrix-multiplications","headline":"What Shapes Do Matrix Multiplications Like? [medium]","description":"Divining order from the chaos","image":[{"@type":"ImageObject","url":"https://substackcdn.com/image/fetch/$s_!v5MG!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png"}],"datePublished":"2024-04-01T16:01:30+00:00","dateModified":"2024-04-01T16:01:30+00:00","isAccessibleForFree":true,"author":[{"@type":"Person","name":"Horace He","url":"https://substack.com/@chilli","description":null,"identifier":"user:1514868","image":{"@type":"ImageObject","contentUrl":"https://substackcdn.com/image/fetch/$s_!acf6!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc8ac060-6949-4a91-b6b5-88460efd08bc_144x144.png","thumbnailUrl":"https://substackcdn.com/image/fetch/$s_!acf6!,w_128,h_128,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc8ac060-6949-4a91-b6b5-88460efd08bc_144x144.png"}}],"publisher":{"@type":"Organization","name":"Thonk From First Principles","url":"https://www.thonking.ai","description":"ML Systems from first principles. Aims to be better than a ChatGPT summary.","interactionStatistic":{"@type":"InteractionCounter","name":"Subscribers","interactionType":"https://schema.org/SubscribeAction","userInteractionCount":1000},"identifier":"pub:1781836","logo":{"@type":"ImageObject","url":"https://substackcdn.com/image/fetch/$s_!WNJs!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55e3b22f-cc6b-438a-be3d-8d17cc97c2f9_750x750.png","contentUrl":"https://substackcdn.com/image/fetch/$s_!WNJs!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55e3b22f-cc6b-438a-be3d-8d17cc97c2f9_750x750.png","thumbnailUrl":"https://substackcdn.com/image/fetch/$s_!WNJs!,w_128,h_128,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55e3b22f-cc6b-438a-be3d-8d17cc97c2f9_750x750.png"},"image":{"@type":"ImageObject","url":"https://substackcdn.com/image/fetch/$s_!WNJs!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55e3b22f-cc6b-438a-be3d-8d17cc97c2f9_750x750.png","contentUrl":"https://substackcdn.com/image/fetch/$s_!WNJs!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55e3b22f-cc6b-438a-be3d-8d17cc97c2f9_750x750.png","thumbnailUrl":"https://substackcdn.com/image/fetch/$s_!WNJs!,w_128,h_128,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55e3b22f-cc6b-438a-be3d-8d17cc97c2f9_750x750.png"}},"interactionStatistic":[{"@type":"InteractionCounter","interactionType":"https://schema.org/LikeAction","userInteractionCount":91},{"@type":"InteractionCounter","interactionType":"https://schema.org/ShareAction","userInteractionCount":3},{"@type":"InteractionCounter","interactionType":"https://schema.org/CommentAction","userInteractionCount":2}]}</script><div aria-label="Post" role="main" class="single-post-container"><div class="container"><div class="single-post"><div class="pencraft pc-display-contents pc-reset pubTheme-yiXxQA"><article class="typography newsletter-post post"><div role="region" aria-label="Post header" class="post-header"><h1 dir="auto" class="post-title published title-X77sOw">What Shapes Do Matrix Multiplications Like? [medium]</h1><h3 dir="auto" class="subtitle subtitle-HEEcLo">Divining order from the chaos</h3><div aria-label="Post UFI" role="region" class="pencraft pc-display-flex pc-flexDirection-column pc-paddingBottom-16 pc-reset"><div class="pencraft pc-display-flex pc-paddingTop-16 pc-paddingBottom-16 pc-justifyContent-space-between pc-alignItems-center pc-reset"><div class="pencraft pc-display-flex pc-gap-12 pc-alignItems-center pc-reset byline-wrapper"><div class="pencraft pc-display-flex pc-reset"><div class="pencraft pc-display-flex pc-flexDirection-row pc-gap-8 pc-alignItems-center pc-justifyContent-flex-start pc-reset"><div style="--scale:36px;--offset:9px;--border-width:4.5px;" class="pencraft pc-display-flex pc-flexDirection-row pc-alignItems-center pc-justifyContent-flex-start pc-reset ltr-qDBmby"><a href="https://substack.com/@chilli" aria-label="View Horace He's profile" class="pencraft pc-display-contents pc-reset"><div style="--scale:36px;" tabindex="0" class="pencraft pc-display-flex pc-width-36 pc-height-36 pc-justifyContent-center pc-alignItems-center pc-position-relative pc-reset bg-secondary-UUD3_J flex-auto-j3S2WA animate-XFJxE4 outline-detail-vcQLyr pc-borderRadius-full overflow-hidden-WdpwT6 sizing-border-box-DggLA4 pressable-sm-YIJFKJ showFocus-sk_vEm container-TAtrWj interactive-UkK0V6 avatar-u8q6xB last-JfNEJ_"><div style="--scale:36px;" title="Horace He" class="pencraft pc-display-flex pc-width-36 pc-height-36 pc-justifyContent-center pc-alignItems-center pc-position-relative pc-reset bg-secondary-UUD3_J flex-auto-j3S2WA outline-detail-vcQLyr pc-borderRadius-full overflow-hidden-WdpwT6 sizing-border-box-DggLA4 container-TAtrWj"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!acf6!,w_36,h_36,c_fill,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc8ac060-6949-4a91-b6b5-88460efd08bc_144x144.png 36w, https://substackcdn.com/image/fetch/$s_!acf6!,w_72,h_72,c_fill,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc8ac060-6949-4a91-b6b5-88460efd08bc_144x144.png 72w, https://substackcdn.com/image/fetch/$s_!acf6!,w_108,h_108,c_fill,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc8ac060-6949-4a91-b6b5-88460efd08bc_144x144.png 108w" sizes="36px"/><img src="https://substackcdn.com/image/fetch/$s_!acf6!,w_36,h_36,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc8ac060-6949-4a91-b6b5-88460efd08bc_144x144.png" sizes="36px" alt="Horace He's avatar" srcset="https://substackcdn.com/image/fetch/$s_!acf6!,w_36,h_36,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc8ac060-6949-4a91-b6b5-88460efd08bc_144x144.png 36w, https://substackcdn.com/image/fetch/$s_!acf6!,w_72,h_72,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc8ac060-6949-4a91-b6b5-88460efd08bc_144x144.png 72w, https://substackcdn.com/image/fetch/$s_!acf6!,w_108,h_108,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc8ac060-6949-4a91-b6b5-88460efd08bc_144x144.png 108w" width="36" height="36" draggable="false" class="img-OACg1c object-fit-cover-u4ReeV pencraft pc-reset"/></picture></div></div></a></div></div></div><div class="pencraft pc-display-flex pc-flexDirection-column pc-reset"><div class="pencraft pc-reset color-pub-primary-text-NyXPlw line-height-20-t4M0El font-meta-MWBumP size-11-NuY2Zx weight-medium-fw81nC transform-uppercase-yKDgcq reset-IxiVJZ meta-EgzBVA"><span style="min-width:0;" data-state="closed"><a href="https://substack.com/@chilli" class="pencraft pc-reset decoration-hover-underline-ClDVRM reset-IxiVJZ">Horace He</a></span></div><div class="pencraft pc-display-flex pc-gap-4 pc-reset"><div class="pencraft pc-reset color-pub-secondary-text-hGQ02T line-height-20-t4M0El font-meta-MWBumP size-11-NuY2Zx weight-medium-fw81nC transform-uppercase-yKDgcq reset-IxiVJZ meta-EgzBVA">Apr 01, 2024</div></div></div></div></div><div class="pencraft pc-display-flex pc-gap-16 pc-paddingTop-16 pc-paddingBottom-16 pc-justifyContent-space-between pc-alignItems-center pc-reset flex-grow-rzmknG border-top-detail-themed-k9TZAY border-bottom-detail-themed-Ua9186 post-ufi"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><div class="like-button-container post-ufi-button style-button"><button tabindex="0" type="button" aria-label="Like (91)" aria-pressed="false" class="pencraft pc-reset pencraft post-ufi-button style-button has-label with-border"><svg role="img" style="height:20px;width:20px;" width="20" height="20" viewBox="0 0 24 24" fill="#000000" stroke-width="2" stroke="#000" xmlns="http://www.w3.org/2000/svg" class="icon"><g><title></title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path></svg></g></svg><div class="label">91</div></button></div><button tabindex="0" type="button" aria-label="View comments (2)" data-href="https://www.thonking.ai/p/what-shapes-do-matrix-multiplications/comments" class="pencraft pc-reset pencraft post-ufi-button style-button post-ufi-comment-button has-label with-border"><svg role="img" style="height:20px;width:20px;" width="20" height="20" viewBox="0 0 24 24" fill="#000000" stroke-width="2" stroke="#000" xmlns="http://www.w3.org/2000/svg" class="icon"><g><title></title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-circle"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"></path></svg></g></svg><div class="label">2</div></button><button tabindex="0" type="button" id="radix-P0-27" aria-haspopup="menu" aria-expanded="false" data-state="closed" class="pencraft pc-reset pencraft post-ufi-button style-button has-label with-border"><svg role="img" style="height:20px;width:20px;" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke="#000" xmlns="http://www.w3.org/2000/svg" class="icon"><g><title></title><path d="M21 3V8M21 8H16M21 8L18 5.29962C16.7056 4.14183 15.1038 3.38328 13.3879 3.11547C11.6719 2.84766 9.9152 3.08203 8.32951 3.79031C6.74382 4.49858 5.39691 5.65051 4.45125 7.10715C3.5056 8.5638 3.00158 10.2629 3 11.9996M3 21V16M3 16H8M3 16L6 18.7C7.29445 19.8578 8.89623 20.6163 10.6121 20.8841C12.3281 21.152 14.0848 20.9176 15.6705 20.2093C17.2562 19.501 18.6031 18.3491 19.5487 16.8925C20.4944 15.4358 20.9984 13.7367 21 12" stroke-linecap="round" stroke-linejoin="round"></path></g></svg><div class="label">3</div></button></div><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft post-ufi-button style-button has-label with-border"><div class="label">Share</div></button></div></div></div></div><div class="visibility-check"></div><div><div class="available-content"><div dir="auto" class="body markup"><p><span>A while back, Karpathy tweeted that </span><em>increasing</em><span> the size of his matmul made it run faster. Surprisingly, it’s not just </span><em>relatively</em><span> faster, it takes less </span><em>absolute</em><span> time. In other words, despite doing more work, it is executing in less time.</span></p><div class="captioned-image-container"><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!v5MG!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png" data-component-name="Image2ToDOM" rel class="image-link image2 is-viewable-img can-restack"><div class="image2-inset can-restack"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!v5MG!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png 424w, https://substackcdn.com/image/fetch/$s_!v5MG!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png 848w, https://substackcdn.com/image/fetch/$s_!v5MG!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png 1272w, https://substackcdn.com/image/fetch/$s_!v5MG!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!v5MG!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png" width="1204" height="426" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:426,&quot;width&quot;:1204,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:119338,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:false,&quot;topImage&quot;:true,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" alt srcset="https://substackcdn.com/image/fetch/$s_!v5MG!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png 424w, https://substackcdn.com/image/fetch/$s_!v5MG!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png 848w, https://substackcdn.com/image/fetch/$s_!v5MG!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png 1272w, https://substackcdn.com/image/fetch/$s_!v5MG!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png 1456w" sizes="100vw" fetchpriority="high" class="sizing-normal"/></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg role="img" style="height:20px;width:20px" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke-width="1.5" stroke="var(--color-fg-primary)" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882"></path></g></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a><figcaption class="image-caption"><a href="https://twitter.com/karpathy/status/1621578354024677377" rel>https://twitter.com/karpathy/status/1621578354024677377</a></figcaption></figure></div><p>This may seem intuitively quite strange. Is cuBLAS just messing up somehow? Why doesn’t the matrix multiplication kernel just pad it to a larger shape? </p><p>It has become tribal knowledge that the particular shapes chosen for matmuls has a surprisingly large effect on their performance. But … why? Can this be understood by mere mortals?</p><p>Let’s take a crack at it.</p><p>First, let’s plot FLOPs achieved for square matmuls. By the end of this article, I will aim to explain all the strange squiggly lines. </p><div class="captioned-image-container"><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!de3t!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg" data-component-name="Image2ToDOM" rel class="image-link image2 is-viewable-img can-restack"><div class="image2-inset can-restack"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!de3t!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg 424w, https://substackcdn.com/image/fetch/$s_!de3t!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg 848w, https://substackcdn.com/image/fetch/$s_!de3t!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg 1272w, https://substackcdn.com/image/fetch/$s_!de3t!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!de3t!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg" width="1456" height="965" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/da2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:965,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Image&quot;,&quot;title&quot;:&quot;Image&quot;,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:false,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" alt="Image" title="Image" srcset="https://substackcdn.com/image/fetch/$s_!de3t!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg 424w, https://substackcdn.com/image/fetch/$s_!de3t!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg 848w, https://substackcdn.com/image/fetch/$s_!de3t!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg 1272w, https://substackcdn.com/image/fetch/$s_!de3t!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg 1456w" sizes="100vw" class="sizing-normal"/></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg role="img" style="height:20px;width:20px" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke-width="1.5" stroke="var(--color-fg-primary)" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882"></path></g></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a></figure></div><p>There are 3 general concepts to understand that explain the majority of performance variation among matmul shapes.</p><ol><li><p>Compute Intensity/Parallelization: This explains the general upward trend</p></li><li><p>Tiling: This explains the multiple tiers of lines.</p></li><li><p>Wave Quantization: This explains the strange striped lines.</p></li></ol><div class="subscription-widget-wrap"><div class="subscription-widget show-subscribe"><div class="preamble"><p>Thonk From First Principles is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><div data-component-name="SubscribeWidget" class="subscribe-widget"><div class="pencraft pc-display-flex pc-justifyContent-center pc-reset"><div class="container-IpPqBD"><form action="/api/v1/free?nojs=true" method="post" novalidate class="form form-M5sC90"><input type="hidden" name="first_url" value/><input type="hidden" name="first_referrer" value/><input type="hidden" name="current_url"/><input type="hidden" name="current_referrer"/><input type="hidden" name="first_session_url" value/><input type="hidden" name="first_session_referrer" value/><input type="hidden" name="referral_code"/><input type="hidden" name="source" value="subscribe-widget-preamble"/><input type="hidden" name="referring_pub_id"/><input type="hidden" name="additional_referring_pub_ids"/><div class="sideBySideWrap-vGXrwP"><div class="emailInputWrapper-QlA86j"><div class="pencraft pc-display-flex pc-minWidth-0 pc-position-relative pc-reset flex-auto-j3S2WA"><input name="email" placeholder="Type your email..." type="email" class="pencraft emailInput-OkIMeB input-y4v6N4 inputText-pV_yWb"/></div></div><button tabindex="0" type="submit" disabled class="pencraft pc-reset pencraft rightButton primary subscribe-btn button-VFSdkv buttonBase-GK1x3M"><span class="button-text ">Subscribe</span></button></div><div id="error-container"></div></form></div></div></div></div></div><h2 class="header-anchor-post">Compute Intensity and More Parallelism<div class="pencraft pc-display-flex pc-alignItems-center pc-position-absolute pc-reset header-anchor-parent"><div class="pencraft pc-display-contents pc-reset pubTheme-yiXxQA"><div id="§compute-intensity-and-more-parallelism" class="pencraft pc-reset header-anchor offset-top"></div><button tabindex="0" type="button" aria-label="Link" data-href="https://www.thonking.ai/i/142904770/compute-intensity-and-more-parallelism" class="pencraft pc-reset pencraft iconButton-mq_Et5 iconButtonBase-dJGHgN buttonBase-GK1x3M buttonStyle-r7yGCK size_sm-G3LciD priority_secondary-S63h9o"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></button></div></div></h2><p>First of all, as we move along the x-axis, the matrix multiplications generally get more performant. There’s two primary reasons for this. </p><p>The first one is simply “more work/more parallelism”. There are a large number of fixed overheads that come with launching a kernel (e.g. creating new SMs, waiting for all SMs to finish, etc.), and so, the more work we have to do, the less important those fixed overheads are. Along with more work comes more parallelism, and since GPUs have a ton of parallel cores, you need a surprising amount of work in order to fill a GPU up with enough parallelism.</p><div class="captioned-image-container"><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!6S0a!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png" data-component-name="Image2ToDOM" rel class="image-link image2 is-viewable-img can-restack"><div class="image2-inset can-restack"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!6S0a!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png 424w, https://substackcdn.com/image/fetch/$s_!6S0a!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png 848w, https://substackcdn.com/image/fetch/$s_!6S0a!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png 1272w, https://substackcdn.com/image/fetch/$s_!6S0a!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!6S0a!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png" width="478" height="363.09615384615387" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/c5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1106,&quot;width&quot;:1456,&quot;resizeWidth&quot;:478,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" alt srcset="https://substackcdn.com/image/fetch/$s_!6S0a!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png 424w, https://substackcdn.com/image/fetch/$s_!6S0a!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png 848w, https://substackcdn.com/image/fetch/$s_!6S0a!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png 1272w, https://substackcdn.com/image/fetch/$s_!6S0a!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png 1456w" sizes="100vw" loading="lazy" class="sizing-normal"/></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg role="img" style="height:20px;width:20px" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke-width="1.5" stroke="var(--color-fg-primary)" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882"></path></g></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a><figcaption class="image-caption">Data movement is expensive!</figcaption></figure></div><p><span>The second one is “arithmetic intensity”. As I’ve </span><a href="https://horace.io/brrr_intro.html" rel>written about before</a><span>, memory accesses are much more expensive than compute. So, since a square matmul performs 3N^2 memory accesses and 2N^3 FLOPs, at a very minimum, N needs to be in the hundreds before we start spending more time on compute than memory!</span></p><p><span>The desire for sufficient Arithmetic Intensity and Parallelism also compound. For example, let’s say you have your output matrix is </span><code>1024 x 1024</code><span>. If you let each SM compute a </span><code>128 x 128 </code><span>slice of the output, that’s only 64 pieces of “work” for your GPU, not even enough for each one of an A100’s 108 SMs ! If you decrease your output slice size to 64 x 64, we now have 256 pieces of “work” for our GPU, but our arithmetic intensity has also decreased by a factor of 2.</span></p><p>With smaller matrix sizes, you need to worry about problems like this that don’t show up with larger matrices. </p><h2 class="header-anchor-post">Tiling<div class="pencraft pc-display-flex pc-alignItems-center pc-position-absolute pc-reset header-anchor-parent"><div class="pencraft pc-display-contents pc-reset pubTheme-yiXxQA"><div id="§tiling" class="pencraft pc-reset header-anchor offset-top"></div><button tabindex="0" type="button" aria-label="Link" data-href="https://www.thonking.ai/i/142904770/tiling" class="pencraft pc-reset pencraft iconButton-mq_Et5 iconButtonBase-dJGHgN buttonBase-GK1x3M buttonStyle-r7yGCK size_sm-G3LciD priority_secondary-S63h9o"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></button></div></div></h2><p>Now that we understand the overall structure of the plot, the next question is: why is the plot all over the place? Why, even for very large matrices, do the TFLOPS jumping between >250 and &lt;100?</p><p>To give a hint, let’s color-code each dot by the highest power of 2 it’s divisible by.</p><div class="captioned-image-container"><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!qMoV!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg" data-component-name="Image2ToDOM" rel class="image-link image2 is-viewable-img can-restack"><div class="image2-inset can-restack"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!qMoV!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg 424w, https://substackcdn.com/image/fetch/$s_!qMoV!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg 848w, https://substackcdn.com/image/fetch/$s_!qMoV!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg 1272w, https://substackcdn.com/image/fetch/$s_!qMoV!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!qMoV!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg" width="1456" height="1087" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1087,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Image&quot;,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" alt="Image" title="Image" srcset="https://substackcdn.com/image/fetch/$s_!qMoV!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg 424w, https://substackcdn.com/image/fetch/$s_!qMoV!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg 848w, https://substackcdn.com/image/fetch/$s_!qMoV!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg 1272w, https://substackcdn.com/image/fetch/$s_!qMoV!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg 1456w" sizes="100vw" loading="lazy" class="sizing-normal"/></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg role="img" style="height:20px;width:20px" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke-width="1.5" stroke="var(--color-fg-primary)" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882"></path></g></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a></figure></div><p>As it turns out, the multiple “levels” of FLOPS are due to their shapes’ divisibility. For example, when the shape is odd, the matmul performs significantly worse than when the shape is even. The matmul performs even better when the shape is divisible by 8, with even more performance gains when it’s divisible by 16 or 32.</p><p><span>Now, merely knowing about this effect is very practically useful, but what actually causes this effect? As it turns out, the answer is tiling. But, what even </span><em>is</em><span> tiling? And why does it cause such substantial performance issues?</span></p><div class="captioned-image-container"><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!qsho!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png" data-component-name="Image2ToDOM" rel class="image-link image2 is-viewable-img can-restack"><div class="image2-inset can-restack"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!qsho!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png 424w, https://substackcdn.com/image/fetch/$s_!qsho!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png 848w, https://substackcdn.com/image/fetch/$s_!qsho!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png 1272w, https://substackcdn.com/image/fetch/$s_!qsho!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!qsho!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png" width="1456" height="454" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:454,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:110115,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" alt srcset="https://substackcdn.com/image/fetch/$s_!qsho!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png 424w, https://substackcdn.com/image/fetch/$s_!qsho!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png 848w, https://substackcdn.com/image/fetch/$s_!qsho!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png 1272w, https://substackcdn.com/image/fetch/$s_!qsho!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png 1456w" sizes="100vw" loading="lazy" class="sizing-normal"/></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg role="img" style="height:20px;width:20px" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke-width="1.5" stroke="var(--color-fg-primary)" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882"></path></g></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a><figcaption class="image-caption">Taken from https://docs.nvidia.com/deeplearning/performance/dl-performance-matrix-multiplication/index.html#tile-quant</figcaption></figure></div><p><span>Some online have mentioned </span><a href="https://docs.nvidia.com/deeplearning/performance/dl-performance-matrix-multiplication/index.html#tile-quant" rel>tile quantization</a><span> as the culprit. Tile quantization certainly can impact performance, but </span><em>only at tile boundary sizes</em><span>. Basically, tile quantization occurs when the size of your matrix multiplication increases such that the GPU needs to launch another “chunk” of work. For example, imagine that you could multiply 8 elements at a time with a SIMD instruction. Now, if you went from 32 elements to 33 elements (a 3% increase in problem size), you go from needing 4 SIMD instructions to 5 (a 25% increase). Note that crucially, when tile quantization is the culprit, your absolute runtime still grows monotonically, although your efficiency may drop.</span></p><p><span>However, in our above plot, we see much more drastic performance drops! Moreover, like in Karpathy’s original example, we see that the </span><em>absolute runtime decreases despite problem size increasing</em><span>. So, tile quantization cannot be the explanation here.</span></p><p>The true cause is that tiling is just fundamentally worse for certain memory layouts. In other words, by the time we’re trying to execute the matmul, you’ve already lost. The memory layout is poor and your performance will suffer.</p><p>Let’s look at some examples!</p><h3 class="header-anchor-post">Memory Layout of Tiling<div class="pencraft pc-display-flex pc-alignItems-center pc-position-absolute pc-reset header-anchor-parent"><div class="pencraft pc-display-contents pc-reset pubTheme-yiXxQA"><div id="§memory-layout-of-tiling" class="pencraft pc-reset header-anchor offset-top"></div><button tabindex="0" type="button" aria-label="Link" data-href="https://www.thonking.ai/i/142904770/memory-layout-of-tiling" class="pencraft pc-reset pencraft iconButton-mq_Et5 iconButtonBase-dJGHgN buttonBase-GK1x3M buttonStyle-r7yGCK size_sm-G3LciD priority_secondary-S63h9o"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></button></div></div></h3><p>First, let’s think about how our matrix’s memory layout looks like when our size is a multiple of the cache line (pretend it’s 4 elements). </p><div class="captioned-image-container"><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!9AzH!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png" data-component-name="Image2ToDOM" rel class="image-link image2 is-viewable-img can-restack"><div class="image2-inset can-restack"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!9AzH!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png 424w, https://substackcdn.com/image/fetch/$s_!9AzH!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png 848w, https://substackcdn.com/image/fetch/$s_!9AzH!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png 1272w, https://substackcdn.com/image/fetch/$s_!9AzH!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!9AzH!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png" width="520" height="371.55555555555554" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/819f8836-c521-4363-b170-49ee039569c6_1170x836.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:836,&quot;width&quot;:1170,&quot;resizeWidth&quot;:520,&quot;bytes&quot;:624255,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" alt srcset="https://substackcdn.com/image/fetch/$s_!9AzH!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png 424w, https://substackcdn.com/image/fetch/$s_!9AzH!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png 848w, https://substackcdn.com/image/fetch/$s_!9AzH!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png 1272w, https://substackcdn.com/image/fetch/$s_!9AzH!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png 1456w" sizes="100vw" loading="lazy" class="sizing-normal"/></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg role="img" style="height:20px;width:20px" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke-width="1.5" stroke="var(--color-fg-primary)" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882"></path></g></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a><figcaption class="image-caption">I choose to show 3 “cache lines” per row because our matrix logically has 12 elements per row.</figcaption></figure></div><p><span>We see that each row starts on a cache line</span><span style="min-width:0;" data-state="closed"><a data-component-name="FootnoteAnchorToDOM" id="footnote-anchor-1-142904770" href="https://www.thonking.ai/p/what-shapes-do-matrix-multiplications#footnote-1-142904770" target="_self" rel class="footnote-anchor">1</a></span><span>. Among other advantages, this means that we don’t need to perform any “unnecessary” loads to load all yellow elements. We can just load the 3 cache lines that the yellow elements are part of.</span></p><p>However, what happens if we increase the number of elements per row from 12 to 13? </p><div class="captioned-image-container"><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!9BJj!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png" data-component-name="Image2ToDOM" rel class="image-link image2 is-viewable-img can-restack"><div class="image2-inset can-restack"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!9BJj!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png 424w, https://substackcdn.com/image/fetch/$s_!9BJj!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png 848w, https://substackcdn.com/image/fetch/$s_!9BJj!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png 1272w, https://substackcdn.com/image/fetch/$s_!9BJj!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!9BJj!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png" width="520" height="317.14701601164484" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:838,&quot;width&quot;:1374,&quot;resizeWidth&quot;:520,&quot;bytes&quot;:759750,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" alt srcset="https://substackcdn.com/image/fetch/$s_!9BJj!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png 424w, https://substackcdn.com/image/fetch/$s_!9BJj!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png 848w, https://substackcdn.com/image/fetch/$s_!9BJj!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png 1272w, https://substackcdn.com/image/fetch/$s_!9BJj!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png 1456w" sizes="100vw" loading="lazy" class="sizing-normal"/></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg role="img" style="height:20px;width:20px" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke-width="1.5" stroke="var(--color-fg-primary)" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882"></path></g></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a><figcaption class="image-caption">Each logical row (which have 13 elements) no longer starts aligned with a cache line.</figcaption></figure></div><p><span>With an unaligned layout, each row is misaligned relative to our cache line. In other words, if we start loading the beginning of the green row, we </span><em>must</em><span> redundantly load the last element of the blue row as well.</span></p><p>Now, let’s look at what happens when we actually try to load an entire “tile” from these memory layouts.</p><div class="captioned-image-container"><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!jb1C!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg" data-component-name="Image2ToDOM" rel class="image-link image2 is-viewable-img can-restack"><div class="image2-inset can-restack"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!jb1C!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg 424w, https://substackcdn.com/image/fetch/$s_!jb1C!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg 848w, https://substackcdn.com/image/fetch/$s_!jb1C!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg 1272w, https://substackcdn.com/image/fetch/$s_!jb1C!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!jb1C!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg" width="1456" height="623" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/cf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:623,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Image&quot;,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" alt="Image" title="Image" srcset="https://substackcdn.com/image/fetch/$s_!jb1C!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg 424w, https://substackcdn.com/image/fetch/$s_!jb1C!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg 848w, https://substackcdn.com/image/fetch/$s_!jb1C!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg 1272w, https://substackcdn.com/image/fetch/$s_!jb1C!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg 1456w" sizes="100vw" loading="lazy" class="sizing-normal"/></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg role="img" style="height:20px;width:20px" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke-width="1.5" stroke="var(--color-fg-primary)" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882"></path></g></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a><figcaption class="image-caption">Shaded regions = elements we’re trying to load. Crossed out regions = elements we don’t need but must load due to it being in the same cache line.</figcaption></figure></div><p>With the aligned layout, this is very clean! We issue one load per row. One for the 4 blue elements, one for the 4 green elements, one for the 4 yellow elements, and one for the 4 pink elements. </p><p>With the unaligned layout, things are much messier. For example, in order to load the first 4 green elements, we must issue 2 loads! One that gets the last blue element + the first 3 green elements, and one that gets the 4th green element. A similar pattern occurs with loading the 4 yellow elements as well as the 4 pink elements.</p><p><span>So, when our matrix size is divisible by the cache line (which is 32 elements on a GPU), tiling fits nicely within the cache line, and our memory loads are maximally efficient. When it’s not… the kernel needs many more workarounds in order to end up the proper alignment.</span><span style="min-width:0;" data-state="closed"><a data-component-name="FootnoteAnchorToDOM" id="footnote-anchor-2-142904770" href="https://www.thonking.ai/p/what-shapes-do-matrix-multiplications#footnote-2-142904770" target="_self" rel class="footnote-anchor">2</a></span></p><p>This is why even very small changes in our matrix size can lead to substantially worsened performance.</p><h2 class="header-anchor-post">Wave Quantization<div class="pencraft pc-display-flex pc-alignItems-center pc-position-absolute pc-reset header-anchor-parent"><div class="pencraft pc-display-contents pc-reset pubTheme-yiXxQA"><div id="§wave-quantization" class="pencraft pc-reset header-anchor offset-top"></div><button tabindex="0" type="button" aria-label="Link" data-href="https://www.thonking.ai/i/142904770/wave-quantization" class="pencraft pc-reset pencraft iconButton-mq_Et5 iconButtonBase-dJGHgN buttonBase-GK1x3M buttonStyle-r7yGCK size_sm-G3LciD priority_secondary-S63h9o"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></button></div></div></h2><p>Ok, so we’ve understood most of the variation in matmul performance. But what about these strange stripes up here? All of these points are with matmuls that are divisible by 32 already. Seeing that the peaks are separated by 256, our first guess might be that this is also memory-layout related, just at a larger scale.</p><div class="captioned-image-container"><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!qSyi!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png" data-component-name="Image2ToDOM" rel class="image-link image2 is-viewable-img can-restack"><div class="image2-inset can-restack"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!qSyi!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png 424w, https://substackcdn.com/image/fetch/$s_!qSyi!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png 848w, https://substackcdn.com/image/fetch/$s_!qSyi!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png 1272w, https://substackcdn.com/image/fetch/$s_!qSyi!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!qSyi!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png" width="844" height="466" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:466,&quot;width&quot;:844,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Image&quot;,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" alt="Image" title="Image" srcset="https://substackcdn.com/image/fetch/$s_!qSyi!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png 424w, https://substackcdn.com/image/fetch/$s_!qSyi!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png 848w, https://substackcdn.com/image/fetch/$s_!qSyi!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png 1272w, https://substackcdn.com/image/fetch/$s_!qSyi!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png 1456w" sizes="100vw" loading="lazy" class="sizing-normal"/></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg role="img" style="height:20px;width:20px" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke-width="1.5" stroke="var(--color-fg-primary)" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882"></path></g></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a><figcaption class="image-caption">Some truly mysterious patterns….</figcaption></figure></div><p><span>However, as it turns out, these peaks (2944 and 3120) do </span><em>not </em><span>occur when the matrix shapes are divisible by 256, but instead they’re at 128 mod 256! </span></p><p><span>As it turns out, these peaks are not caused by poor memory-layouts, they’re instead caused by a (neatly-named) phenomenon called </span><em>wave quantization</em><span>.</span></p><p>The main idea behind wave quantization is quite simple. </p><p><span>Let’s say we have N parallel tasks (which each take a second) and N CPUs. </span><br/><span>Q: How long does it perform to take all tasks?</span><br/><span>A: 1 second</span></p><p><span>Q: What about if we have (N+1) parallel tasks, and N CPUs?</span><br/><span>A: 2 seconds(!) Now, one CPU must perform two tasks, taking a total of 2 seconds.</span></p><p>So, despite adding just one task, we’ve doubled our overall latency.</p><p>This is exactly what wave quantization is, except with CPUs => SMs and tasks => thread blocks.</p><p>As your matrix size increases, the total number of tiles/blocks increases. When this crosses a multiple of the # of SMs, your perf drops since you need to execute an additional &quot;wave&quot;.</p><div class="captioned-image-container"><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!fQa1!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png" data-component-name="Image2ToDOM" rel class="image-link image2 can-restack"><div class="image2-inset can-restack"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!fQa1!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png 424w, https://substackcdn.com/image/fetch/$s_!fQa1!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png 848w, https://substackcdn.com/image/fetch/$s_!fQa1!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png 1272w, https://substackcdn.com/image/fetch/$s_!fQa1!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!fQa1!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png" width="482" height="247.17948717948718" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:200,&quot;width&quot;:390,&quot;resizeWidth&quot;:482,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Image&quot;,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" alt="Image" title="Image" srcset="https://substackcdn.com/image/fetch/$s_!fQa1!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png 424w, https://substackcdn.com/image/fetch/$s_!fQa1!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png 848w, https://substackcdn.com/image/fetch/$s_!fQa1!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png 1272w, https://substackcdn.com/image/fetch/$s_!fQa1!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png 1456w" sizes="100vw" loading="lazy" class="sizing-normal"/></picture><div></div></div></a><figcaption class="image-caption"><span>Taken from </span><a href="https://developer.nvidia.com/blog/optimizing-gpu-performance-tensor-cores/" rel>here</a></figcaption></figure></div><p>Now, let's apply our newfound knowledge to actually explain these curves! Let’s try looking at this sudden drop in performance around 1792 first.</p><div class="captioned-image-container"><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!jeez!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png" data-component-name="Image2ToDOM" rel class="image-link image2 is-viewable-img can-restack"><div class="image2-inset can-restack"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!jeez!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png 424w, https://substackcdn.com/image/fetch/$s_!jeez!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png 848w, https://substackcdn.com/image/fetch/$s_!jeez!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png 1272w, https://substackcdn.com/image/fetch/$s_!jeez!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!jeez!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png" width="244" height="429.5299539170507" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:764,&quot;width&quot;:434,&quot;resizeWidth&quot;:244,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Image&quot;,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" alt="Image" title="Image" srcset="https://substackcdn.com/image/fetch/$s_!jeez!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png 424w, https://substackcdn.com/image/fetch/$s_!jeez!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png 848w, https://substackcdn.com/image/fetch/$s_!jeez!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png 1272w, https://substackcdn.com/image/fetch/$s_!jeez!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png 1456w" sizes="100vw" loading="lazy" class="sizing-normal"/></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg role="img" style="height:20px;width:20px" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke-width="1.5" stroke="var(--color-fg-primary)" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882"></path></g></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a></figure></div><p>Since wave quantization depends a lot on the actual kernel parameters, we must look at what kernels are actually being run.</p><div class="captioned-image-container"><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!ceIo!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png" data-component-name="Image2ToDOM" rel class="image-link image2 can-restack"><div class="image2-inset can-restack"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!ceIo!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png 424w, https://substackcdn.com/image/fetch/$s_!ceIo!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png 848w, https://substackcdn.com/image/fetch/$s_!ceIo!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png 1272w, https://substackcdn.com/image/fetch/$s_!ceIo!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!ceIo!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png" width="1456" height="173" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:173,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Image&quot;,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" alt="Image" title="Image" srcset="https://substackcdn.com/image/fetch/$s_!ceIo!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png 424w, https://substackcdn.com/image/fetch/$s_!ceIo!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png 848w, https://substackcdn.com/image/fetch/$s_!ceIo!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png 1272w, https://substackcdn.com/image/fetch/$s_!ceIo!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png 1456w" sizes="100vw" loading="lazy" class="sizing-normal"/></picture><div></div></div></a></figure></div><p>Using the profiler, we see that we're running a CUTLASS-based matmul with a tile size of 256x128. Note that our matmul kernel *doesn't change at all*, but our perf drops from 60+ TF/s at N=1791 to 43 TF/s at N=1793. </p><p>Now, some basic arithmetic. Our tile grid has dimensions 1792/256 = 7 and 1792/128 = 14. That gives us 7 * 14 = 98 tiles. Since an A100 has 108 SMs, that's still one wave. However, with N=1793 we need to increase the size of our grid. (7+1)*(14+1) = 120 tiles, or 2 waves!</p><p>Now, let’s look at the previous (mysterious) stripes. Specifically, we’ll look at N=3200.</p><div class="captioned-image-container"><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!pblj!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png" data-component-name="Image2ToDOM" rel class="image-link image2 is-viewable-img can-restack"><div class="image2-inset can-restack"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!pblj!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png 424w, https://substackcdn.com/image/fetch/$s_!pblj!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png 848w, https://substackcdn.com/image/fetch/$s_!pblj!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png 1272w, https://substackcdn.com/image/fetch/$s_!pblj!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!pblj!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png" width="476" height="262.81516587677726" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:466,&quot;width&quot;:844,&quot;resizeWidth&quot;:476,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Image&quot;,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" alt="Image" title="Image" srcset="https://substackcdn.com/image/fetch/$s_!pblj!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png 424w, https://substackcdn.com/image/fetch/$s_!pblj!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png 848w, https://substackcdn.com/image/fetch/$s_!pblj!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png 1272w, https://substackcdn.com/image/fetch/$s_!pblj!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png 1456w" sizes="100vw" loading="lazy" class="sizing-normal"/></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg role="img" style="height:20px;width:20px" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke-width="1.5" stroke="var(--color-fg-primary)" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882"></path></g></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a><figcaption class="image-caption">Mysterious no more!</figcaption></figure></div><p><span>Profiling it, we see that the </span><em>proximal</em><span> cause is not actually wave quantization. Instead, CuBLAS decided to  change algorithms. But, why did CuBLAS decide to change algorithms?</span></p><div class="captioned-image-container"><figure><a target="_blank" href="https://substackcdn.com/image/fetch/$s_!zEMy!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png" data-component-name="Image2ToDOM" rel class="image-link image2 can-restack"><div class="image2-inset can-restack"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!zEMy!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png 424w, https://substackcdn.com/image/fetch/$s_!zEMy!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png 848w, https://substackcdn.com/image/fetch/$s_!zEMy!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png 1272w, https://substackcdn.com/image/fetch/$s_!zEMy!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png 1456w" sizes="100vw"/><img src="https://substackcdn.com/image/fetch/$s_!zEMy!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png" width="1456" height="244" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:244,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Image&quot;,&quot;title&quot;:&quot;Image&quot;,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" alt="Image" title="Image" srcset="https://substackcdn.com/image/fetch/$s_!zEMy!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png 424w, https://substackcdn.com/image/fetch/$s_!zEMy!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png 848w, https://substackcdn.com/image/fetch/$s_!zEMy!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png 1272w, https://substackcdn.com/image/fetch/$s_!zEMy!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png 1456w" sizes="100vw" loading="lazy" class="sizing-normal"/></picture><div></div></div></a></figure></div><p>Well, (3200/128) * (3200/128) = 625. 625/108 = 5.8 waves. Thus, at N=3232 we would create another wave.</p><p>In this case, though, it seems that 160x128 still isn't a great tile size. Since the resulting grid (26x21) results in 5.05 waves...</p><p>Well, CuBLAS isn't perfect!</p><p>Beyond the obvious matrix multiplication shape issues, performance loss due to wave quantization often ends up being tricky to find, since it depends upon things like the batch size as well. However, if you take a closer look at each matmul, you might find that there’s another 10-15% performance you can squeeze out of it by choosing the shapes more carefully!</p><p><span>I will note that it’s possible that wave quantization effects may soon be a thing of the past. New matrix multiplication technology like </span><a href="https://arxiv.org/abs/2301.03598" rel>stream-k</a><span> allow us to completely bypass wave quantization effects. Perhaps I’ll explain the basic idea behind matmul implementation strategies someday.</span></p><h2 class="header-anchor-post">Why doesn’t torch.compile just fix my problems so I don’t have to think about this?<div class="pencraft pc-display-flex pc-alignItems-center pc-position-absolute pc-reset header-anchor-parent"><div class="pencraft pc-display-contents pc-reset pubTheme-yiXxQA"><div id="§why-doesnt-torchcompile-just-fix-my-problems-so-i-dont-have-to-think-about-this" class="pencraft pc-reset header-anchor offset-top"></div><button tabindex="0" type="button" aria-label="Link" data-href="https://www.thonking.ai/i/142904770/why-doesnt-torchcompile-just-fix-my-problems-so-i-dont-have-to-think-about-this" class="pencraft pc-reset pencraft iconButton-mq_Et5 iconButtonBase-dJGHgN buttonBase-GK1x3M buttonStyle-r7yGCK size_sm-G3LciD priority_secondary-S63h9o"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></button></div></div></h2><p><span>As it turns out, torch.compile does try and pad your matmuls to have the right shape! See the code </span><a href="https://github.com/pytorch/pytorch/blob/6b1f13ea2f3b1bcd575620eecd7d84a4d2e3eb76/torch/_inductor/fx_passes/pad_mm.py#L90" rel>here</a><span>, or try this benchmark.</span></p><pre><code>import torch
torch.set_default_device('cuda')
from triton.testing import do_bench

def f(a, b):
    return torch.mm(a, b)

a = torch.randn(4096, 4096, dtype=torch.bfloat16)
b = torch.randn(4096, 4095, dtype=torch.bfloat16)
print(&quot;eager: &quot;, do_bench(lambda: f(a, b)))
cf = torch.compile(f)
print(&quot;compiled: &quot;, do_bench(lambda: cf(a, b)))
>> eager: 1.4077268838882446
>> compiled: 0.6021425127983093</code></pre><p>However, there are still limitations that mean it makes sense for users to manually pad their shapes. </p><p>For one, padding requires a full copy! Although torch.compile can often fuse this into a preceding op, in the case where the matrix being padded comes from the input (like a weight matrix), there’s no way to avoid this copy.</p><p>Second, resolving wave quantization is far more difficult.</p><h2 class="header-anchor-post">Conclusion<div class="pencraft pc-display-flex pc-alignItems-center pc-position-absolute pc-reset header-anchor-parent"><div class="pencraft pc-display-contents pc-reset pubTheme-yiXxQA"><div id="§conclusion" class="pencraft pc-reset header-anchor offset-top"></div><button tabindex="0" type="button" aria-label="Link" data-href="https://www.thonking.ai/i/142904770/conclusion" class="pencraft pc-reset pencraft iconButton-mq_Et5 iconButtonBase-dJGHgN buttonBase-GK1x3M buttonStyle-r7yGCK size_sm-G3LciD priority_secondary-S63h9o"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></button></div></div></h2><p><span>Overall, I hope the topic of &quot;how do I squeeze the most out of my matmuls&quot; is an interesting one. There's still many more intricacies in matmul perf that I didn’t have the time to get to, as well (I’m sure) many more intricacies that I don’t know! Here’s the </span><a href="https://gist.github.com/Chillee/f86675147366a7a0c6e244eaa78660f7#file-4-matmul-bench-py" rel>main code</a><span> to replicate the results.</span></p><p>Also, here’s some quiz questions to test your understanding! I will publish a brief explanation of the answers at some later point.</p><h3 class="header-anchor-post">Quiz Questions<div class="pencraft pc-display-flex pc-alignItems-center pc-position-absolute pc-reset header-anchor-parent"><div class="pencraft pc-display-contents pc-reset pubTheme-yiXxQA"><div id="§quiz-questions" class="pencraft pc-reset header-anchor offset-top"></div><button tabindex="0" type="button" aria-label="Link" data-href="https://www.thonking.ai/i/142904770/quiz-questions" class="pencraft pc-reset pencraft iconButton-mq_Et5 iconButtonBase-dJGHgN buttonBase-GK1x3M buttonStyle-r7yGCK size_sm-G3LciD priority_secondary-S63h9o"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></button></div></div></h3><p><strong>1:</strong><span> Let's say I have a </span><code>[M x K] @ [K x N]</code><span> matmul. Which one of these configurations will have the best perf? Think about the actual ramifications of tiling! Both matrices are in row-major layout (i.e. K and N are the innermost dimensions)</span><br/><span>A: M=2047, K=N=2048 </span><br/><span>B: K=2047, M=N=2048 </span><br/><span>C: N=2047, M=K=2048</span></p><div dataAttrs="{&quot;id&quot;:161737}" class="poll-embed"><div data-component-name="Poll" class="pencraft pc-display-flex pc-flexDirection-column pc-gap-24 pc-reset poll-wrapper poll-web"><div id="poll-161737" class="poll-anchor-target"><div class="poll-anchor-copy-button"><a href="https://www.thonking.ai/p/what-shapes-do-matrix-multiplications#poll-161737"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></div></div><div class="pencraft pc-display-flex pc-flexDirection-column pc-gap-8 pc-paddingTop-48 pc-paddingBottom-48 pc-justifyContent-center pc-alignItems-center pc-reset"><div translated class="pencraft pc-reset color-secondary-ls1g8s line-height-20-t4M0El font-meta-MWBumP size-11-NuY2Zx weight-medium-fw81nC transform-uppercase-yKDgcq reset-IxiVJZ meta-EgzBVA">Loading...</div></div></div></div><p><strong>2: </strong><span>Let’s say I have an A100 with 108 SMs, and I want to benchmark a number of matmuls with no wave quantization. How would I go about constructing the shapes for these matmuls?</span></p><p><strong>3: </strong><span>Based off this post, would you expect that making your batch size a power of 2 leads to more efficient performance?</span></p><div dataAttrs="{&quot;id&quot;:161740}" class="poll-embed"><div data-component-name="Poll" class="pencraft pc-display-flex pc-flexDirection-column pc-gap-24 pc-reset poll-wrapper poll-web"><div id="poll-161740" class="poll-anchor-target"><div class="poll-anchor-copy-button"><a href="https://www.thonking.ai/p/what-shapes-do-matrix-multiplications#poll-161740"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></div></div><div class="pencraft pc-display-flex pc-flexDirection-column pc-gap-8 pc-paddingTop-48 pc-paddingBottom-48 pc-justifyContent-center pc-alignItems-center pc-reset"><div translated class="pencraft pc-reset color-secondary-ls1g8s line-height-20-t4M0El font-meta-MWBumP size-11-NuY2Zx weight-medium-fw81nC transform-uppercase-yKDgcq reset-IxiVJZ meta-EgzBVA">Loading...</div></div></div></div><p><strong>4: </strong><span>Similar to Question 1, let’s say we have a A: [M x K] @ B: [K x N] matmul.  However, now, A is in column-major (i.e. </span><code>torch.randn(K, M).t()</code><span>) while B is still row-major. What is the best configuration now?</span><br/><br/><span>A: M=2047, K=N=2048 </span><br/><span>B: K=2047, M=N=2048 </span><br/><span>C: N=2047, M=K=2048</span></p><p><strong>5: </strong><span>Let’s say that we have this code.</span></p><pre><code>A = torch.randn(4096, 4096)
B = torch.randn(4096, 4096)
B = B[:, :4095] # B now has shape [4096, 4095]</code></pre><p>Would you expect that we have good performance on a matmul between A and B?</p><p><span>Solutions can be found below</span><br/></p><div data-component-name="DigestPostEmbed" class="digestPostEmbed-flwiST"><div class="pencraft pc-display-flex pc-justifyContent-center pc-alignItems-center pc-reset bg-tertiary-CPDeXV pc-borderRadius-md videoEmbedPlaceholder-AnM6Oo"><div aria-valuemax="100" aria-valuemin="0" role="progressbar" data-state="indeterminate" data-max="100" aria-label="Loading" class="pencraft pc-display-flex pc-padding-16 pc-justifyContent-center pc-alignItems-center pc-reset flex-grow-rzmknG spinner-q_nGBK theme_default-qMdqgV"><svg width="24" height="24" viewBox="0 0 24 24" vector-effect="non-scaling-stroke" data-state="indeterminate" data-max="100"><circle cx="12" cy="12" r="11" stroke-width="2" fill="none" stroke="var(--color-utility-detail)" class="bg-UXIMqb"></circle><circle cx="12" cy="12" r="11" stroke-width="2" fill="none" class="fg-MeJce5"></circle></svg></div></div></div><div class="subscription-widget-wrap"><div class="subscription-widget show-subscribe"><div class="preamble"><p>Thonk From First Principles is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><div data-component-name="SubscribeWidget" class="subscribe-widget"><div class="pencraft pc-display-flex pc-justifyContent-center pc-reset"><div class="container-IpPqBD"><form action="/api/v1/free?nojs=true" method="post" novalidate class="form form-M5sC90"><input type="hidden" name="first_url" value/><input type="hidden" name="first_referrer" value/><input type="hidden" name="current_url"/><input type="hidden" name="current_referrer"/><input type="hidden" name="first_session_url" value/><input type="hidden" name="first_session_referrer" value/><input type="hidden" name="referral_code"/><input type="hidden" name="source" value="subscribe-widget-preamble"/><input type="hidden" name="referring_pub_id"/><input type="hidden" name="additional_referring_pub_ids"/><div class="sideBySideWrap-vGXrwP"><div class="emailInputWrapper-QlA86j"><div class="pencraft pc-display-flex pc-minWidth-0 pc-position-relative pc-reset flex-auto-j3S2WA"><input name="email" placeholder="Type your email..." type="email" class="pencraft emailInput-OkIMeB input-y4v6N4 inputText-pV_yWb"/></div></div><button tabindex="0" type="submit" disabled class="pencraft pc-reset pencraft rightButton primary subscribe-btn button-VFSdkv buttonBase-GK1x3M"><span class="button-text ">Subscribe</span></button></div><div id="error-container"></div></form></div></div></div></div></div><div data-component-name="FootnoteToDOM" class="footnote"><a id="footnote-1-142904770" href="https://www.thonking.ai/p/what-shapes-do-matrix-multiplications#footnote-anchor-1-142904770" contenteditable="false" target="_self" rel class="footnote-number">1</a><div class="footnote-content"><p>A cache line is a block of memory that’s usually something like 128 bytes long, although in our examples, we’re pretending that it’s 4 elements long. You can pretend that a cache line is the “minimum memory access size”. In other words, in order to load any of the elements from a cache line, you must load the entire cache line.</p></div></div><div data-component-name="FootnoteToDOM" class="footnote"><a id="footnote-2-142904770" href="https://www.thonking.ai/p/what-shapes-do-matrix-multiplications#footnote-anchor-2-142904770" contenteditable="false" target="_self" rel class="footnote-number">2</a><div class="footnote-content"><p><span>In fact, earlier versions of CuBLAS (back when tensor cores were new) didn’t even </span><em>use</em><span> tensor-cores unless the shapes were divisible by 8.</span></p></div></div></div></div><div class="visibility-check"></div><div class="post-footer"><div class="pencraft pc-display-flex pc-gap-16 pc-paddingTop-16 pc-paddingBottom-16 pc-justifyContent-space-between pc-alignItems-center pc-reset flex-grow-rzmknG border-top-detail-themed-k9TZAY border-bottom-detail-themed-Ua9186 post-ufi"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><div class="like-button-container post-ufi-button style-button"><button tabindex="0" type="button" aria-label="Like (91)" aria-pressed="false" class="pencraft pc-reset pencraft post-ufi-button style-button has-label with-border"><svg role="img" style="height:20px;width:20px;" width="20" height="20" viewBox="0 0 24 24" fill="#000000" stroke-width="2" stroke="#000" xmlns="http://www.w3.org/2000/svg" class="icon"><g><title></title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path></svg></g></svg><div class="label">91</div></button></div><button tabindex="0" type="button" aria-label="View comments (2)" data-href="https://www.thonking.ai/p/what-shapes-do-matrix-multiplications/comments" class="pencraft pc-reset pencraft post-ufi-button style-button post-ufi-comment-button has-label with-border"><svg role="img" style="height:20px;width:20px;" width="20" height="20" viewBox="0 0 24 24" fill="#000000" stroke-width="2" stroke="#000" xmlns="http://www.w3.org/2000/svg" class="icon"><g><title></title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-circle"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"></path></svg></g></svg><div class="label">2</div></button><button tabindex="0" type="button" id="radix-P0-56" aria-haspopup="menu" aria-expanded="false" data-state="closed" class="pencraft pc-reset pencraft post-ufi-button style-button has-label with-border"><svg role="img" style="height:20px;width:20px;" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke="#000" xmlns="http://www.w3.org/2000/svg" class="icon"><g><title></title><path d="M21 3V8M21 8H16M21 8L18 5.29962C16.7056 4.14183 15.1038 3.38328 13.3879 3.11547C11.6719 2.84766 9.9152 3.08203 8.32951 3.79031C6.74382 4.49858 5.39691 5.65051 4.45125 7.10715C3.5056 8.5638 3.00158 10.2629 3 11.9996M3 21V16M3 16H8M3 16L6 18.7C7.29445 19.8578 8.89623 20.6163 10.6121 20.8841C12.3281 21.152 14.0848 20.9176 15.6705 20.2093C17.2562 19.501 18.6031 18.3491 19.5487 16.8925C20.4944 15.4358 20.9984 13.7367 21 12" stroke-linecap="round" stroke-linejoin="round"></path></g></svg><div class="label">3</div></button></div><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft post-ufi-button style-button has-label with-border"><div class="label">Share</div></button></div></div></div></div></article></div></div></div><div class="pencraft pc-display-contents pc-reset pubTheme-yiXxQA"><div class="visibility-check"></div><div id="discussion" class="pencraft pc-display-flex pc-flexDirection-column pc-gap-16 pc-paddingTop-32 pc-paddingBottom-32 pc-reset"><div class="pencraft pc-display-flex pc-flexDirection-column pc-gap-32 pc-reset container"><h4 class="pencraft pc-reset line-height-24-jnGwiv font-display-nhmvtD size-20-P_cSRT weight-bold-DmI9lw reset-IxiVJZ">Discussion about this post</h4><div class="pencraft pc-alignSelf-flex-start pc-reset"><div class="pencraft pc-display-flex pc-flexDirection-column pc-position-relative pc-minWidth-0 pc-reset bg-primary-zk6FDl outline-detail-vcQLyr pc-borderRadius-sm overflow-hidden-WdpwT6"><div dir="ltr" data-orientation="horizontal" class="pencraft pc-display-flex pc-flexDirection-column pc-reset flex-grow-rzmknG"><div style="outline:none;" tabindex="-1" aria-label="Select discussion type" role="tablist" aria-orientation="horizontal" data-orientation="horizontal" class="pencraft pc-display-flex pc-gap-4 pc-padding-4 pc-position-relative pc-reset cursor-default-flE2S1 pc-borderRadius-sm overflow-auto-7WTsTi scrollBar-hidden-HcAIpI"><button tabindex="-1" type="button" role="tab" aria-selected="true" aria-controls="radix-P0-70-content-comments" data-state="active" id="radix-P0-70-trigger-comments" data-orientation="horizontal" data-radix-collection-item class="pencraft pc-reset flex-auto-j3S2WA pencraft segment-j4TeZ4 buttonBase-GK1x3M buttonText-X0uSmG buttonStyle-r7yGCK priority_quaternary-kpMibu size_sm-G3LciD">Comments</button><button tabindex="-1" type="button" role="tab" aria-selected="false" aria-controls="radix-P0-70-content-restacks" data-state="inactive" id="radix-P0-70-trigger-restacks" data-orientation="horizontal" data-radix-collection-item class="pencraft pc-reset flex-auto-j3S2WA pencraft segment-j4TeZ4 buttonBase-GK1x3M buttonText-X0uSmG buttonStyle-r7yGCK priority_quaternary-kpMibu size_sm-G3LciD">Restacks</button><div class="pencraft pc-position-absolute pc-height-32 pc-reset bg-secondary-UUD3_J pc-borderRadius-xs sizing-border-box-DggLA4 highlight-U002IP"></div></div></div><div class="pencraft pc-display-flex pc-alignItems-center pc-reset arrowButtonContainer-O4uSiH arrowButtonOverlaidContainer-t10AyH left-Tg8vqp"><div class="overlay-zrMCxn primary-lv_sOW"></div></div><div class="pencraft pc-display-flex pc-alignItems-center pc-reset arrowButtonContainer-O4uSiH arrowButtonOverlaidContainer-t10AyH right-i3oWGi"><div class="overlay-zrMCxn primary-lv_sOW"></div></div></div></div></div><div class="single-post-section comments-section"><div class="container"><div class="visibility-check"></div><div data-test-id="comment-input" class="pencraft pc-display-flex pc-reset flex-grow-rzmknG"><form class="form-CkZ7Kt"><div style="--scale:32px;" class="pencraft pc-display-flex pc-width-32 pc-height-32 pc-justifyContent-center pc-alignItems-center pc-position-relative pc-reset bg-secondary-UUD3_J flex-auto-j3S2WA outline-detail-vcQLyr pc-borderRadius-full overflow-hidden-WdpwT6 sizing-border-box-DggLA4 container-TAtrWj"><div style="--scale:32px;" title="User" class="pencraft pc-display-flex pc-width-32 pc-height-32 pc-justifyContent-center pc-alignItems-center pc-position-relative pc-reset bg-secondary-UUD3_J flex-auto-j3S2WA outline-detail-vcQLyr pc-borderRadius-full overflow-hidden-WdpwT6 sizing-border-box-DggLA4 container-TAtrWj"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!TnFC!,w_32,h_32,c_fill,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack.com%2Fimg%2Favatars%2Fdefault-light.png 32w, https://substackcdn.com/image/fetch/$s_!TnFC!,w_64,h_64,c_fill,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack.com%2Fimg%2Favatars%2Fdefault-light.png 64w, https://substackcdn.com/image/fetch/$s_!TnFC!,w_96,h_96,c_fill,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack.com%2Fimg%2Favatars%2Fdefault-light.png 96w" sizes="32px"/><img src="https://substackcdn.com/image/fetch/$s_!TnFC!,w_32,h_32,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack.com%2Fimg%2Favatars%2Fdefault-light.png" sizes="32px" alt="User's avatar" srcset="https://substackcdn.com/image/fetch/$s_!TnFC!,w_32,h_32,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack.com%2Fimg%2Favatars%2Fdefault-light.png 32w, https://substackcdn.com/image/fetch/$s_!TnFC!,w_64,h_64,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack.com%2Fimg%2Favatars%2Fdefault-light.png 64w, https://substackcdn.com/image/fetch/$s_!TnFC!,w_96,h_96,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack.com%2Fimg%2Favatars%2Fdefault-light.png 96w" width="32" height="32" draggable="false" class="img-OACg1c object-fit-cover-u4ReeV pencraft pc-reset"/></picture></div></div><div class="pencraft pc-display-flex pc-flexDirection-column pc-gap-8 pc-reset flex-grow-rzmknG"><textarea name="body" placeholder="Write a comment..." aria-label="Write a comment..." rows="4" class="pencraft input-qHk4bN autogrowing-_ipn9Y textarea-GbEjRX inputText-pV_yWb"></textarea><div data-state="closed" class="pencraft pc-display-flex pc-flexDirection-column pc-reset overflow-hidden-WdpwT6"></div></div></form></div><div class="comment-list post-page-root-comment-list"><div class="comment-list-items"><div class="comment"><div id="comment-78734998" class="comment-anchor"></div><div id="comment-78734998-reply" class="comment-anchor"></div><div role="article" aria-label="Comment by Gregor Shapiro" class="pencraft pc-display-flex pc-gap-12 pc-paddingBottom-12 pc-reset comment-content"><div class="pencraft pc-display-flex pc-flexDirection-column pc-reset"><a href="https://substack.com/profile/42039806-gregor-shapiro?utm_source=comment" aria-label="View Gregor Shapiro's profile" class="pencraft pc-display-contents pc-reset"><div style="--scale:32px;" tabindex="0" class="pencraft pc-display-flex pc-width-32 pc-height-32 pc-justifyContent-center pc-alignItems-center pc-position-relative pc-reset bg-secondary-UUD3_J flex-auto-j3S2WA animate-XFJxE4 outline-detail-vcQLyr pc-borderRadius-full overflow-hidden-WdpwT6 sizing-border-box-DggLA4 pressable-sm-YIJFKJ showFocus-sk_vEm container-TAtrWj interactive-UkK0V6"><div style="--scale:32px;" title="Gregor Shapiro" class="pencraft pc-display-flex pc-width-32 pc-height-32 pc-justifyContent-center pc-alignItems-center pc-position-relative pc-reset bg-secondary-UUD3_J flex-auto-j3S2WA outline-detail-vcQLyr pc-borderRadius-full overflow-hidden-WdpwT6 sizing-border-box-DggLA4 container-TAtrWj"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!C4p3!,w_32,h_32,c_fill,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f015139-8bba-4579-8d3b-0d7687eea901_144x144.png 32w, https://substackcdn.com/image/fetch/$s_!C4p3!,w_64,h_64,c_fill,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f015139-8bba-4579-8d3b-0d7687eea901_144x144.png 64w, https://substackcdn.com/image/fetch/$s_!C4p3!,w_96,h_96,c_fill,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f015139-8bba-4579-8d3b-0d7687eea901_144x144.png 96w" sizes="32px"/><img src="https://substackcdn.com/image/fetch/$s_!C4p3!,w_32,h_32,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f015139-8bba-4579-8d3b-0d7687eea901_144x144.png" sizes="32px" alt="Gregor Shapiro's avatar" srcset="https://substackcdn.com/image/fetch/$s_!C4p3!,w_32,h_32,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f015139-8bba-4579-8d3b-0d7687eea901_144x144.png 32w, https://substackcdn.com/image/fetch/$s_!C4p3!,w_64,h_64,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f015139-8bba-4579-8d3b-0d7687eea901_144x144.png 64w, https://substackcdn.com/image/fetch/$s_!C4p3!,w_96,h_96,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3f015139-8bba-4579-8d3b-0d7687eea901_144x144.png 96w" width="32" height="32" draggable="false" class="img-OACg1c object-fit-cover-u4ReeV pencraft pc-reset"/></picture></div></div></a></div><div class="pencraft pc-display-flex pc-flexDirection-column pc-reset flex-grow-rzmknG"><div class="pencraft pc-display-flex pc-reset"><div class="pencraft pc-display-flex pc-flexDirection-column pc-gap-4 pc-reset"><div class="pencraft pc-display-flex pc-minWidth-0 pc-gap-8 pc-alignItems-center pc-height-20 pc-reset line-height-20-t4M0El font-text-qe4AeH size-15-Psle70 weight-regular-mUq6Gb"><div class="pencraft pc-display-flex pc-minWidth-0 pc-gap-8 pc-alignItems-center pc-reset flex-grow-rzmknG"><div class="pencraft pc-display-flex pc-gap-6 pc-reset color-primary-zABazT line-height-20-t4M0El font-text-qe4AeH size-13-hZTUKr weight-regular-mUq6Gb reset-IxiVJZ"><span class="pencraft pc-reset line-height-20-t4M0El font-text-qe4AeH size-15-Psle70 weight-medium-fw81nC reset-IxiVJZ"><span style="min-width:0;" data-state="closed"><span class="pencraft pc-reset decoration-hover-underline-ClDVRM reset-IxiVJZ"><a href="https://substack.com/profile/42039806-gregor-shapiro?utm_source=substack-feed-item" showBack data-native="true" class="link-LIBpto">Gregor Shapiro</a></span></span> </span></div><span style="min-width:0;" data-state="closed"></span><a data-native="true" href="https://www.thonking.ai/p/what-shapes-do-matrix-multiplications/comment/78734998" rel="nofollow" title="Nov 25, 2024, 5:58 AM" class="pencraft pc-reset color-secondary-ls1g8s decoration-hover-underline-ClDVRM reset-IxiVJZ"><span class="pencraft pc-reset color-secondary-ls1g8s line-height-20-t4M0El font-text-qe4AeH size-13-hZTUKr weight-regular-mUq6Gb reset-IxiVJZ">Nov 25, 2024</span></a></div></div><div class="pencraft pc-display-flex pc-gap-4 pc-reset"><button tabindex="-1" type="button" class="pencraft pc-display-flex pc-gap-4 pc-height-20 pc-paddingLeft-6 pc-paddingRight-6 pc-paddingTop-2 pc-paddingBottom-2 pc-alignItems-center pc-reset font-text-qe4AeH size-11-NuY2Zx weight-medium-fw81nC pencraft tag-XbOVLt theme_accent-Y2sqZY priority_secondary-outline-RpooJS pencraft pc-display-flex pc-height-20 pc-paddingLeft-6 pc-paddingRight-6 pc-paddingTop-2 pc-paddingBottom-2 pc-gap-4 pc-alignItems-center pc-reset cursor-inherit-LxLBJ6 pc-borderRadius-xs font-text-qe4AeH size-11-NuY2Zx weight-medium-fw81nC"><div class="pencraft pc-display-flex pc-alignItems-center pc-reset leading-mI5Ihl fillIcon-dQ0mii"><svg role="img" style="height:14px;width:14px;" width="14" height="14" viewBox="0 0 20 20" fill="var(--color-fg-primary)" stroke-width="2.5" stroke="#000" xmlns="http://www.w3.org/2000/svg"><g><title></title><path stroke="none" d="M9.99915 16.7256C9.90515 16.7256 9.79102 16.692 9.65674 16.6249C9.52246 16.5622 9.3949 16.4906 9.27405 16.41C8.02974 15.6044 6.94657 14.7584 6.02454 13.8722C5.10697 12.9815 4.3953 12.0662 3.88953 11.1262C3.38375 10.1818 3.13086 9.23067 3.13086 8.27283C3.13086 7.63725 3.23157 7.05762 3.43298 6.53394C3.63888 6.01025 3.92086 5.55819 4.27893 5.17773C4.64148 4.79728 5.05774 4.50635 5.52771 4.30493C6.00216 4.09904 6.51241 3.99609 7.05847 3.99609C7.73433 3.99609 8.31844 4.16618 8.81079 4.50635C9.30762 4.84652 9.70374 5.28963 9.99915 5.83569C10.299 5.28516 10.6951 4.84204 11.1875 4.50635C11.6843 4.16618 12.2707 3.99609 12.9465 3.99609C13.4836 3.99609 13.9894 4.09904 14.4639 4.30493C14.9428 4.50635 15.3613 4.79728 15.7194 5.17773C16.0774 5.55819 16.3572 6.01025 16.5586 6.53394C16.7645 7.05762 16.8674 7.63725 16.8674 8.27283C16.8674 9.23067 16.6145 10.1818 16.1088 11.1262C15.603 12.0662 14.8891 12.9815 13.967 13.8722C13.0495 14.7584 11.9708 15.6044 10.731 16.41C10.6056 16.4906 10.4758 16.5622 10.3416 16.6249C10.2118 16.692 10.0976 16.7256 9.99915 16.7256Z"></path></g></svg></div>Liked by Horace He</button></div></div><div class="pencraft pc-display-flex pc-flexDirection-column pc-reset flex-grow-rzmknG"></div><div class="pencraft pc-display-flex pc-reset triggerContainer-eX588u"><button tabindex="0" type="button" aria-label="Ellipsis" id="radix-P0-83" aria-haspopup="menu" aria-expanded="false" data-state="closed" class="pencraft pc-reset pencraft trigger-j08Uop iconButton-mq_Et5 iconButtonBase-dJGHgN buttonBase-GK1x3M buttonStyle-r7yGCK size_sm-G3LciD priority_quaternary-kpMibu"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ellipsis"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg></button></div></div><div class="comment-body expanded"><p><span>Can you get Grant Sanderson to illustrate this with animations on 3Blue 1Brown?</span></p></div><div class="pencraft pc-display-flex pc-gap-16 pc-paddingTop-8 pc-justifyContent-flex-start pc-alignItems-center pc-reset comment-actions withShareButton-hQzuEn"><span class="pencraft pc-reset decoration-hover-underline-ClDVRM reset-IxiVJZ"><a class="pencraft pc-reset link-_X6et2 link-LIBpto"><div class="pencraft pc-display-flex pc-gap-6 pc-alignItems-center pc-reset"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-fg-secondary-themed)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-circle"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"></path></svg><div class="pencraft pc-reset color-pub-secondary-text-hGQ02T line-height-20-t4M0El font-meta-MWBumP size-11-NuY2Zx weight-medium-fw81nC transform-uppercase-yKDgcq reset-IxiVJZ meta-EgzBVA">Reply</div></div></a></span><span class="pencraft pc-reset decoration-hover-underline-ClDVRM reset-IxiVJZ"><a class="pencraft pc-reset link-_X6et2 link-LIBpto"><div class="pencraft pc-display-flex pc-gap-6 pc-alignItems-center pc-reset"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-fg-secondary-themed)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-share"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" x2="12" y1="2" y2="15"></line></svg><div class="pencraft pc-reset color-pub-secondary-text-hGQ02T line-height-20-t4M0El font-meta-MWBumP size-11-NuY2Zx weight-medium-fw81nC transform-uppercase-yKDgcq reset-IxiVJZ meta-EgzBVA">Share</div></div></a></span></div><div data-state="closed" class="pencraft pc-display-flex pc-flexDirection-column pc-reset overflow-hidden-WdpwT6"></div></div></div></div><div class="comment"><div id="comment-75778790" class="comment-anchor"></div><div id="comment-75778790-reply" class="comment-anchor"></div><div role="article" aria-label="Comment by FeepingCreature" class="pencraft pc-display-flex pc-gap-12 pc-paddingBottom-12 pc-reset comment-content"><div class="pencraft pc-display-flex pc-flexDirection-column pc-reset"><a href="https://substack.com/profile/11057353-feepingcreature?utm_source=comment" aria-label="View FeepingCreature's profile" class="pencraft pc-display-contents pc-reset"><div style="--scale:32px;" tabindex="0" class="pencraft pc-display-flex pc-width-32 pc-height-32 pc-justifyContent-center pc-alignItems-center pc-position-relative pc-reset bg-secondary-UUD3_J flex-auto-j3S2WA animate-XFJxE4 outline-detail-vcQLyr pc-borderRadius-full overflow-hidden-WdpwT6 sizing-border-box-DggLA4 pressable-sm-YIJFKJ showFocus-sk_vEm container-TAtrWj interactive-UkK0V6"><div style="--scale:32px;" title="FeepingCreature" class="pencraft pc-display-flex pc-width-32 pc-height-32 pc-justifyContent-center pc-alignItems-center pc-position-relative pc-reset bg-secondary-UUD3_J flex-auto-j3S2WA outline-detail-vcQLyr pc-borderRadius-full overflow-hidden-WdpwT6 sizing-border-box-DggLA4 container-TAtrWj"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!DFX4!,w_32,h_32,c_fill,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack.com%2Fimg%2Favatars%2Fgreen.png 32w, https://substackcdn.com/image/fetch/$s_!DFX4!,w_64,h_64,c_fill,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack.com%2Fimg%2Favatars%2Fgreen.png 64w, https://substackcdn.com/image/fetch/$s_!DFX4!,w_96,h_96,c_fill,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack.com%2Fimg%2Favatars%2Fgreen.png 96w" sizes="32px"/><img src="https://substackcdn.com/image/fetch/$s_!DFX4!,w_32,h_32,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack.com%2Fimg%2Favatars%2Fgreen.png" sizes="32px" alt="FeepingCreature's avatar" srcset="https://substackcdn.com/image/fetch/$s_!DFX4!,w_32,h_32,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack.com%2Fimg%2Favatars%2Fgreen.png 32w, https://substackcdn.com/image/fetch/$s_!DFX4!,w_64,h_64,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack.com%2Fimg%2Favatars%2Fgreen.png 64w, https://substackcdn.com/image/fetch/$s_!DFX4!,w_96,h_96,c_fill,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack.com%2Fimg%2Favatars%2Fgreen.png 96w" width="32" height="32" draggable="false" class="img-OACg1c object-fit-cover-u4ReeV pencraft pc-reset"/></picture></div></div></a></div><div class="pencraft pc-display-flex pc-flexDirection-column pc-reset flex-grow-rzmknG"><div class="pencraft pc-display-flex pc-reset"><div class="pencraft pc-display-flex pc-flexDirection-column pc-gap-4 pc-reset"><div class="pencraft pc-display-flex pc-minWidth-0 pc-gap-8 pc-alignItems-center pc-height-20 pc-reset line-height-20-t4M0El font-text-qe4AeH size-15-Psle70 weight-regular-mUq6Gb"><div class="pencraft pc-display-flex pc-minWidth-0 pc-gap-8 pc-alignItems-center pc-reset flex-grow-rzmknG"><div class="pencraft pc-display-flex pc-gap-6 pc-reset color-primary-zABazT line-height-20-t4M0El font-text-qe4AeH size-13-hZTUKr weight-regular-mUq6Gb reset-IxiVJZ"><span class="pencraft pc-reset line-height-20-t4M0El font-text-qe4AeH size-15-Psle70 weight-medium-fw81nC reset-IxiVJZ"><span style="min-width:0;" data-state="closed"><span class="pencraft pc-reset decoration-hover-underline-ClDVRM reset-IxiVJZ"><a href="https://substack.com/profile/11057353-feepingcreature?utm_source=substack-feed-item" showBack data-native="true" class="link-LIBpto">FeepingCreature</a></span></span> </span></div><a data-native="true" href="https://www.thonking.ai/p/what-shapes-do-matrix-multiplications/comment/75778790" rel="nofollow" title="Nov 6, 2024, 1:32 PM" class="pencraft pc-reset color-secondary-ls1g8s decoration-hover-underline-ClDVRM reset-IxiVJZ"><span class="pencraft pc-reset color-secondary-ls1g8s line-height-20-t4M0El font-text-qe4AeH size-13-hZTUKr weight-regular-mUq6Gb reset-IxiVJZ">Nov 6, 2024</span></a></div></div></div><div class="pencraft pc-display-flex pc-flexDirection-column pc-reset flex-grow-rzmknG"></div><div class="pencraft pc-display-flex pc-reset triggerContainer-eX588u"><button tabindex="0" type="button" aria-label="Ellipsis" id="radix-P0-86" aria-haspopup="menu" aria-expanded="false" data-state="closed" class="pencraft pc-reset pencraft trigger-j08Uop iconButton-mq_Et5 iconButtonBase-dJGHgN buttonBase-GK1x3M buttonStyle-r7yGCK size_sm-G3LciD priority_quaternary-kpMibu"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ellipsis"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg></button></div></div><div class="comment-body expanded"><p><span>It seems a lot closer on AMD/ROCM: <a href="https://imgur.com/a/iEv8Lu7" target="_blank" rel="nofollow ugc noopener" class="linkified">https://imgur.com/a/iEv8Lu7</a> (No torch.compile) They probably always do size optimization to some extent. <a href="https://gist.github.com/FeepingCreature/aec0e569e83a436bed7f4516263cd9fc" target="_blank" rel="nofollow ugc noopener" class="linkified">https://gist.github.com/FeepingCreature/aec0e569e83a436bed7f4516263cd9fc</a> Code I had Sonnet make me.</span></p></div><div class="pencraft pc-display-flex pc-gap-16 pc-paddingTop-8 pc-justifyContent-flex-start pc-alignItems-center pc-reset comment-actions withShareButton-hQzuEn"><span class="pencraft pc-reset decoration-hover-underline-ClDVRM reset-IxiVJZ"><a class="pencraft pc-reset link-_X6et2 link-LIBpto"><div class="pencraft pc-display-flex pc-gap-6 pc-alignItems-center pc-reset"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-fg-secondary-themed)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-circle"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"></path></svg><div class="pencraft pc-reset color-pub-secondary-text-hGQ02T line-height-20-t4M0El font-meta-MWBumP size-11-NuY2Zx weight-medium-fw81nC transform-uppercase-yKDgcq reset-IxiVJZ meta-EgzBVA">Reply</div></div></a></span><span class="pencraft pc-reset decoration-hover-underline-ClDVRM reset-IxiVJZ"><a class="pencraft pc-reset link-_X6et2 link-LIBpto"><div class="pencraft pc-display-flex pc-gap-6 pc-alignItems-center pc-reset"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-fg-secondary-themed)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-share"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" x2="12" y1="2" y2="15"></line></svg><div class="pencraft pc-reset color-pub-secondary-text-hGQ02T line-height-20-t4M0El font-meta-MWBumP size-11-NuY2Zx weight-medium-fw81nC transform-uppercase-yKDgcq reset-IxiVJZ meta-EgzBVA">Share</div></div></a></span></div><div data-state="closed" class="pencraft pc-display-flex pc-flexDirection-column pc-reset overflow-hidden-WdpwT6"></div></div></div></div></div></div></div></div></div><div class="single-post-section"><div class="container"><div class="visibility-check"></div><div style="margin-left:-8px;margin-right:-8px;" aria-label="Top Posts Footer" role="region" class="pencraft pc-paddingTop-24 pc-paddingBottom-24 pc-reset"><div class="portable-archive empty-list"><div aria-label="Archive sort tabs" role="navigation" class="pencraft pc-display-flex pc-gap-12 pc-paddingLeft-8 pc-paddingRight-8 pc-paddingBottom-16 pc-justifyContent-space-between pc-alignItems-center pc-reset"><div class="pencraft pc-display-flex pc-flexDirection-column pc-position-relative pc-minWidth-0 pc-reset bg-primary-zk6FDl outline-detail-vcQLyr pc-borderRadius-sm overflow-hidden-WdpwT6"><div dir="ltr" data-orientation="horizontal" class="pencraft pc-display-flex pc-flexDirection-column pc-reset flex-grow-rzmknG"><div style="outline:none;" tabindex="-1" aria-label="Tabs" role="tablist" aria-orientation="horizontal" data-orientation="horizontal" class="pencraft pc-display-flex pc-gap-4 pc-padding-4 pc-position-relative pc-reset cursor-default-flE2S1 pc-borderRadius-sm overflow-auto-7WTsTi scrollBar-hidden-HcAIpI"><button tabindex="-1" type="button" role="tab" aria-selected="true" aria-controls="radix-P0-95-content-top" data-state="active" id="radix-P0-95-trigger-top" data-orientation="horizontal" data-radix-collection-item class="pencraft pc-reset flex-auto-j3S2WA pencraft segment-j4TeZ4 buttonBase-GK1x3M buttonText-X0uSmG buttonStyle-r7yGCK priority_quaternary-kpMibu size_sm-G3LciD">Top</button><button tabindex="-1" type="button" role="tab" aria-selected="false" aria-controls="radix-P0-95-content-new" data-state="inactive" id="radix-P0-95-trigger-new" data-orientation="horizontal" data-radix-collection-item class="pencraft pc-reset flex-auto-j3S2WA pencraft segment-j4TeZ4 buttonBase-GK1x3M buttonText-X0uSmG buttonStyle-r7yGCK priority_quaternary-kpMibu size_sm-G3LciD">Latest</button><button tabindex="-1" type="button" role="tab" aria-selected="false" aria-controls="radix-P0-95-content-community" data-state="inactive" id="radix-P0-95-trigger-community" data-orientation="horizontal" data-radix-collection-item class="pencraft pc-reset flex-auto-j3S2WA pencraft segment-j4TeZ4 buttonBase-GK1x3M buttonText-X0uSmG buttonStyle-r7yGCK priority_quaternary-kpMibu size_sm-G3LciD">Discussions</button><div class="pencraft pc-position-absolute pc-height-32 pc-reset bg-secondary-UUD3_J pc-borderRadius-xs sizing-border-box-DggLA4 highlight-U002IP"></div></div></div><div class="pencraft pc-display-flex pc-alignItems-center pc-reset arrowButtonContainer-O4uSiH arrowButtonOverlaidContainer-t10AyH left-Tg8vqp"><div class="overlay-zrMCxn primary-lv_sOW"></div></div><div class="pencraft pc-display-flex pc-alignItems-center pc-reset arrowButtonContainer-O4uSiH arrowButtonOverlaidContainer-t10AyH right-i3oWGi"><div class="overlay-zrMCxn primary-lv_sOW"></div></div></div><button tabindex="0" type="button" aria-label="Search" class="pencraft pc-reset pencraft iconButton-mq_Et5 iconButtonBase-dJGHgN buttonBase-GK1x3M buttonStyle-r7yGCK size_md-gCDS3o priority_tertiary-rlke8z"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg></button></div><div class="portable-archive-list"><p class="portable-archive-empty">No posts</p></div></div></div></div></div><div class="visibility-check"></div><div class="pencraft pc-display-contents pc-reset pubInvertedTheme-U483dz"><div class="pencraft pc-display-flex pc-flexDirection-column pc-alignItems-center pc-justifyContent-center pc-padding-48 pc-mobile-padding-24 pc-reset bg-primary-zk6FDl container-jsOc9L"><div class="pencraft pc-display-flex pc-flexDirection-column pc-alignItems-center pc-gap-24 pc-flexWrap-wrap pc-reset content-jLbYeh"><h3 class="pencraft pc-reset color-primary-zABazT align-center-y7ZD4w line-height-28-s562kJ font-display-nhmvtD size-24-lFU3ly weight-semibold-uqA4FV reset-IxiVJZ">Ready for more?</h3><div class="container-IpPqBD"><form action="/api/v1/free?nojs=true" method="post" novalidate class="form form-M5sC90"><input type="hidden" name="first_url" value/><input type="hidden" name="first_referrer" value/><input type="hidden" name="current_url"/><input type="hidden" name="current_referrer"/><input type="hidden" name="first_session_url" value/><input type="hidden" name="first_session_referrer" value/><input type="hidden" name="referral_code"/><input type="hidden" name="source" value="subscribe_footer"/><input type="hidden" name="referring_pub_id"/><input type="hidden" name="additional_referring_pub_ids"/><div class="sideBySideWrap-vGXrwP"><div class="emailInputWrapper-QlA86j"><div class="pencraft pc-display-flex pc-minWidth-0 pc-position-relative pc-reset flex-auto-j3S2WA"><input name="email" placeholder="Type your email..." type="email" class="pencraft emailInput-OkIMeB emailInputOnAccentBackground-TfaCGr input-y4v6N4 inputText-pV_yWb"/></div></div><button tabindex="0" type="submit" disabled class="pencraft pc-reset pencraft rightButton primary subscribe-btn button-VFSdkv buttonOnAccentBackground-vmEt94 buttonBase-GK1x3M"><span class="button-text ">Subscribe</span></button></div><div id="error-container"></div></form></div></div></div></div></div></div></div><div class="footer-wrap publication-footer"><div class="visibility-check"></div><div class="footer themed-background"><div class="container"><div class="footer-terms"><span>© 2026 Horace He</span><span> · </span><a href="https://substack.com/privacy" target="_blank" rel="noopener" class="pencraft pc-reset decoration-underline-ClTkYc">Privacy</a><span> ∙ </span><a href="https://substack.com/tos" target="_blank" rel="noopener" class="pencraft pc-reset decoration-underline-ClTkYc">Terms</a><span> ∙ </span><a href="https://substack.com/ccpa#personal-data-collected" target="_blank" rel="noopener" class="pencraft pc-reset decoration-underline-ClTkYc">Collection notice</a></div><div class="pencraft pc-display-flex pc-gap-8 pc-justifyContent-center pc-alignItems-center pc-reset footerButtons-ap9Sk7"><a data-native="true" href="https://substack.com/signup?utm_source=substack&amp;utm_medium=web&amp;utm_content=footer" class="footerSubstackCta-v5HWfj"><svg role="img" width="1000" height="1000" viewBox="0 0 1000 1000" fill="#ff6719" stroke-width="1.8" stroke="none" xmlns="http://www.w3.org/2000/svg"><g><title></title><path d="M764.166 348.371H236.319V419.402H764.166V348.371Z"></path><path d="M236.319 483.752V813.999L500.231 666.512L764.19 813.999V483.752H236.319Z"></path><path d="M764.166 213H236.319V284.019H764.166V213Z"></path></g></svg> Start your Substack</a><a data-native="true" href="https://substack.com/app/app-store-redirect?utm_campaign=app-marketing&amp;utm_content=web-footer-button" class="footerSubstackCta-v5HWfj getTheApp-Yk3w1O noIcon-z7v9D8">Get the app</a></div><div translated class="pencraft pc-reset reset-IxiVJZ footer-slogan-blurb"><a href="https://substack.com" data-native="true">Substack</a> is the home for great culture</div></div></div></div></div><div role="region" aria-label="Notifications (F8)" tabindex="-1" style="pointer-events:none;"><ol tabindex="-1" style="--offset:0px;z-index:1000;" class="viewport-_BM4Bg"></ol></div><div></div>
        </div>

        
            <script src="https://js.sentry-cdn.com/6c2ff3e3828e4017b7faf7b63e24cdf8.min.js" crossorigin="anonymous"></script>
            <script>
                window.Sentry && window.Sentry.onLoad(function() {
                    window.Sentry.init({
                        environment: window._preloads.sentry_environment,
                        dsn: window._preloads.sentry_dsn,
                    })
                })
            </script>
        


        
        
        
        
        <script>window._preloads        = JSON.parse("{\"isEU\":false,\"language\":\"en\",\"country\":\"US\",\"userLocale\":{\"language\":\"en\",\"region\":\"US\",\"source\":\"default\"},\"base_url\":\"https://www.thonking.ai\",\"stripe_publishable_key\":\"pk_live_51QfnARLDSWi1i85FBpvw6YxfQHljOpWXw8IKi5qFWEzvW8HvoD8cqTulR9UWguYbYweLvA16P7LN6WZsGdZKrNkE00uGbFaOE3\",\"captcha_site_key\":\"6LdYbsYZAAAAAIFIRh8X_16GoFRLIReh-e-q6qSa\",\"pub\":{\"apple_pay_disabled\":false,\"apex_domain\":\"thonking.ai\",\"author_id\":1514868,\"byline_images_enabled\":true,\"bylines_enabled\":true,\"chartable_token\":null,\"community_enabled\":true,\"copyright\":\"Horace He\",\"cover_photo_url\":null,\"created_at\":\"2023-07-06T02:56:13.729Z\",\"custom_domain_optional\":false,\"custom_domain\":\"www.thonking.ai\",\"default_comment_sort\":\"best_first\",\"default_coupon\":null,\"default_group_coupon\":null,\"default_show_guest_bios\":true,\"email_banner_url\":\"https://substack-post-media.s3.amazonaws.com/public/images/046f772b-6027-46eb-ba9f-77415416de17_1210x438.png\",\"email_from_name\":null,\"email_from\":null,\"embed_tracking_disabled\":false,\"explicit\":false,\"expose_paywall_content_to_search_engines\":true,\"fb_pixel_id\":null,\"fb_site_verification_token\":null,\"flagged_as_spam\":false,\"founding_subscription_benefits\":[\"My gratitude and even more pressure for me to write!\"],\"free_subscription_benefits\":[\"Occasional public posts\"],\"ga_pixel_id\":null,\"google_site_verification_token\":null,\"google_tag_manager_token\":null,\"hero_image\":null,\"hero_text\":\"ML Systems from first principles. Aims to be better than a ChatGPT summary.\",\"hide_intro_subtitle\":null,\"hide_intro_title\":null,\"hide_podcast_feed_link\":false,\"homepage_type\":\"newspaper\",\"id\":1781836,\"image_thumbnails_always_enabled\":false,\"invite_only\":false,\"hide_podcast_from_pub_listings\":false,\"language\":\"en\",\"logo_url_wide\":null,\"logo_url\":\"https://substackcdn.com/image/fetch/$s_!WNJs!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55e3b22f-cc6b-438a-be3d-8d17cc97c2f9_750x750.png\",\"minimum_group_size\":2,\"moderation_enabled\":true,\"name\":\"Thonk From First Principles\",\"paid_subscription_benefits\":[\"Pressures me to write more :)\",\"Answer key to quiz questions! (you can expense it too!)\",\"Note: If you make an attempt at solving the quiz questions (and email me) I will also share the answer key\"],\"parsely_pixel_id\":null,\"chartbeat_domain\":null,\"payments_state\":\"enabled\",\"paywall_free_trial_enabled\":true,\"podcast_art_url\":null,\"paid_podcast_episode_art_url\":null,\"podcast_byline\":null,\"podcast_description\":null,\"podcast_enabled\":false,\"podcast_feed_url\":null,\"podcast_title\":null,\"post_preview_limit\":null,\"primary_user_id\":1514868,\"require_clickthrough\":false,\"show_pub_podcast_tab\":false,\"show_recs_on_homepage\":true,\"subdomain\":\"thonking\",\"subscriber_invites\":0,\"support_email\":null,\"theme_var_background_pop\":\"#99A2F1\",\"theme_var_color_links\":true,\"theme_var_cover_bg_color\":null,\"trial_end_override\":null,\"twitter_pixel_id\":null,\"type\":\"newsletter\",\"post_reaction_faces_enabled\":true,\"is_personal_mode\":false,\"plans\":[{\"id\":\"yearly80usd\",\"object\":\"plan\",\"active\":true,\"aggregate_usage\":null,\"amount\":8000,\"amount_decimal\":\"8000\",\"billing_scheme\":\"per_unit\",\"created\":1708981508,\"currency\":\"usd\",\"interval\":\"year\",\"interval_count\":1,\"livemode\":true,\"metadata\":{\"substack\":\"yes\"},\"meter\":null,\"nickname\":\"$80 a year\",\"product\":\"prod_PdSGqNkPBRhC3o\",\"tiers\":null,\"tiers_mode\":null,\"transform_usage\":null,\"trial_period_days\":null,\"usage_type\":\"licensed\",\"currency_options\":{\"aud\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":12000,\"unit_amount_decimal\":\"12000\"},\"brl\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":44500,\"unit_amount_decimal\":\"44500\"},\"cad\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":11000,\"unit_amount_decimal\":\"11000\"},\"chf\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":6500,\"unit_amount_decimal\":\"6500\"},\"dkk\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":51000,\"unit_amount_decimal\":\"51000\"},\"eur\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":7000,\"unit_amount_decimal\":\"7000\"},\"gbp\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":6000,\"unit_amount_decimal\":\"6000\"},\"mxn\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":144500,\"unit_amount_decimal\":\"144500\"},\"nok\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":81000,\"unit_amount_decimal\":\"81000\"},\"nzd\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":14000,\"unit_amount_decimal\":\"14000\"},\"pln\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":29000,\"unit_amount_decimal\":\"29000\"},\"sek\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":74000,\"unit_amount_decimal\":\"74000\"},\"usd\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":8000,\"unit_amount_decimal\":\"8000\"}}},{\"id\":\"monthly8usd\",\"object\":\"plan\",\"active\":true,\"aggregate_usage\":null,\"amount\":800,\"amount_decimal\":\"800\",\"billing_scheme\":\"per_unit\",\"created\":1708981508,\"currency\":\"usd\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":true,\"metadata\":{\"substack\":\"yes\"},\"meter\":null,\"nickname\":\"$8 a month\",\"product\":\"prod_PdSG77cpytHJPj\",\"tiers\":null,\"tiers_mode\":null,\"transform_usage\":null,\"trial_period_days\":null,\"usage_type\":\"licensed\",\"currency_options\":{\"aud\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":1200,\"unit_amount_decimal\":\"1200\"},\"brl\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":4500,\"unit_amount_decimal\":\"4500\"},\"cad\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":1100,\"unit_amount_decimal\":\"1100\"},\"chf\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":700,\"unit_amount_decimal\":\"700\"},\"dkk\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":5500,\"unit_amount_decimal\":\"5500\"},\"eur\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":700,\"unit_amount_decimal\":\"700\"},\"gbp\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":600,\"unit_amount_decimal\":\"600\"},\"mxn\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":14500,\"unit_amount_decimal\":\"14500\"},\"nok\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":8500,\"unit_amount_decimal\":\"8500\"},\"nzd\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":1400,\"unit_amount_decimal\":\"1400\"},\"pln\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":2900,\"unit_amount_decimal\":\"2900\"},\"sek\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":7500,\"unit_amount_decimal\":\"7500\"},\"usd\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":800,\"unit_amount_decimal\":\"800\"}}},{\"id\":\"founding24000usd\",\"name\":\"founding24000usd\",\"nickname\":\"founding24000usd\",\"active\":true,\"amount\":24000,\"currency\":\"usd\",\"interval\":\"year\",\"interval_count\":1,\"metadata\":{\"substack\":\"yes\",\"founding\":\"yes\",\"no_coupons\":\"yes\",\"short_description\":\"Founding Member\",\"short_description_english\":\"Founding Member\",\"minimum\":\"8000\",\"minimum_local\":{\"aud\":11500,\"brl\":41500,\"cad\":11000,\"chf\":6500,\"dkk\":51000,\"eur\":7000,\"gbp\":6000,\"mxn\":137500,\"nok\":76500,\"nzd\":13500,\"pln\":29000,\"sek\":72500,\"usd\":8000}},\"currency_options\":{\"aud\":{\"unit_amount\":34000,\"tax_behavior\":\"unspecified\"},\"brl\":{\"unit_amount\":124500,\"tax_behavior\":\"unspecified\"},\"cad\":{\"unit_amount\":33000,\"tax_behavior\":\"unspecified\"},\"chf\":{\"unit_amount\":19000,\"tax_behavior\":\"unspecified\"},\"dkk\":{\"unit_amount\":152500,\"tax_behavior\":\"unspecified\"},\"eur\":{\"unit_amount\":20500,\"tax_behavior\":\"unspecified\"},\"gbp\":{\"unit_amount\":18000,\"tax_behavior\":\"unspecified\"},\"mxn\":{\"unit_amount\":411500,\"tax_behavior\":\"unspecified\"},\"nok\":{\"unit_amount\":229000,\"tax_behavior\":\"unspecified\"},\"nzd\":{\"unit_amount\":40500,\"tax_behavior\":\"unspecified\"},\"pln\":{\"unit_amount\":86000,\"tax_behavior\":\"unspecified\"},\"sek\":{\"unit_amount\":217500,\"tax_behavior\":\"unspecified\"},\"usd\":{\"unit_amount\":24000,\"tax_behavior\":\"unspecified\"}}}],\"stripe_user_id\":\"acct_1OoBIEEmmUfQ69ag\",\"stripe_country\":\"US\",\"stripe_publishable_key\":\"pk_live_51OoBIEEmmUfQ69agXvFHCHI1WHB681usw1g6iLp40jJxQZM8FdnGlJpKOZzGQ3VAxBj4GR90yMAgtmpPXhpVXGrG00h2CYkdbG\",\"stripe_platform_account\":\"US\",\"automatic_tax_enabled\":false,\"author_name\":\"Horace He\",\"author_handle\":\"chilli\",\"author_photo_url\":\"https://substackcdn.com/image/fetch/$s_!acf6!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc8ac060-6949-4a91-b6b5-88460efd08bc_144x144.png\",\"author_bio\":null,\"has_custom_tos\":false,\"has_custom_privacy\":false,\"theme\":{\"background_pop_color\":null,\"web_bg_color\":null,\"cover_bg_color\":null,\"home_hero\":\"newspaper\",\"home_posts\":\"list\"},\"threads_v2_settings\":null,\"default_group_coupon_percent_off\":null,\"pause_return_date\":null,\"has_posts\":true,\"has_recommendations\":true,\"first_post_date\":\"2024-02-26T21:09:39.622Z\",\"has_podcast\":false,\"has_free_podcast\":false,\"has_subscriber_only_podcast\":false,\"has_community_content\":true,\"rankingDetail\":\"Launched 2 years ago\",\"rankingDetailFreeIncluded\":\"Thousands of subscribers\",\"rankingDetailOrderOfMagnitude\":10,\"rankingDetailFreeIncludedOrderOfMagnitude\":1000,\"rankingDetailFreeSubscriberCount\":\"Over 3,000 subscribers\",\"rankingDetailByLanguage\":{\"ca\":{\"rankingDetail\":\"S\u2019ha llan\u00E7at fa 2 anys\",\"rankingDetailFreeIncluded\":\"Milers de subscriptors\",\"rankingDetailOrderOfMagnitude\":10,\"rankingDetailFreeIncludedOrderOfMagnitude\":1000,\"rankingDetailFreeSubscriberCount\":\"M\u00E9s de 3,000 subscriptors\",\"freeSubscriberCount\":\"3,000\",\"freeSubscriberCountOrderOfMagnitude\":\"3.6K+\"},\"da\":{\"rankingDetail\":\"Lancering 2 \u00E5r\",\"rankingDetailFreeIncluded\":\"Tusindvis af abonnenter\",\"rankingDetailOrderOfMagnitude\":10,\"rankingDetailFreeIncludedOrderOfMagnitude\":1000,\"rankingDetailFreeSubscriberCount\":\"Over 3,000 abonnenter\",\"freeSubscriberCount\":\"3,000\",\"freeSubscriberCountOrderOfMagnitude\":\"3.6K+\"},\"de\":{\"rankingDetail\":\"Vor vor 2 Jahren gelauncht\",\"rankingDetailFreeIncluded\":\"Tausende von Abonnenten\",\"rankingDetailOrderOfMagnitude\":10,\"rankingDetailFreeIncludedOrderOfMagnitude\":1000,\"rankingDetailFreeSubscriberCount\":\"\u00DCber 3,000 Abonnenten\",\"freeSubscriberCount\":\"3,000\",\"freeSubscriberCountOrderOfMagnitude\":\"3.6K+\"},\"es\":{\"rankingDetail\":\"Lanzado hace 2 a\u00F1os\",\"rankingDetailFreeIncluded\":\"Miles de suscriptores\",\"rankingDetailOrderOfMagnitude\":10,\"rankingDetailFreeIncludedOrderOfMagnitude\":1000,\"rankingDetailFreeSubscriberCount\":\"M\u00E1s de 3,000 suscriptores\",\"freeSubscriberCount\":\"3,000\",\"freeSubscriberCountOrderOfMagnitude\":\"3.6K+\"},\"fr\":{\"rankingDetail\":\"Lanc\u00E9 il y a 2 ann\u00E9es\",\"rankingDetailFreeIncluded\":\"Des milliers d'abonn\u00E9s\",\"rankingDetailOrderOfMagnitude\":10,\"rankingDetailFreeIncludedOrderOfMagnitude\":1000,\"rankingDetailFreeSubscriberCount\":\"Plus de 3,000 abonn\u00E9s\",\"freeSubscriberCount\":\"3,000\",\"freeSubscriberCountOrderOfMagnitude\":\"3.6K+\"},\"ja\":{\"rankingDetail\":\"\u958B\u59CB\u65E5 2\u5E74\u524D\",\"rankingDetailFreeIncluded\":\"\u767B\u9332\u8005\u6570\u6570\u5343\u4EBA\",\"rankingDetailOrderOfMagnitude\":10,\"rankingDetailFreeIncludedOrderOfMagnitude\":1000,\"rankingDetailFreeSubscriberCount\":\"3,000 \u540D\u4EE5\u4E0A\u306E\u8CFC\u8AAD\u8005\",\"freeSubscriberCount\":\"3,000\",\"freeSubscriberCountOrderOfMagnitude\":\"3.6K+\"},\"nb\":{\"rankingDetail\":\"Lansert 2 \u00E5r\",\"rankingDetailFreeIncluded\":\"Tusenvis av abonnenter\",\"rankingDetailOrderOfMagnitude\":10,\"rankingDetailFreeIncludedOrderOfMagnitude\":1000,\"rankingDetailFreeSubscriberCount\":\"Over 3,000 abonnenter\",\"freeSubscriberCount\":\"3,000\",\"freeSubscriberCountOrderOfMagnitude\":\"3.6K+\"},\"nl\":{\"rankingDetail\":\"Gelanceerd 2 jaar geleden\",\"rankingDetailFreeIncluded\":\"Duizenden abonnees\",\"rankingDetailOrderOfMagnitude\":10,\"rankingDetailFreeIncludedOrderOfMagnitude\":1000,\"rankingDetailFreeSubscriberCount\":\"Meer dan 3,000 abonnees\",\"freeSubscriberCount\":\"3,000\",\"freeSubscriberCountOrderOfMagnitude\":\"3.6K+\"},\"pl\":{\"rankingDetail\":\"Uruchomiono 2 lat temu\",\"rankingDetailFreeIncluded\":\"Tysi\u0105ce subskrybent\u00F3w\",\"rankingDetailOrderOfMagnitude\":10,\"rankingDetailFreeIncludedOrderOfMagnitude\":1000,\"rankingDetailFreeSubscriberCount\":\"Ponad 3,000 subskrybent\u00F3w\",\"freeSubscriberCount\":\"3,000\",\"freeSubscriberCountOrderOfMagnitude\":\"3.6K+\"},\"pt\":{\"rankingDetail\":\"Lan\u00E7ado 2 anos\",\"rankingDetailFreeIncluded\":\"Milhares de subscritores\",\"rankingDetailOrderOfMagnitude\":10,\"rankingDetailFreeIncludedOrderOfMagnitude\":1000,\"rankingDetailFreeSubscriberCount\":\"Mais de 3,000 subscritores\",\"freeSubscriberCount\":\"3,000\",\"freeSubscriberCountOrderOfMagnitude\":\"3.6K+\"},\"pt-br\":{\"rankingDetail\":\"Lan\u00E7ado 2 anos\",\"rankingDetailFreeIncluded\":\"Milhares de assinantes\",\"rankingDetailOrderOfMagnitude\":10,\"rankingDetailFreeIncludedOrderOfMagnitude\":1000,\"rankingDetailFreeSubscriberCount\":\"Mais de 3,000 assinantes\",\"freeSubscriberCount\":\"3,000\",\"freeSubscriberCountOrderOfMagnitude\":\"3.6K+\"},\"it\":{\"rankingDetail\":\"Lanciato 2 anni\",\"rankingDetailFreeIncluded\":\"Migliaia di abbonati\",\"rankingDetailOrderOfMagnitude\":10,\"rankingDetailFreeIncludedOrderOfMagnitude\":1000,\"rankingDetailFreeSubscriberCount\":\"Oltre 3,000 abbonati\",\"freeSubscriberCount\":\"3,000\",\"freeSubscriberCountOrderOfMagnitude\":\"3.6K+\"},\"tr\":{\"rankingDetail\":\"2 y\u0131l ba\u015Flat\u0131ld\u0131\",\"rankingDetailFreeIncluded\":\"Binlerce abone\",\"rankingDetailOrderOfMagnitude\":10,\"rankingDetailFreeIncludedOrderOfMagnitude\":1000,\"rankingDetailFreeSubscriberCount\":\"3,000'in \u00FCzerinde abone\",\"freeSubscriberCount\":\"3,000\",\"freeSubscriberCountOrderOfMagnitude\":\"3.6K+\"},\"sv\":{\"rankingDetail\":\"Lanserad 2 \u00E5r sedan\",\"rankingDetailFreeIncluded\":\"Tusentals prenumeranter\",\"rankingDetailOrderOfMagnitude\":10,\"rankingDetailFreeIncludedOrderOfMagnitude\":1000,\"rankingDetailFreeSubscriberCount\":\"\u00D6ver 3,000 prenumeranter\",\"freeSubscriberCount\":\"3,000\",\"freeSubscriberCountOrderOfMagnitude\":\"3.6K+\"},\"en\":{\"rankingDetail\":\"Launched 2 years ago\",\"rankingDetailFreeIncluded\":\"Thousands of subscribers\",\"rankingDetailOrderOfMagnitude\":10,\"rankingDetailFreeIncludedOrderOfMagnitude\":1000,\"rankingDetailFreeSubscriberCount\":\"Over 3,000 subscribers\",\"freeSubscriberCount\":\"3,000\",\"freeSubscriberCountOrderOfMagnitude\":\"3.6K+\"}},\"freeSubscriberCount\":\"3,000\",\"freeSubscriberCountOrderOfMagnitude\":\"3.6K+\",\"author_bestseller_tier\":0,\"author_badge\":{\"type\":\"subscriber\",\"tier\":1,\"accent_colors\":null},\"disable_monthly_subscriptions\":false,\"disable_annual_subscriptions\":false,\"hide_post_restacks\":false,\"notes_feed_enabled\":false,\"showIntroModule\":false,\"isPortraitLayout\":false,\"last_chat_post_at\":null,\"primary_profile_name\":\"Horace He\",\"primary_profile_photo_url\":\"https://substackcdn.com/image/fetch/$s_!acf6!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffc8ac060-6949-4a91-b6b5-88460efd08bc_144x144.png\",\"no_follow\":false,\"paywall_chat\":\"free\",\"sections\":[],\"multipub_migration\":null,\"navigationBarItems\":[],\"contributors\":[{\"name\":\"Horace He\",\"handle\":\"chilli\",\"role\":\"admin\",\"owner\":true,\"user_id\":1514868,\"photo_url\":\"https://substack-post-media.s3.amazonaws.com/public/images/fc8ac060-6949-4a91-b6b5-88460efd08bc_144x144.png\",\"bio\":null}],\"threads_v2_enabled\":false,\"viralGiftsConfig\":{\"id\":\"44380009-fb0a-44f9-b486-f9200db9a050\",\"publication_id\":1781836,\"enabled\":true,\"gifts_per_user\":5,\"gift_length_months\":1,\"send_extra_gifts\":true,\"message\":\"ML Systems from first principles. Better than a ChatGPT summary.\",\"created_at\":\"2024-02-26T21:05:52.367984+00:00\",\"updated_at\":\"2024-02-26T21:05:52.367984+00:00\",\"days_til_invite\":14,\"send_emails\":true,\"show_link\":null,\"grant_email_body\":null,\"grant_email_subject\":null},\"tier\":2,\"no_index\":false,\"can_set_google_site_verification\":true,\"can_have_sitemap\":true,\"draft_iap_advanced_plans\":[{\"sku\":\"tmv2e0ict4DfUyHwmv\",\"publication_id\":\"1781836\",\"is_active\":true,\"price_base_units\":11000,\"currency_alpha3\":\"usd\",\"period\":\"year\",\"created_at\":\"2025-08-18T15:53:58.694Z\",\"updated_at\":\"2025-08-18T15:53:58.694Z\",\"id\":\"363710\",\"payout_amount_base_units\":800,\"alternate_currencies\":{\"aud\":17000,\"brl\":59500,\"cad\":15500,\"chf\":9000,\"dkk\":70500,\"eur\":9500,\"gbp\":8500,\"mxn\":206000,\"nok\":112000,\"nzd\":19000,\"pln\":40000,\"sek\":105000},\"is_founding\":false,\"display_name\":\"Thonk From First Principles (Yearly)\",\"display_price\":\"$110\"},{\"sku\":\"LPGgg5WgCD8RrgBkVq\",\"publication_id\":\"1781836\",\"is_active\":true,\"price_base_units\":1100,\"currency_alpha3\":\"usd\",\"period\":\"month\",\"created_at\":\"2025-08-18T15:53:58.683Z\",\"updated_at\":\"2025-08-18T15:53:58.683Z\",\"id\":\"363709\",\"payout_amount_base_units\":80,\"alternate_currencies\":{\"aud\":1700,\"brl\":6000,\"cad\":1600,\"chf\":900,\"dkk\":7500,\"eur\":1000,\"gbp\":900,\"mxn\":21000,\"nok\":11500,\"nzd\":1900,\"pln\":4000,\"sek\":10500},\"is_founding\":false,\"display_name\":\"Thonk From First Principles (Monthly)\",\"display_price\":\"$11\"}],\"iap_advanced_plans\":[{\"sku\":\"tmv2e0ict4DfUyHwmv\",\"publication_id\":\"1781836\",\"is_active\":true,\"price_base_units\":11000,\"currency_alpha3\":\"usd\",\"period\":\"year\",\"created_at\":\"2025-08-18T15:53:58.694Z\",\"updated_at\":\"2025-08-18T15:53:58.694Z\",\"id\":\"363710\",\"payout_amount_base_units\":800,\"alternate_currencies\":{\"aud\":17000,\"brl\":59500,\"cad\":15500,\"chf\":9000,\"dkk\":70500,\"eur\":9500,\"gbp\":8500,\"mxn\":206000,\"nok\":112000,\"nzd\":19000,\"pln\":40000,\"sek\":105000},\"is_founding\":false,\"display_name\":\"Thonk From First Principles (Yearly)\",\"display_price\":\"$110\"},{\"sku\":\"LPGgg5WgCD8RrgBkVq\",\"publication_id\":\"1781836\",\"is_active\":true,\"price_base_units\":1100,\"currency_alpha3\":\"usd\",\"period\":\"month\",\"created_at\":\"2025-08-18T15:53:58.683Z\",\"updated_at\":\"2025-08-18T15:53:58.683Z\",\"id\":\"363709\",\"payout_amount_base_units\":80,\"alternate_currencies\":{\"aud\":1700,\"brl\":6000,\"cad\":1600,\"chf\":900,\"dkk\":7500,\"eur\":1000,\"gbp\":900,\"mxn\":21000,\"nok\":11500,\"nzd\":1900,\"pln\":4000,\"sek\":10500},\"is_founding\":false,\"display_name\":\"Thonk From First Principles (Monthly)\",\"display_price\":\"$11\"}],\"founding_plan_name_english\":\"Founding Member\",\"iap_founding_plan\":{\"base_plan_id\":\"founding24000usd\",\"name\":\"Founding Member\",\"minimum_amount\":11000,\"suggested_amount\":33000,\"currency_alpha3\":\"usd\",\"alternate_currencies\":{\"aud\":{\"minimum_amount\":16000,\"suggested_amount\":47000},\"brl\":{\"minimum_amount\":57000,\"suggested_amount\":171000},\"cad\":{\"minimum_amount\":15500,\"suggested_amount\":45500},\"chf\":{\"minimum_amount\":9000,\"suggested_amount\":26000},\"dkk\":{\"minimum_amount\":70000,\"suggested_amount\":209500},\"eur\":{\"minimum_amount\":9500,\"suggested_amount\":28000},\"gbp\":{\"minimum_amount\":8500,\"suggested_amount\":24500},\"mxn\":{\"minimum_amount\":188500,\"suggested_amount\":565500},\"nok\":{\"minimum_amount\":105000,\"suggested_amount\":314500},\"nzd\":{\"minimum_amount\":18500,\"suggested_amount\":55500},\"pln\":{\"minimum_amount\":39500,\"suggested_amount\":118500},\"sek\":{\"minimum_amount\":100000,\"suggested_amount\":299000}}},\"draft_plans\":[{\"id\":\"yearly80usd\",\"object\":\"plan\",\"active\":true,\"aggregate_usage\":null,\"amount\":8000,\"amount_decimal\":\"8000\",\"billing_scheme\":\"per_unit\",\"created\":1708981508,\"currency\":\"usd\",\"interval\":\"year\",\"interval_count\":1,\"livemode\":true,\"metadata\":{\"substack\":\"yes\"},\"meter\":null,\"nickname\":\"$80 a year\",\"product\":\"prod_PdSGqNkPBRhC3o\",\"tiers\":null,\"tiers_mode\":null,\"transform_usage\":null,\"trial_period_days\":null,\"usage_type\":\"licensed\",\"currency_options\":{\"aud\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":12000,\"unit_amount_decimal\":\"12000\"},\"brl\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":44500,\"unit_amount_decimal\":\"44500\"},\"cad\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":11000,\"unit_amount_decimal\":\"11000\"},\"chf\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":6500,\"unit_amount_decimal\":\"6500\"},\"dkk\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":51000,\"unit_amount_decimal\":\"51000\"},\"eur\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":7000,\"unit_amount_decimal\":\"7000\"},\"gbp\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":6000,\"unit_amount_decimal\":\"6000\"},\"mxn\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":144500,\"unit_amount_decimal\":\"144500\"},\"nok\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":81000,\"unit_amount_decimal\":\"81000\"},\"nzd\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":14000,\"unit_amount_decimal\":\"14000\"},\"pln\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":29000,\"unit_amount_decimal\":\"29000\"},\"sek\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":74000,\"unit_amount_decimal\":\"74000\"},\"usd\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":8000,\"unit_amount_decimal\":\"8000\"}}},{\"id\":\"monthly8usd\",\"object\":\"plan\",\"active\":true,\"aggregate_usage\":null,\"amount\":800,\"amount_decimal\":\"800\",\"billing_scheme\":\"per_unit\",\"created\":1708981508,\"currency\":\"usd\",\"interval\":\"month\",\"interval_count\":1,\"livemode\":true,\"metadata\":{\"substack\":\"yes\"},\"meter\":null,\"nickname\":\"$8 a month\",\"product\":\"prod_PdSG77cpytHJPj\",\"tiers\":null,\"tiers_mode\":null,\"transform_usage\":null,\"trial_period_days\":null,\"usage_type\":\"licensed\",\"currency_options\":{\"aud\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":1200,\"unit_amount_decimal\":\"1200\"},\"brl\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":4500,\"unit_amount_decimal\":\"4500\"},\"cad\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":1100,\"unit_amount_decimal\":\"1100\"},\"chf\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":700,\"unit_amount_decimal\":\"700\"},\"dkk\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":5500,\"unit_amount_decimal\":\"5500\"},\"eur\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":700,\"unit_amount_decimal\":\"700\"},\"gbp\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":600,\"unit_amount_decimal\":\"600\"},\"mxn\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":14500,\"unit_amount_decimal\":\"14500\"},\"nok\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":8500,\"unit_amount_decimal\":\"8500\"},\"nzd\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":1400,\"unit_amount_decimal\":\"1400\"},\"pln\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":2900,\"unit_amount_decimal\":\"2900\"},\"sek\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":7500,\"unit_amount_decimal\":\"7500\"},\"usd\":{\"custom_unit_amount\":null,\"tax_behavior\":\"unspecified\",\"unit_amount\":800,\"unit_amount_decimal\":\"800\"}}},{\"id\":\"founding24000usd\",\"name\":\"founding24000usd\",\"nickname\":\"founding24000usd\",\"active\":true,\"amount\":24000,\"currency\":\"usd\",\"interval\":\"year\",\"interval_count\":1,\"metadata\":{\"substack\":\"yes\",\"founding\":\"yes\",\"no_coupons\":\"yes\",\"short_description\":\"Founding Member\",\"short_description_english\":\"Founding Member\",\"minimum\":\"8000\",\"minimum_local\":{\"aud\":11500,\"brl\":41500,\"cad\":11000,\"chf\":6500,\"dkk\":51000,\"eur\":7000,\"gbp\":6000,\"mxn\":137500,\"nok\":76500,\"nzd\":13500,\"pln\":29000,\"sek\":72500,\"usd\":8000}},\"currency_options\":{\"aud\":{\"unit_amount\":34000,\"tax_behavior\":\"unspecified\"},\"brl\":{\"unit_amount\":124500,\"tax_behavior\":\"unspecified\"},\"cad\":{\"unit_amount\":33000,\"tax_behavior\":\"unspecified\"},\"chf\":{\"unit_amount\":19000,\"tax_behavior\":\"unspecified\"},\"dkk\":{\"unit_amount\":152500,\"tax_behavior\":\"unspecified\"},\"eur\":{\"unit_amount\":20500,\"tax_behavior\":\"unspecified\"},\"gbp\":{\"unit_amount\":18000,\"tax_behavior\":\"unspecified\"},\"mxn\":{\"unit_amount\":411500,\"tax_behavior\":\"unspecified\"},\"nok\":{\"unit_amount\":229000,\"tax_behavior\":\"unspecified\"},\"nzd\":{\"unit_amount\":40500,\"tax_behavior\":\"unspecified\"},\"pln\":{\"unit_amount\":86000,\"tax_behavior\":\"unspecified\"},\"sek\":{\"unit_amount\":217500,\"tax_behavior\":\"unspecified\"},\"usd\":{\"unit_amount\":24000,\"tax_behavior\":\"unspecified\"}}}],\"bundles\":[],\"base_url\":\"https://www.thonking.ai\",\"hostname\":\"www.thonking.ai\",\"is_on_substack\":false,\"spotify_podcast_settings\":null,\"podcastPalette\":{\"DarkMuted\":{\"population\":72,\"rgb\":[73,153,137]},\"DarkVibrant\":{\"population\":6013,\"rgb\":[4,100,84]},\"LightMuted\":{\"population\":7,\"rgb\":[142,198,186]},\"LightVibrant\":{\"population\":3,\"rgb\":[166,214,206]},\"Muted\":{\"population\":6,\"rgb\":[92,164,156]},\"Vibrant\":{\"population\":5,\"rgb\":[76,164,146]}},\"pageThemes\":{\"podcast\":null},\"live_subscriber_counts\":false,\"supports_ip_content_unlock\":false,\"appTheme\":{\"colors\":{\"accent\":{\"name\":\"#99a2f1\",\"primary\":{\"r\":153,\"g\":162,\"b\":241,\"a\":1},\"primary_hover\":{\"r\":134,\"g\":144,\"b\":221,\"a\":1},\"primary_elevated\":{\"r\":134,\"g\":144,\"b\":221,\"a\":1},\"secondary\":{\"r\":153,\"g\":162,\"b\":241,\"a\":0.2},\"contrast\":{\"r\":255,\"g\":255,\"b\":255,\"a\":1},\"bg\":{\"r\":153,\"g\":162,\"b\":241,\"a\":0.2},\"bg_hover\":{\"r\":153,\"g\":162,\"b\":241,\"a\":0.3},\"dark\":{\"primary\":{\"r\":153,\"g\":162,\"b\":241,\"a\":1},\"primary_hover\":{\"r\":172,\"g\":181,\"b\":255,\"a\":1},\"primary_elevated\":{\"r\":172,\"g\":181,\"b\":255,\"a\":1},\"secondary\":{\"r\":153,\"g\":162,\"b\":241,\"a\":0.2},\"contrast\":{\"r\":255,\"g\":255,\"b\":255,\"a\":1},\"bg\":{\"r\":153,\"g\":162,\"b\":241,\"a\":0.2},\"bg_hover\":{\"r\":153,\"g\":162,\"b\":241,\"a\":0.3}}},\"fg\":{\"primary\":{\"r\":0,\"g\":0,\"b\":0,\"a\":0.8},\"secondary\":{\"r\":0,\"g\":0,\"b\":0,\"a\":0.6},\"tertiary\":{\"r\":0,\"g\":0,\"b\":0,\"a\":0.4},\"accent\":{\"r\":102,\"g\":113,\"b\":187,\"a\":1},\"dark\":{\"primary\":{\"r\":255,\"g\":255,\"b\":255,\"a\":0.9},\"secondary\":{\"r\":255,\"g\":255,\"b\":255,\"a\":0.6},\"tertiary\":{\"r\":255,\"g\":255,\"b\":255,\"a\":0.4},\"accent\":{\"r\":153,\"g\":162,\"b\":241,\"a\":1}}},\"bg\":{\"name\":\"#ffffff\",\"hue\":{\"r\":255,\"g\":255,\"b\":255,\"a\":0},\"tint\":{\"r\":255,\"g\":255,\"b\":255,\"a\":0},\"primary\":{\"r\":255,\"g\":255,\"b\":255,\"a\":1},\"primary_hover\":{\"r\":250,\"g\":250,\"b\":250,\"a\":1},\"primary_elevated\":{\"r\":250,\"g\":250,\"b\":250,\"a\":1},\"secondary\":{\"r\":238,\"g\":238,\"b\":238,\"a\":1},\"secondary_elevated\":{\"r\":206.90096477355226,\"g\":206.90096477355175,\"b\":206.9009647735519,\"a\":1},\"tertiary\":{\"r\":219,\"g\":219,\"b\":219,\"a\":1},\"quaternary\":{\"r\":182,\"g\":182,\"b\":182,\"a\":1},\"dark\":{\"primary\":{\"r\":22,\"g\":23,\"b\":24,\"a\":1},\"primary_hover\":{\"r\":27,\"g\":28,\"b\":29,\"a\":1},\"primary_elevated\":{\"r\":27,\"g\":28,\"b\":29,\"a\":1},\"secondary\":{\"r\":35,\"g\":37,\"b\":37,\"a\":1},\"secondary_elevated\":{\"r\":41.35899397549579,\"g\":43.405356429195315,\"b\":43.40489285041963,\"a\":1},\"tertiary\":{\"r\":54,\"g\":55,\"b\":55,\"a\":1},\"quaternary\":{\"r\":90,\"g\":91,\"b\":91,\"a\":1}}}},\"cover_image\":{\"url\":\"https://substackcdn.com/image/fetch/$s_!WNJs!,w_1200,h_400,c_pad,f_auto,q_auto:best,fl_progressive:steep,b_auto:border,b_rgb:FFFFFF/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55e3b22f-cc6b-438a-be3d-8d17cc97c2f9_750x750.png\",\"height\":750,\"width\":2250}},\"portalAppTheme\":{\"colors\":{\"accent\":{\"name\":\"#99A2F1\",\"primary\":{\"r\":153,\"g\":162,\"b\":241,\"a\":1},\"primary_hover\":{\"r\":131,\"g\":142,\"b\":238,\"a\":1},\"primary_elevated\":{\"r\":153,\"g\":162,\"b\":241,\"a\":1},\"secondary\":{\"r\":153,\"g\":162,\"b\":241,\"a\":1},\"contrast\":{\"r\":255,\"g\":255,\"b\":255,\"a\":1},\"bg\":{\"r\":255,\"g\":103,\"b\":25,\"a\":0.2},\"bg_hover\":{\"r\":255,\"g\":103,\"b\":25,\"a\":0.3},\"dark\":{\"primary\":{\"r\":153,\"g\":162,\"b\":241,\"a\":1},\"primary_hover\":{\"r\":172,\"g\":181,\"b\":255,\"a\":1},\"primary_elevated\":{\"r\":172,\"g\":181,\"b\":255,\"a\":1},\"secondary\":{\"r\":153,\"g\":162,\"b\":241,\"a\":0.2},\"contrast\":{\"r\":255,\"g\":255,\"b\":255,\"a\":1},\"bg\":{\"r\":153,\"g\":162,\"b\":241,\"a\":0.2},\"bg_hover\":{\"r\":153,\"g\":162,\"b\":241,\"a\":0.3}}},\"fg\":{\"primary\":{\"r\":54,\"g\":55,\"b\":55,\"a\":1},\"secondary\":{\"r\":134,\"g\":135,\"b\":135,\"a\":1},\"tertiary\":{\"r\":146,\"g\":146,\"b\":146,\"a\":1},\"accent\":{\"r\":153,\"g\":162,\"b\":241,\"a\":1},\"dark\":{\"primary\":{\"r\":255,\"g\":255,\"b\":255,\"a\":0.9},\"secondary\":{\"r\":255,\"g\":255,\"b\":255,\"a\":0.6},\"tertiary\":{\"r\":255,\"g\":255,\"b\":255,\"a\":0.4},\"accent\":{\"r\":153,\"g\":162,\"b\":241,\"a\":1}}},\"bg\":{\"name\":\"#ffffff\",\"hue\":{\"r\":255,\"g\":255,\"b\":255,\"a\":1},\"tint\":{\"r\":255,\"g\":255,\"b\":255,\"a\":1},\"primary\":{\"r\":255,\"g\":255,\"b\":255,\"a\":1},\"primary_hover\":{\"r\":240,\"g\":240,\"b\":240,\"a\":1},\"primary_elevated\":{\"r\":255,\"g\":255,\"b\":255,\"a\":1},\"secondary\":{\"r\":240,\"g\":240,\"b\":240,\"a\":1},\"secondary_elevated\":{\"r\":240,\"g\":240,\"b\":240,\"a\":1},\"tertiary\":{\"r\":221,\"g\":221,\"b\":221,\"a\":1},\"quaternary\":{\"r\":183,\"g\":183,\"b\":183,\"a\":1},\"dark\":{\"primary\":{\"r\":22,\"g\":23,\"b\":24,\"a\":1},\"primary_hover\":{\"r\":27,\"g\":28,\"b\":29,\"a\":1},\"primary_elevated\":{\"r\":27,\"g\":28,\"b\":29,\"a\":1},\"secondary\":{\"r\":35,\"g\":37,\"b\":37,\"a\":1},\"secondary_elevated\":{\"r\":41.35899397549579,\"g\":43.405356429195315,\"b\":43.40489285041963,\"a\":1},\"tertiary\":{\"r\":54,\"g\":55,\"b\":55,\"a\":1},\"quaternary\":{\"r\":90,\"g\":91,\"b\":91,\"a\":1}}}}},\"logoPalette\":{\"Vibrant\":{\"rgb\":[244,147,12],\"population\":599},\"DarkVibrant\":{\"rgb\":[100,68,4],\"population\":1104},\"LightVibrant\":{\"rgb\":[252,204,76],\"population\":1917},\"Muted\":{\"rgb\":[172,148,116],\"population\":1},\"DarkMuted\":{\"rgb\":[132,108,60],\"population\":1},\"LightMuted\":{\"rgb\":[196,180,164],\"population\":1}}},\"confirmedLogin\":false,\"hide_intro_popup\":false,\"block_auto_login\":false,\"domainInfo\":{\"isSubstack\":false,\"customDomain\":\"www.thonking.ai\"},\"experimentFeatures\":{\"thefp_free_trial_experiment\":\"treatment\",\"onboarding_show_all_suggestions_web\":\"control\",\"mobile_post_page_listen_button\":\"control\"},\"experimentExposures\":{},\"siteConfigs\":{\"score_upsell_email\":\"control\",\"first_chat_email_enabled\":true,\"reader-onboarding-promoted-pub\":737237,\"new_commenter_approval\":false,\"pub_update_opennode_api_key\":false,\"notes_video_max_duration_minutes\":15,\"show_content_label_age_gating_in_feed\":false,\"zendesk_automation_cancellations\":false,\"hide_book_a_meeting_button\":false,\"mfa_action_box_enabled\":false,\"publication_max_bylines\":35,\"no_contest_charge_disputes\":false,\"feed_posts_previously_seen_weight\":0.1,\"publication_tabs_reorder\":false,\"comp_expiry_email_new_copy\":\"NONE\",\"free_unlock_required\":false,\"traffic_rule_check_enabled\":false,\"amp_emails_enabled\":false,\"enable_post_summarization\":false,\"live_stream_host_warning_message\":\"\",\"bitcoin_enabled\":false,\"minimum_ios_os_version\":\"17.0.0\",\"show_entire_square_image\":false,\"hide_subscriber_count\":false,\"fit_in_live_stream_player\":false,\"publication_author_display_override\":\"\",\"ios_webview_payments_enabled\":\"control\",\"generate_pdf_tax_report\":false,\"use_platform_document_editor_fn_component\":false,\"show_generic_post_importer\":false,\"enable_pledges_modal\":true,\"include_pdf_invoice\":false,\"galleried_attachments_in_composer\":\"control\",\"notes_weight_watch_video\":5,\"enable_react_dashboard\":false,\"meetings_v1\":false,\"enable_videos_page\":false,\"exempt_from_gtm_filter\":false,\"group_sections_and_podcasts_in_menu\":false,\"boost_optin_modal_enabled\":true,\"standards_and_enforcement_features_enabled\":false,\"pub_creation_captcha_behavior\":\"risky_pubs_or_rate_limit\",\"post_blogspot_importer\":false,\"search_ranker_variant\":\"experiment\",\"notes_weight_short_item_boost\":0.15,\"enable_high_res_background_uploading\":false,\"pub_tts_override\":\"default\",\"disable_monthly_subscriptions\":false,\"skip_welcome_email\":false,\"chat_reader_thread_notification_default\":false,\"scheduled_pinned_posts\":false,\"disable_redirect_outbound_utm_params\":false,\"reader_gift_referrals_enabled\":true,\"dont_show_guest_byline\":false,\"like_comments_enabled\":true,\"temporal_livestream_ended_draft\":true,\"enable_author_note_email_toggle\":false,\"meetings_embed_publication_name\":false,\"fallback_to_archive_search_on_section_pages\":false,\"livekit_track_egress_custom_base_url\":\"http://livekit-egress-custom-recorder-participant-test.s3-website-us-east-1.amazonaws.com\",\"people_you_may_know_algorithm\":\"experiment\",\"welcome_screen_blurb_override\":\"\",\"notes_weight_low_impression_boost\":0.3,\"like_posts_enabled\":true,\"feed_promoted_video_boost\":1.5,\"suppress_leaderboard_for_tags\":\"\",\"twitter_player_card_enabled\":true,\"subscribe_bypass_preact_router\":false,\"feed_promoted_user\":false,\"show_note_stats_for_all_notes\":false,\"section_specific_csv_imports_enabled\":false,\"disable_podcast_feed_description_cta\":false,\"bypass_profile_substack_logo_detection\":false,\"use_preloaded_player_sources\":false,\"enable_tiktok_oauth\":false,\"list_pruning_enabled\":false,\"facebook_connect\":false,\"opt_in_to_sections_during_subscribe\":false,\"dpn_weight_share\":2,\"underlined_colored_links\":false,\"enable_efficient_digest_embed\":false,\"enable_founding_iap_plans\":false,\"extract_stripe_receipt_url\":false,\"enable_aligned_images\":false,\"max_image_upload_mb\":64,\"enable_android_dms_writer_beta\":false,\"threads_suggested_ios_version\":null,\"pledges_disabled\":false,\"threads_minimum_ios_version\":812,\"hide_podcast_email_setup_link\":false,\"subscribe_captcha_behavior\":\"default\",\"publication_ban_sample_rate\":0,\"enable_react_router_login\":true,\"ios_enable_publication_activity_tab\":false,\"custom_themes_substack_subscribe_modal\":false,\"ios_post_share_assets_screenshot_trigger\":\"control\",\"opt_in_to_sections_during_subscribe_include_main_pub_newsletter\":false,\"continue_support_cta_in_newsletter_emails\":false,\"bloomberg_syndication_enabled\":false,\"welcome_page_app_button\":true,\"lists_enabled\":false,\"adhoc_email_batch_delay_ms\":0,\"generated_database_maintenance_mode\":false,\"allow_document_freeze\":false,\"test_age_gate_user\":false,\"podcast_main_feed_is_firehose\":false,\"pub_app_incentive_gift\":\"\",\"no_embed_redirect\":false,\"translate_mobile_app\":false,\"customized_email_from_name_for_new_follow_emails\":\"treatment\",\"spotify_open_access_sandbox_mode\":false,\"use_video_watermark_for_livestream_drafts\":true,\"fullstory_enabled\":false,\"chat_reply_poll_interval\":3,\"dpn_weight_follow_or_subscribe\":3,\"force_pub_links_to_use_subdomain\":false,\"always_show_cookie_banner\":false,\"hide_media_download_option\":false,\"hide_post_restacks\":false,\"feed_item_source_debug_mode\":false,\"thefp_enable_email_expiry_cta\":false,\"thefp_enable_account_menu\":false,\"enable_user_status_ui\":false,\"publication_homepage_title_display_override\":\"\",\"post_preview_highlight_byline\":false,\"4k_video\":false,\"enable_islands_section_intent_screen\":false,\"post_metering_enabled\":false,\"notifications_disabled\":\"\",\"cross_post_notification_threshold\":1000,\"facebook_connect_prod_app\":true,\"feed_enable_live_streams\":false,\"force_into_pymk_ranking\":false,\"minimum_android_version\":756,\"ios_remove_live_stream_invite_acceptance_on_broken_build\":true,\"live_stream_krisp_noise_suppression_enabled\":false,\"enable_transcription_translations\":false,\"nav_group_items\":false,\"use_og_image_as_twitter_image_for_post_previews\":false,\"always_use_podcast_channel_art_as_episode_art_in_rss\":false,\"enable_sponsorship_perks\":false,\"seo_tier_override\":\"NONE\",\"editor_role_enabled\":false,\"no_follow_links\":false,\"publisher_api_enabled\":false,\"zendesk_support_priority\":\"default\",\"enable_post_clips_stats\":false,\"enable_subscriber_referrals_awards\":true,\"ios_profile_themes_feed_permalink_enabled\":false,\"ios_enable_draft_notes\":false,\"use_publication_language_for_transcription\":false,\"show_substack_funded_gifts_tooltip\":true,\"disable_ai_transcription\":false,\"thread_permalink_preview_min_ios_version\":4192,\"live_stream_founding_audience_enabled\":false,\"android_toggle_on_website_enabled\":false,\"internal_android_enable_post_editor\":false,\"updated_inbox_ui\":false,\"use_temporal_thumbnail_selection_workflow\":false,\"live_stream_creation_enabled\":true,\"disable_card_element_in_europe\":false,\"web_growth_item_promotion_threshold\":0,\"article_attachments_v3\":\"control\",\"enable_web_typing_indicators\":false,\"web_vitals_sample_rate\":0,\"allow_live_stream_auto_takedown\":\"true\",\"mobile_publication_attachments_enabled\":false,\"ios_post_dynamic_title_size\":false,\"ios_enable_live_stream_highlight_trailer_toggle\":false,\"ai_image_generation_enabled\":true,\"disable_personal_substack_initialization\":false,\"section_specific_welcome_pages\":false,\"local_payment_methods\":\"control\",\"private_live_streaming_enabled\":false,\"posts_in_rss_feed\":20,\"post_rec_endpoint\":\"\",\"publisher_dashboard_section_selector\":false,\"reader_surveys_platform_question_order\":\"36,1,4,2,3,5,6,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35\",\"developer_api_enabled\":false,\"login_guard_app_link_in_email\":true,\"community_moderators_enabled\":false,\"monthly_sub_is_one_off\":false,\"unread_notes_activity_digest\":\"control\",\"display_cookie_settings\":false,\"welcome_page_query_params\":false,\"enable_free_podcast_urls\":false,\"email_post_stats_v2\":false,\"comp_expiry_emails_disabled\":false,\"enable_description_on_polls\":false,\"use_microlink_for_instagram_embeds\":false,\"post_notification_batch_delay_ms\":30000,\"free_signup_confirmation_behavior\":\"with_email_validation\",\"ios_post_stats_for_admins\":false,\"live_stream_concurrent_viewer_count_drawer\":false,\"use_livestream_post_media_composition\":true,\"section_specific_preambles\":false,\"pub_export_temp_disable\":false,\"show_menu_on_posts\":false,\"ios_post_subscribe_web_routing\":true,\"opt_into_all_trending_topics\":false,\"ios_writer_stats_public_launch_v2\":false,\"min_size_for_phishing_check\":1,\"enable_android_post_stats\":false,\"ios_chat_revamp_enabled\":false,\"app_onboarding_survey_email\":false,\"thefp_enable_pullquote_alignment\":false,\"thefp_enable_pullquote_color\":false,\"republishing_enabled\":false,\"app_mode\":false,\"show_phone_banner\":false,\"live_stream_video_enhancer\":\"internal\",\"minimum_ios_version\":2200,\"enable_author_pages\":false,\"enable_decagon_chat\":true,\"first_month_upsell\":\"control\",\"recipes_enabled\":true,\"new_user_checklist_enabled\":\"use_follower_count\",\"ios_feed_note_status_polling_enabled\":false,\"show_attached_profile_for_pub_setting\":false,\"rss_verification_code\":\"\",\"notification_post_emails\":\"experiment\",\"notes_weight_follow\":3.8,\"chat_suppress_contributor_push_option_enabled\":false,\"use_og_image_asset_variant\":\"\",\"age_verification_au_enabled\":true,\"export_hooks_enabled\":false,\"audio_encoding_bitrate\":null,\"bestseller_pub_override\":false,\"extra_seats_coupon_type\":false,\"post_subdomain_universal_links\":false,\"post_import_max_file_size\":26214400,\"feed_promoted_video_publication\":false,\"livekit_reconnect_slate_url\":\"https://mux-livestream-assets.s3.us-east-1.amazonaws.com/custom-disconnect-slate-tall.png\",\"exclude_from_pymk_suggestions\":false,\"publication_ranking_variant\":\"experiment\",\"disable_annual_subscriptions\":false,\"android_enable_auto_gain_control\":true,\"enable_android_dms\":false,\"allow_coupons_on_upgrade\":false,\"test_au_age_gate_user\":false,\"pub_auto_moderation_enabled\":false,\"disable_live_stream_ai_trimming_by_default\":false,\"thefp_custom_password_flow\":false,\"disable_deletion\":false,\"ios_default_coupon_enabled\":false,\"notes_weight_read_post\":5,\"notes_weight_reply\":3,\"livekit_egress_custom_base_url\":\"http://livekit-egress-custom-recorder.s3-website-us-east-1.amazonaws.com\",\"clip_focused_video_upload_flow\":false,\"live_stream_max_guest_users\":2,\"android_upgrade_alert_dialog_reincarnated\":true,\"enable_video_seo_data\":false,\"can_reimport_unsubscribed_users_with_2x_optin\":false,\"feed_posts_weight_subscribed\":0,\"founding_upgrade_during_gift_disabled\":false,\"live_event_mixin\":\"\",\"review_incoming_email\":\"default\",\"media_feed_subscribed_posts_weight\":0.5,\"enable_founding_gifts\":false,\"android_feed_compose_button_experiment\":\"treatment\",\"enable_sponsorship_campaigns\":false,\"thread_permalink_preview_min_android_version\":2037,\"enable_creator_earnings\":true,\"thefp_enable_embed_media_links\":false,\"thumbnail_selection_max_frames\":300,\"sort_modal_search_results\":false,\"default_thumbnail_time\":10,\"pub_ranking_weight_retained_engagement\":1,\"load_test_unichat\":false,\"thefp_email_copy_updates\":false,\"notes_read_post_baseline\":0,\"live_stream_head_alignment_guide\":false,\"show_open_post_as_pdf_button\":false,\"free_press_combo_subscribe_flow_enabled\":false,\"use_web_livestream_thumbnail_editor\":false,\"android_note_auto_share_assets\":\"control\",\"pub_ranking_weight_immediate_engagement\":0.5,\"gifts_from_substack_feature_available\":true,\"disable_ai_clips\":false,\"enable_elevenlabs_voiceovers\":false,\"growth_sources_all_time\":false,\"thefp_enable_web_livestream_kicking\":true,\"translated_notifications_enabled\":false,\"show_simple_post_editor\":false,\"enable_publication_podcasts_page\":false,\"android_profile_share_assets_experiment\":\"treatment\",\"use_advanced_fonts\":false,\"thefp_enable_dynamic_toaster\":false,\"ios_note_composer_settings_enabled\":false,\"android_v2_post_video_player_enabled\":false,\"enable_direct_message_request_bypass\":false,\"enable_apple_news_sync\":false,\"enable_polymarket_note_search\":true,\"media_feed_prepend_inbox_limit\":30,\"free_press_newsletter_promo_enabled\":false,\"enable_ios_livestream_stats\":false,\"disable_live_stream_reactions\":false,\"feed_posts_weight_negative\":2.5,\"use_comment_data_cache_for_categorization\":\"experiment\",\"clip_generation_3rd_party_vendor\":\"internal\",\"ios_onboarding_suggestions_hero_text\":\"control\",\"thefp_paywall_with_plans\":\"treatment\",\"notes_weight_negative\":1,\"ios_discover_tab_min_installed_date\":\"2025-06-09T16:56:58+0000\",\"notes_weight_click_see_more\":2,\"subscription_bar_prioritize_completed_posts\":false,\"edit_profile_theme_colors\":false,\"notes_weight_like\":2.4,\"disable_clipping_for_readers\":false,\"enable_high_follower_dm\":false,\"android_creator_earnings_enabled\":true,\"feed_posts_weight_reply\":3,\"feed_posts_weight_like\":1.5,\"feed_posts_weight_share\":3,\"feed_posts_weight_save\":3,\"enable_press_kit_preview_modal\":false,\"dpn_weight_tap_clickbait_penalty\":0.5,\"feed_posts_weight_sign_up\":4,\"live_stream_desktop_video_codec\":\"vp9\",\"live_stream_video_degradation_preference\":\"maintainFramerate\",\"pause_app_badges\":false,\"android_enable_publication_activity_tab\":false,\"profile_feed_expanded_inventory\":false,\"phone_verification_fallback_to_twilio\":false,\"livekit_mux_latency_mode\":\"low\",\"feed_juiced_user\":0,\"show_branded_intro_setting\":true,\"free_press_single_screen_subscribe_flow_enabled\":false,\"notes_click_see_more_baseline\":0.35,\"enable_polymarket_expandable_embeds\":true,\"publication_onboarding_weight_std_dev\":0,\"can_see_fast_subscriber_counts\":true,\"android_enable_user_status_ui\":false,\"use_advanced_commerce_api_for_iap\":false,\"skip_free_preview_language_in_podcast_notes\":false,\"larger_wordmark_on_publication_homepage\":false,\"video_editor_full_screen\":false,\"enable_mobile_stats_for_admins\":false,\"ios_profile_themes_note_composer_enabled\":false,\"enable_persona_sandbox_environment\":false,\"notes_weight_click_item\":3,\"notes_weight_long_visit\":1,\"bypass_single_unlock_token_limit\":false,\"notes_watch_video_baseline\":0.08,\"twitter_api_enabled\":true,\"add_section_and_tag_metadata\":false,\"daily_promoted_notes_enabled\":true,\"enable_islands_cms\":false,\"enable_livestream_combined_stats\":false,\"ios_social_subgroups_enabled\":false,\"android_enable_unified_composer_four\":true,\"enable_drip_campaigns\":false,\"adhoc_email_batch_size\":5000,\"ios_offline_mode_enabled\":false,\"stripe_link_in_payment_element_v3\":\"experiment\",\"post_management_search_engine\":\"elasticsearch\",\"new_bestseller_leaderboard_feed_item_enabled\":false,\"feed_main_disabled\":false,\"enable_account_settings_revamp\":false,\"allowed_email_domains\":\"one\",\"thefp_enable_fp_recirc_block\":false,\"thefp_free_trial_experiment\":\"experiment\",\"top_search_variant\":\"control\",\"ios_route_profiles_to_portals\":\"control\",\"enable_debug_logs_ios\":false,\"show_pub_content_on_profile_for_pub_id\":0,\"show_pub_content_on_profile\":false,\"livekit_track_egress\":true,\"video_tab_mixture_pattern\":\"npnnnn\",\"enable_theme_contexts\":false,\"onboarding_suggestions_search\":\"experiment\",\"feed_tuner_enabled\":false,\"livekit_mux_latency_mode_rtmp\":\"low\",\"subscription_bar_top_selection_strategy_v3\":\"destination_wau_pub_score\",\"thefp_homepage_portrait_layout\":false,\"age_verification_uk_enabled\":true,\"fcm_high_priority\":false,\"android_activity_share_nudge\":\"control\",\"enable_content_block_pinning\":false,\"highlighted_code_block_enabled\":true,\"dpn_weight_tap_bonus_subscribed\":0,\"iap_announcement_blog_url\":\"\",\"android_onboarding_progress_persistence\":\"control\",\"draft_notes_enabled\":false,\"ios_livestream_feedback\":false,\"founding_plan_upgrade_warning\":false,\"dpn_weight_like\":3,\"dpn_weight_short_session\":1,\"ios_enable_custom_thumbnail_generation\":true,\"thefp_email_paywall_with_plans\":\"treatment\",\"ios_mediaplayer_reply_bar_v2\":false,\"android_view_post_share_assets_employees_only\":false,\"thefp_show_fixed_footer_paywall\":false,\"creator_onboarding_checklist_experiment_ios\":\"control\",\"notes_weight_follow_boost\":10,\"profile_portal_theme\":false,\"follow_upsell_rollout_percentage\":30,\"android_activity_item_sharing_experiment\":\"control\",\"live_stream_invite_ttl_seconds\":900000,\"include_founding_plans_coupon_option\":false,\"enable_polymarket_post_embeds\":true,\"use_settings_editor_without_inheritance\":true,\"dpn_weight_reply\":2,\"android_enable_edit_profile_theme\":false,\"android_enable_view_profile_theme\":false,\"dpn_weight_follow\":3,\"thumbnail_selection_engine\":\"openai\",\"portals_include_preview_posts\":true,\"enable_adhoc_email_batching\":0,\"notes_weight_author_low_impression_boost\":0.2,\"pub_search_variant\":\"control\",\"ignore_video_in_notes_length_limit\":false,\"web_show_scores_on_sports_tab\":false,\"notes_weight_click_share\":3,\"geppo_post_msgpack_input_rollout\":1,\"allow_long_videos\":true,\"feed_posts_weight_long_click\":15,\"dpn_score_threshold\":0,\"thefp_enable_follow_module\":false,\"dpn_weight_follow_bonus\":0.5,\"use_intro_clip_and_branded_intro_by_default\":false,\"web_suggested_search_route_recent_search\":\"experiment\",\"use_enhanced_video_embed_player\":true,\"community_profile_activity_feed\":false,\"android_reader_share_assets_3\":\"control\",\"mobile_age_verification_learn_more_link\":\"https://on.substack.com/p/our-position-on-the-online-safety\",\"enable_viewing_all_livestream_viewers\":false,\"enable_clip_prompt_variant_filtering\":true,\"chartbeat_enabled\":false,\"dpn_weight_open\":1,\"dpn_ranking_enabled\":true,\"reply_flags_enabled\":true,\"enable_custom_email_css\":false,\"dpn_model_variant\":\"experiment\",\"android_og_tag_post_sharing_experiment\":\"control\",\"platform_search_variant\":\"control\",\"enable_apple_podcast_auto_publish\":false,\"linkedin_profile_search_enabled\":false,\"artie_shadow_percentage\":0,\"publication_has_own_app\":false,\"dpn_weight_disable\":20,\"ios_pogs_stories\":\"experiment\",\"live_stream_in_trending_topic_overrides\":\"\",\"pub_banned_word_list\":\"raydium,rewards,claim available,claim notification,trading activity update,jito foundation,jito manager,jito support,jito desk\",\"enable_notes_admins\":false,\"trending_topics_module_long_term_experiment\":\"control\",\"enable_suggested_searches\":true,\"post_page_scrolling_modal_subscribe_in_app\":\"control\",\"thefp_enable_login_codes\":false,\"android_synchronous_push_notif_handling\":\"control\",\"thumbnail_selection_skip_desktop_streams\":false,\"a24_redemption_link\":\"\",\"ios_live_stream_auto_gain_enabled\":true,\"dpn_weight_restack\":2,\"dpn_weight_tap\":2,\"use_thumbnail_selection_workflow\":true,\"new_delivery_and_open_rate_infobox_enabled\":true,\"portal_post_limit\":1,\"session_version_invalidation_enabled\":false,\"mobile_post_page_listen_button\":\"experiment\",\"search_retrieval_variant\":\"control\",\"forced_featured_topic_id\":\"\",\"ios_audio_captions_disabled\":false,\"show_follow_upsell_ios\":\"control\",\"use_live_stream_end_trimming\":true,\"related_posts_enabled\":false,\"new_delivery_and_open_rate_help_url\":\"https://support.substack.com/hc/en-us/articles/5320347155860-A-guide-to-Substack-metrics\",\"use_progressive_editor_rollout\":true,\"ios_live_stream_pip_dismiss_v4\":\"control\",\"creator_onboarding_checklist_experiment_web\":\"experiment\",\"user_spam_model_rollout_percentage\":100,\"new_delivery_and_open_rate_enabled\":true,\"ios_founding_subscription_web_edit_button\":false,\"dpn_weight_negative\":30,\"enable_live_stream_thumbnail_treatment_validation\":false,\"reply_rate_limit_max_distinct_users_daily\":110,\"ios_composer_modes_vs_attachments\":\"treatment\",\"android_rank_share_destinations_experiment\":\"control\",\"publisher_banner\":\"\",\"posh_to_go_percentage\":0,\"suggested_search_metadata_web_ui\":true,\"mobile_user_attachments_enabled\":false,\"feed_weight_language_mismatch_penalty\":0.6,\"default_orange_quote_experiment\":\"control\",\"community_activity_feed_author_to_community_content_ratio\":0.5,\"enable_sponsorship_profile\":false,\"web_view_get_app\":\"control\",\"galleried_attachments\":\"control\",\"ios_mid_read_post_reminder_v2\":\"treatment\",\"android_note_share_assets\":\"control\",\"reply_rate_limit_max_distinct_users_monthly\":600,\"mobile_web_app_before_pledge\":\"experiment\",\"desktop_live_stream_screen_share_audio_enabled\":false,\"search_posts_use_top_search\":false,\"desktop_live_stream_screen_share_enabled\":true,\"use_accelerated_draft_generation\":true,\"android_vertical_post_player_3\":\"control\",\"ios_route_publications_to_portals\":\"experiment\",\"permalink_reply_pin_user_comment\":\"control\",\"android_composer_modes_vs_attachments\":\"control\",\"activity_item_ranking_variant\":\"experiment\",\"android_polymarket_embed_search\":false,\"android_post_like_share_nudge\":\"treatment\",\"android_post_bottom_share_experiment\":\"treatment\",\"android_reader_share_assets_4\":\"treatment_double_row\",\"notes_category_spacing_variant\":\"experiment\",\"use_thumbnail_selection_sentiment_matching\":true,\"skip_adhoc_email_sends\":false,\"enable_semi_modal_story_posts\":false,\"permalink_reply_ranking_variant\":\"experiment\",\"geppo_post_msgpack_rollout\":1,\"dpn_weight_long_session\":1.5},\"publicationSettings\":{\"block_ai_crawlers\":false,\"credit_token_enabled\":true,\"custom_tos_and_privacy\":false,\"did_identity\":null,\"disable_optimistic_bank_payments\":false,\"display_welcome_page_details\":true,\"enable_meetings\":false,\"payment_pledges_enabled\":true,\"enable_post_page_conversion\":true,\"enable_prev_next_nav\":false,\"enable_restacking\":true,\"gifts_from_substack_disabled\":false,\"google_analytics_4_token\":null,\"group_sections_and_podcasts_in_menu_enabled\":false,\"live_stream_homepage_visibility\":\"contributorsAndAdmins\",\"live_stream_homepage_style\":\"autoPlay\",\"medium_length_description\":\"\",\"notes_feed_enabled\":false,\"paywall_unlock_tokens\":true,\"post_preview_crop_gravity\":\"center\",\"reader_referrals_enabled\":false,\"reader_referrals_leaderboard_enabled\":false,\"seen_coming_soon_explainer\":false,\"seen_google_analytics_migration_modal\":false,\"local_currency_modal_seen\":true,\"local_payment_methods_modal_seen\":false,\"twitter_pixel_signup_event_id\":null,\"twitter_pixel_subscribe_event_id\":null,\"use_local_currency\":true,\"welcome_page_opt_out_text\":\"No thanks\",\"cookie_settings\":\"\",\"show_restacks_below_posts\":true,\"holiday_gifting_post_header\":true,\"homepage_message_text\":\"\",\"homepage_message_link\":\"\",\"about_us_author_ids\":\"\",\"archived_section_ids\":\"\",\"column_section_ids\":\"\",\"fp_primary_column_section_ids\":\"\",\"event_section_ids\":\"\",\"podcasts_metadata\":\"\",\"video_section_ids\":\"\",\"post_metering_enabled\":false},\"publicationUserSettings\":null,\"userSettings\":{\"user_id\":null,\"activity_likes_enabled\":true,\"dashboard_nav_refresh_enabled\":false,\"hasDismissedSectionToNewsletterRename\":false,\"is_guest_post_enabled\":true,\"feed_web_nux_seen_at\":null,\"has_seen_select_to_restack_tooltip_nux\":false,\"invite_friends_nux_dismissed_at\":null,\"suggestions_feed_item_last_shown_at\":null,\"has_seen_select_to_restack_modal\":false,\"last_notification_alert_shown_at\":null,\"disable_reply_hiding\":false,\"newest_seen_chat_item_published_at\":null,\"explicitContentEnabled\":false,\"contactMatchingEnabled\":false,\"messageRequestLevel\":\"everyone\",\"liveStreamAcceptableInviteLevel\":\"everyone\",\"liveStreamAcceptableChatLevel\":\"everyone\",\"creditTokensTreatmentExposed\":false,\"appBadgeIncludesChat\":false,\"autoPlayVideo\":true,\"smart_delivery_enabled\":false,\"chatbotTermsLastAcceptedAt\":null,\"has_seen_notes_post_app_upsell\":false,\"substack_summer_nux_dismissed_at\":null,\"first_note_id\":null,\"show_concurrent_live_stream_viewers\":false,\"has_dismissed_fp_download_pdf_nux\":false,\"edit_profile_feed_item_dismissed_at\":null,\"mobile_permalink_app_upsell_seen_at\":null,\"new_user_checklist_enabled\":false,\"new_user_follow_subscribe_prompt_dismissed_at\":null,\"has_seen_youtube_shorts_auto_publish_announcement\":false,\"has_seen_publish_youtube_connect_upsell\":false,\"notificationQualityFilterEnabled\":true,\"hasSeenOnboardingNewslettersScreen\":false,\"bestsellerBadgeEnabled\":true,\"hasSelfIdentifiedAsCreator\":false},\"subscriberCountDetails\":\"thousands of subscribers\",\"mux_env_key\":\"u42pci814i6011qg3segrcpp9\",\"persona_environment_id\":\"env_o1Lbk4JhpY4PmvNkwaBdYwe5Fzkt\",\"sentry_environment\":\"production\",\"launchWelcomePage\":false,\"pendingInviteForActiveLiveStream\":null,\"webviewPlatform\":null,\"noIndex\":false,\"post\":{\"audience\":\"everyone\",\"audience_before_archived\":null,\"canonical_url\":\"https://www.thonking.ai/p/what-shapes-do-matrix-multiplications\",\"default_comment_sort\":null,\"editor_v2\":false,\"exempt_from_archive_paywall\":false,\"free_unlock_required\":false,\"id\":142904770,\"podcast_art_url\":null,\"podcast_duration\":null,\"podcast_preview_upload_id\":null,\"podcast_upload_id\":null,\"podcast_url\":null,\"post_date\":\"2024-04-01T16:01:30.512Z\",\"updated_at\":\"2025-06-26T21:44:21.006Z\",\"publication_id\":1781836,\"search_engine_description\":null,\"search_engine_title\":null,\"section_id\":null,\"should_send_free_preview\":false,\"show_guest_bios\":true,\"slug\":\"what-shapes-do-matrix-multiplications\",\"social_title\":null,\"subtitle\":\"Divining order from the chaos\",\"teaser_post_eligible\":true,\"title\":\"What Shapes Do Matrix Multiplications Like? [medium]\",\"type\":\"newsletter\",\"video_upload_id\":null,\"write_comment_permissions\":\"everyone\",\"meter_type\":\"none\",\"live_stream_id\":null,\"is_published\":true,\"restacks\":3,\"reactions\":{\"\u2764\":91},\"top_exclusions\":[],\"pins\":[],\"section_pins\":[],\"has_shareable_clips\":false,\"previous_post_slug\":\"short-supporting-mixtral-in-gpt-fast\",\"next_post_slug\":\"answer-key-what-shapes-do-matrix\",\"cover_image\":\"https://substackcdn.com/image/fetch/$s_!v5MG!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png\",\"cover_image_is_square\":false,\"cover_image_is_explicit\":false,\"videoUpload\":null,\"podcastFields\":{\"post_id\":142904770,\"podcast_episode_number\":null,\"podcast_season_number\":null,\"podcast_episode_type\":null,\"should_syndicate_to_other_feed\":null,\"syndicate_to_section_id\":null,\"hide_from_feed\":false,\"free_podcast_url\":null,\"free_podcast_duration\":null},\"podcastUpload\":null,\"podcastPreviewUpload\":null,\"voiceover_upload_id\":null,\"voiceoverUpload\":null,\"has_voiceover\":false,\"description\":\"Divining order from the chaos\",\"body_html\":\"<p>A while back, Karpathy tweeted that <em>increasing</em> the size of his matmul made it run faster. Surprisingly, it\u2019s not just <em>relatively</em> faster, it takes less <em>absolute</em> time. In other words, despite doing more work, it is executing in less time.</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link image2 is-viewable-img\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/$s_!v5MG!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!v5MG!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png 424w, https://substackcdn.com/image/fetch/$s_!v5MG!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png 848w, https://substackcdn.com/image/fetch/$s_!v5MG!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png 1272w, https://substackcdn.com/image/fetch/$s_!v5MG!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/$s_!v5MG!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png\\\" width=\\\"1204\\\" height=\\\"426\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:426,&quot;width&quot;:1204,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:119338,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:false,&quot;topImage&quot;:true,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!v5MG!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png 424w, https://substackcdn.com/image/fetch/$s_!v5MG!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png 848w, https://substackcdn.com/image/fetch/$s_!v5MG!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png 1272w, https://substackcdn.com/image/fetch/$s_!v5MG!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9b4467f5-8525-4701-a2ab-330bf4c58ec9_1204x426.png 1456w\\\" sizes=\\\"100vw\\\" fetchpriority=\\\"high\\\"></picture><div class=\\\"image-link-expand\\\"><div class=\\\"pencraft pc-display-flex pc-gap-8 pc-reset\\\"><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container restack-image\\\"><svg role=\\\"img\\\" style=\\\"height:20px;width:20px\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 20 20\\\" fill=\\\"none\\\" stroke-width=\\\"1.5\\\" stroke=\\\"var(--color-fg-primary)\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\"><g><title></title><path d=\\\"M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882\\\"></path></g></svg></button><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container view-image\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 lucide-maximize-2\\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></button></div></div></div></a><figcaption class=\\\"image-caption\\\"><a href=\\\"https://twitter.com/karpathy/status/1621578354024677377\\\">https://twitter.com/karpathy/status/1621578354024677377</a></figcaption></figure></div><p>This may seem intuitively quite strange. Is cuBLAS just messing up somehow? Why doesn\u2019t the matrix multiplication kernel just pad it to a larger shape? </p><p>It has become tribal knowledge that the particular shapes chosen for matmuls has a surprisingly large effect on their performance. But \u2026 why? Can this be understood by mere mortals?</p><p>Let\u2019s take a crack at it.</p><p>First, let\u2019s plot FLOPs achieved for square matmuls. By the end of this article, I will aim to explain all the strange squiggly lines. </p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link image2 is-viewable-img\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/$s_!de3t!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!de3t!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg 424w, https://substackcdn.com/image/fetch/$s_!de3t!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg 848w, https://substackcdn.com/image/fetch/$s_!de3t!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg 1272w, https://substackcdn.com/image/fetch/$s_!de3t!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/$s_!de3t!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg\\\" width=\\\"1456\\\" height=\\\"965\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/da2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:965,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Image&quot;,&quot;title&quot;:&quot;Image&quot;,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:false,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}\\\" class=\\\"sizing-normal\\\" alt=\\\"Image\\\" title=\\\"Image\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!de3t!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg 424w, https://substackcdn.com/image/fetch/$s_!de3t!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg 848w, https://substackcdn.com/image/fetch/$s_!de3t!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg 1272w, https://substackcdn.com/image/fetch/$s_!de3t!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fda2b6db5-95ca-47c9-adb5-6f5ca85c92f0_2418x1602.jpeg 1456w\\\" sizes=\\\"100vw\\\"></picture><div class=\\\"image-link-expand\\\"><div class=\\\"pencraft pc-display-flex pc-gap-8 pc-reset\\\"><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container restack-image\\\"><svg role=\\\"img\\\" style=\\\"height:20px;width:20px\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 20 20\\\" fill=\\\"none\\\" stroke-width=\\\"1.5\\\" stroke=\\\"var(--color-fg-primary)\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\"><g><title></title><path d=\\\"M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882\\\"></path></g></svg></button><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container view-image\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 lucide-maximize-2\\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></button></div></div></div></a></figure></div><p>There are 3 general concepts to understand that explain the majority of performance variation among matmul shapes.</p><ol><li><p>Compute Intensity/Parallelization: This explains the general upward trend</p></li><li><p>Tiling: This explains the multiple tiers of lines.</p></li><li><p>Wave Quantization: This explains the strange striped lines.</p></li></ol><div class=\\\"subscription-widget-wrap-editor\\\" data-attrs=\\\"{&quot;url&quot;:&quot;https://www.thonking.ai/subscribe?&quot;,&quot;text&quot;:&quot;Subscribe&quot;,&quot;language&quot;:&quot;en&quot;}\\\" data-component-name=\\\"SubscribeWidgetToDOM\\\"><div class=\\\"subscription-widget show-subscribe\\\"><div class=\\\"preamble\\\"><p class=\\\"cta-caption\\\">Thonk From First Principles is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\\\"subscription-widget-subscribe\\\"><input type=\\\"email\\\" class=\\\"email-input\\\" name=\\\"email\\\" placeholder=\\\"Type your email\u2026\\\" tabindex=\\\"-1\\\"><input type=\\\"submit\\\" class=\\\"button primary\\\" value=\\\"Subscribe\\\"><div class=\\\"fake-input-wrapper\\\"><div class=\\\"fake-input\\\"></div><div class=\\\"fake-button\\\"></div></div></form></div></div><h2>Compute Intensity and More Parallelism</h2><p>First of all, as we move along the x-axis, the matrix multiplications generally get more performant. There\u2019s two primary reasons for this. </p><p>The first one is simply \u201Cmore work/more parallelism\u201D. There are a large number of fixed overheads that come with launching a kernel (e.g. creating new SMs, waiting for all SMs to finish, etc.), and so, the more work we have to do, the less important those fixed overheads are. Along with more work comes more parallelism, and since GPUs have a ton of parallel cores, you need a surprising amount of work in order to fill a GPU up with enough parallelism.</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link image2 is-viewable-img\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/$s_!6S0a!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!6S0a!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png 424w, https://substackcdn.com/image/fetch/$s_!6S0a!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png 848w, https://substackcdn.com/image/fetch/$s_!6S0a!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png 1272w, https://substackcdn.com/image/fetch/$s_!6S0a!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/$s_!6S0a!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png\\\" width=\\\"478\\\" height=\\\"363.09615384615387\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/c5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1106,&quot;width&quot;:1456,&quot;resizeWidth&quot;:478,&quot;bytes&quot;:null,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!6S0a!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png 424w, https://substackcdn.com/image/fetch/$s_!6S0a!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png 848w, https://substackcdn.com/image/fetch/$s_!6S0a!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png 1272w, https://substackcdn.com/image/fetch/$s_!6S0a!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc5b2ae02-19be-4af7-8fc4-037f7476761b_2196x1668.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><div class=\\\"pencraft pc-display-flex pc-gap-8 pc-reset\\\"><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container restack-image\\\"><svg role=\\\"img\\\" style=\\\"height:20px;width:20px\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 20 20\\\" fill=\\\"none\\\" stroke-width=\\\"1.5\\\" stroke=\\\"var(--color-fg-primary)\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\"><g><title></title><path d=\\\"M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882\\\"></path></g></svg></button><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container view-image\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 lucide-maximize-2\\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></button></div></div></div></a><figcaption class=\\\"image-caption\\\">Data movement is expensive!</figcaption></figure></div><p>The second one is \u201Carithmetic intensity\u201D. As I\u2019ve <a href=\\\"https://horace.io/brrr_intro.html\\\">written about before</a>, memory accesses are much more expensive than compute. So, since a square matmul performs 3N^2 memory accesses and 2N^3 FLOPs, at a very minimum, N needs to be in the hundreds before we start spending more time on compute than memory!</p><p>The desire for sufficient Arithmetic Intensity and Parallelism also compound. For example, let\u2019s say you have your output matrix is <code>1024 x 1024</code>. If you let each SM compute a <code>128 x 128 </code>slice of the output, that\u2019s only 64 pieces of \u201Cwork\u201D for your GPU, not even enough for each one of an A100\u2019s 108 SMs ! If you decrease your output slice size to 64 x 64, we now have 256 pieces of \u201Cwork\u201D for our GPU, but our arithmetic intensity has also decreased by a factor of 2.</p><p>With smaller matrix sizes, you need to worry about problems like this that don\u2019t show up with larger matrices. </p><h2>Tiling</h2><p>Now that we understand the overall structure of the plot, the next question is: why is the plot all over the place? Why, even for very large matrices, do the TFLOPS jumping between &gt;250 and &lt;100?</p><p>To give a hint, let\u2019s color-code each dot by the highest power of 2 it\u2019s divisible by.</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link image2 is-viewable-img\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/$s_!qMoV!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!qMoV!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg 424w, https://substackcdn.com/image/fetch/$s_!qMoV!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg 848w, https://substackcdn.com/image/fetch/$s_!qMoV!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg 1272w, https://substackcdn.com/image/fetch/$s_!qMoV!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/$s_!qMoV!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg\\\" width=\\\"1456\\\" height=\\\"1087\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1087,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Image&quot;,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}\\\" class=\\\"sizing-normal\\\" alt=\\\"Image\\\" title=\\\"Image\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!qMoV!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg 424w, https://substackcdn.com/image/fetch/$s_!qMoV!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg 848w, https://substackcdn.com/image/fetch/$s_!qMoV!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg 1272w, https://substackcdn.com/image/fetch/$s_!qMoV!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F245e1a67-e758-4561-9521-72191ef5992f_1513x1130.jpeg 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><div class=\\\"pencraft pc-display-flex pc-gap-8 pc-reset\\\"><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container restack-image\\\"><svg role=\\\"img\\\" style=\\\"height:20px;width:20px\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 20 20\\\" fill=\\\"none\\\" stroke-width=\\\"1.5\\\" stroke=\\\"var(--color-fg-primary)\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\"><g><title></title><path d=\\\"M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882\\\"></path></g></svg></button><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container view-image\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 lucide-maximize-2\\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></button></div></div></div></a></figure></div><p>As it turns out, the multiple \u201Clevels\u201D of FLOPS are due to their shapes\u2019 divisibility. For example, when the shape is odd, the matmul performs significantly worse than when the shape is even. The matmul performs even better when the shape is divisible by 8, with even more performance gains when it\u2019s divisible by 16 or 32.</p><p>Now, merely knowing about this effect is very practically useful, but what actually causes this effect? As it turns out, the answer is tiling. But, what even <em>is</em> tiling? And why does it cause such substantial performance issues?</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link image2 is-viewable-img\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/$s_!qsho!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!qsho!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png 424w, https://substackcdn.com/image/fetch/$s_!qsho!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png 848w, https://substackcdn.com/image/fetch/$s_!qsho!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png 1272w, https://substackcdn.com/image/fetch/$s_!qsho!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/$s_!qsho!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png\\\" width=\\\"1456\\\" height=\\\"454\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:454,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:110115,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!qsho!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png 424w, https://substackcdn.com/image/fetch/$s_!qsho!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png 848w, https://substackcdn.com/image/fetch/$s_!qsho!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png 1272w, https://substackcdn.com/image/fetch/$s_!qsho!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5939a8fd-8356-45a6-8e83-db6fd48c014d_2116x660.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><div class=\\\"pencraft pc-display-flex pc-gap-8 pc-reset\\\"><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container restack-image\\\"><svg role=\\\"img\\\" style=\\\"height:20px;width:20px\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 20 20\\\" fill=\\\"none\\\" stroke-width=\\\"1.5\\\" stroke=\\\"var(--color-fg-primary)\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\"><g><title></title><path d=\\\"M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882\\\"></path></g></svg></button><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container view-image\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 lucide-maximize-2\\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></button></div></div></div></a><figcaption class=\\\"image-caption\\\">Taken from https://docs.nvidia.com/deeplearning/performance/dl-performance-matrix-multiplication/index.html#tile-quant</figcaption></figure></div><p>Some online have mentioned <a href=\\\"https://docs.nvidia.com/deeplearning/performance/dl-performance-matrix-multiplication/index.html#tile-quant\\\">tile quantization</a> as the culprit. Tile quantization certainly can impact performance, but <em>only at tile boundary sizes</em>. Basically, tile quantization occurs when the size of your matrix multiplication increases such that the GPU needs to launch another \u201Cchunk\u201D of work. For example, imagine that you could multiply 8 elements at a time with a SIMD instruction. Now, if you went from 32 elements to 33 elements (a 3% increase in problem size), you go from needing 4 SIMD instructions to 5 (a 25% increase). Note that crucially, when tile quantization is the culprit, your absolute runtime still grows monotonically, although your efficiency may drop.</p><p>However, in our above plot, we see much more drastic performance drops! Moreover, like in Karpathy\u2019s original example, we see that the <em>absolute runtime decreases despite problem size increasing</em>. So, tile quantization cannot be the explanation here.</p><p>The true cause is that tiling is just fundamentally worse for certain memory layouts. In other words, by the time we\u2019re trying to execute the matmul, you\u2019ve already lost. The memory layout is poor and your performance will suffer.</p><p>Let\u2019s look at some examples!</p><h3>Memory Layout of Tiling</h3><p>First, let\u2019s think about how our matrix\u2019s memory layout looks like when our size is a multiple of the cache line (pretend it\u2019s 4 elements). </p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link image2 is-viewable-img\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/$s_!9AzH!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!9AzH!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png 424w, https://substackcdn.com/image/fetch/$s_!9AzH!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png 848w, https://substackcdn.com/image/fetch/$s_!9AzH!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png 1272w, https://substackcdn.com/image/fetch/$s_!9AzH!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/$s_!9AzH!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png\\\" width=\\\"520\\\" height=\\\"371.55555555555554\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/819f8836-c521-4363-b170-49ee039569c6_1170x836.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:836,&quot;width&quot;:1170,&quot;resizeWidth&quot;:520,&quot;bytes&quot;:624255,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!9AzH!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png 424w, https://substackcdn.com/image/fetch/$s_!9AzH!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png 848w, https://substackcdn.com/image/fetch/$s_!9AzH!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png 1272w, https://substackcdn.com/image/fetch/$s_!9AzH!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F819f8836-c521-4363-b170-49ee039569c6_1170x836.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><div class=\\\"pencraft pc-display-flex pc-gap-8 pc-reset\\\"><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container restack-image\\\"><svg role=\\\"img\\\" style=\\\"height:20px;width:20px\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 20 20\\\" fill=\\\"none\\\" stroke-width=\\\"1.5\\\" stroke=\\\"var(--color-fg-primary)\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\"><g><title></title><path d=\\\"M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882\\\"></path></g></svg></button><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container view-image\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 lucide-maximize-2\\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></button></div></div></div></a><figcaption class=\\\"image-caption\\\">I choose to show 3 \u201Ccache lines\u201D per row because our matrix logically has 12 elements per row.</figcaption></figure></div><p>We see that each row starts on a cache line<a class=\\\"footnote-anchor\\\" data-component-name=\\\"FootnoteAnchorToDOM\\\" id=\\\"footnote-anchor-1\\\" href=\\\"#footnote-1\\\" target=\\\"_self\\\">1</a>. Among other advantages, this means that we don\u2019t need to perform any \u201Cunnecessary\u201D loads to load all yellow elements. We can just load the 3 cache lines that the yellow elements are part of.</p><p>However, what happens if we increase the number of elements per row from 12 to 13? </p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link image2 is-viewable-img\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/$s_!9BJj!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!9BJj!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png 424w, https://substackcdn.com/image/fetch/$s_!9BJj!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png 848w, https://substackcdn.com/image/fetch/$s_!9BJj!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png 1272w, https://substackcdn.com/image/fetch/$s_!9BJj!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/$s_!9BJj!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png\\\" width=\\\"520\\\" height=\\\"317.14701601164484\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:838,&quot;width&quot;:1374,&quot;resizeWidth&quot;:520,&quot;bytes&quot;:759750,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}\\\" class=\\\"sizing-normal\\\" alt=\\\"\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!9BJj!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png 424w, https://substackcdn.com/image/fetch/$s_!9BJj!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png 848w, https://substackcdn.com/image/fetch/$s_!9BJj!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png 1272w, https://substackcdn.com/image/fetch/$s_!9BJj!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F57fffe15-4659-44e1-b516-0944867b9f96_1374x838.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><div class=\\\"pencraft pc-display-flex pc-gap-8 pc-reset\\\"><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container restack-image\\\"><svg role=\\\"img\\\" style=\\\"height:20px;width:20px\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 20 20\\\" fill=\\\"none\\\" stroke-width=\\\"1.5\\\" stroke=\\\"var(--color-fg-primary)\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\"><g><title></title><path d=\\\"M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882\\\"></path></g></svg></button><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container view-image\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 lucide-maximize-2\\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></button></div></div></div></a><figcaption class=\\\"image-caption\\\">Each logical row (which have 13 elements) no longer starts aligned with a cache line.</figcaption></figure></div><p>With an unaligned layout, each row is misaligned relative to our cache line. In other words, if we start loading the beginning of the green row, we <em>must</em> redundantly load the last element of the blue row as well.</p><p>Now, let\u2019s look at what happens when we actually try to load an entire \u201Ctile\u201D from these memory layouts.</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link image2 is-viewable-img\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/$s_!jb1C!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!jb1C!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg 424w, https://substackcdn.com/image/fetch/$s_!jb1C!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg 848w, https://substackcdn.com/image/fetch/$s_!jb1C!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg 1272w, https://substackcdn.com/image/fetch/$s_!jb1C!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/$s_!jb1C!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg\\\" width=\\\"1456\\\" height=\\\"623\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/cf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:623,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Image&quot;,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}\\\" class=\\\"sizing-normal\\\" alt=\\\"Image\\\" title=\\\"Image\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!jb1C!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg 424w, https://substackcdn.com/image/fetch/$s_!jb1C!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg 848w, https://substackcdn.com/image/fetch/$s_!jb1C!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg 1272w, https://substackcdn.com/image/fetch/$s_!jb1C!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fcf2a2033-e9bf-44b8-8961-5b50c25eda91_2032x870.jpeg 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><div class=\\\"pencraft pc-display-flex pc-gap-8 pc-reset\\\"><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container restack-image\\\"><svg role=\\\"img\\\" style=\\\"height:20px;width:20px\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 20 20\\\" fill=\\\"none\\\" stroke-width=\\\"1.5\\\" stroke=\\\"var(--color-fg-primary)\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\"><g><title></title><path d=\\\"M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882\\\"></path></g></svg></button><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container view-image\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 lucide-maximize-2\\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></button></div></div></div></a><figcaption class=\\\"image-caption\\\">Shaded regions = elements we\u2019re trying to load. Crossed out regions = elements we don\u2019t need but must load due to it being in the same cache line.</figcaption></figure></div><p>With the aligned layout, this is very clean! We issue one load per row. One for the 4 blue elements, one for the 4 green elements, one for the 4 yellow elements, and one for the 4 pink elements. </p><p>With the unaligned layout, things are much messier. For example, in order to load the first 4 green elements, we must issue 2 loads! One that gets the last blue element + the first 3 green elements, and one that gets the 4th green element. A similar pattern occurs with loading the 4 yellow elements as well as the 4 pink elements.</p><p>So, when our matrix size is divisible by the cache line (which is 32 elements on a GPU), tiling fits nicely within the cache line, and our memory loads are maximally efficient. When it\u2019s not\u2026 the kernel needs many more workarounds in order to end up the proper alignment.<a class=\\\"footnote-anchor\\\" data-component-name=\\\"FootnoteAnchorToDOM\\\" id=\\\"footnote-anchor-2\\\" href=\\\"#footnote-2\\\" target=\\\"_self\\\">2</a></p><p>This is why even very small changes in our matrix size can lead to substantially worsened performance.</p><h2>Wave Quantization</h2><p>Ok, so we\u2019ve understood most of the variation in matmul performance. But what about these strange stripes up here? All of these points are with matmuls that are divisible by 32 already. Seeing that the peaks are separated by 256, our first guess might be that this is also memory-layout related, just at a larger scale.</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link image2 is-viewable-img\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/$s_!qSyi!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!qSyi!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png 424w, https://substackcdn.com/image/fetch/$s_!qSyi!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png 848w, https://substackcdn.com/image/fetch/$s_!qSyi!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png 1272w, https://substackcdn.com/image/fetch/$s_!qSyi!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/$s_!qSyi!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png\\\" width=\\\"844\\\" height=\\\"466\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:466,&quot;width&quot;:844,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Image&quot;,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}\\\" class=\\\"sizing-normal\\\" alt=\\\"Image\\\" title=\\\"Image\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!qSyi!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png 424w, https://substackcdn.com/image/fetch/$s_!qSyi!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png 848w, https://substackcdn.com/image/fetch/$s_!qSyi!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png 1272w, https://substackcdn.com/image/fetch/$s_!qSyi!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F040453ca-4ac6-4275-bc84-7765a0bc70c4_844x466.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><div class=\\\"pencraft pc-display-flex pc-gap-8 pc-reset\\\"><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container restack-image\\\"><svg role=\\\"img\\\" style=\\\"height:20px;width:20px\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 20 20\\\" fill=\\\"none\\\" stroke-width=\\\"1.5\\\" stroke=\\\"var(--color-fg-primary)\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\"><g><title></title><path d=\\\"M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882\\\"></path></g></svg></button><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container view-image\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 lucide-maximize-2\\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></button></div></div></div></a><figcaption class=\\\"image-caption\\\">Some truly mysterious patterns\u2026.</figcaption></figure></div><p>However, as it turns out, these peaks (2944 and 3120) do <em>not </em>occur when the matrix shapes are divisible by 256, but instead they\u2019re at 128 mod 256! </p><p>As it turns out, these peaks are not caused by poor memory-layouts, they\u2019re instead caused by a (neatly-named) phenomenon called <em>wave quantization</em>.</p><p>The main idea behind wave quantization is quite simple. </p><p>Let\u2019s say we have N parallel tasks (which each take a second) and N CPUs. <br>Q: How long does it perform to take all tasks?<br>A: 1 second</p><p>Q: What about if we have (N+1) parallel tasks, and N CPUs?<br>A: 2 seconds(!) Now, one CPU must perform two tasks, taking a total of 2 seconds.</p><p>So, despite adding just one task, we\u2019ve doubled our overall latency.</p><p>This is exactly what wave quantization is, except with CPUs =&gt; SMs and tasks =&gt; thread blocks.</p><p>As your matrix size increases, the total number of tiles/blocks increases. When this crosses a multiple of the # of SMs, your perf drops since you need to execute an additional \\\"wave\\\".</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/$s_!fQa1!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!fQa1!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png 424w, https://substackcdn.com/image/fetch/$s_!fQa1!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png 848w, https://substackcdn.com/image/fetch/$s_!fQa1!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png 1272w, https://substackcdn.com/image/fetch/$s_!fQa1!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/$s_!fQa1!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png\\\" width=\\\"482\\\" height=\\\"247.17948717948718\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:200,&quot;width&quot;:390,&quot;resizeWidth&quot;:482,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Image&quot;,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}\\\" class=\\\"sizing-normal\\\" alt=\\\"Image\\\" title=\\\"Image\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!fQa1!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png 424w, https://substackcdn.com/image/fetch/$s_!fQa1!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png 848w, https://substackcdn.com/image/fetch/$s_!fQa1!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png 1272w, https://substackcdn.com/image/fetch/$s_!fQa1!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9efc0b0a-93c1-477f-9e88-f59a74cfe6a5_390x200.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div></div></div></a><figcaption class=\\\"image-caption\\\">Taken from <a href=\\\"https://developer.nvidia.com/blog/optimizing-gpu-performance-tensor-cores/\\\">here</a></figcaption></figure></div><p>Now, let's apply our newfound knowledge to actually explain these curves! Let\u2019s try looking at this sudden drop in performance around 1792 first.</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link image2 is-viewable-img\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/$s_!jeez!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!jeez!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png 424w, https://substackcdn.com/image/fetch/$s_!jeez!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png 848w, https://substackcdn.com/image/fetch/$s_!jeez!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png 1272w, https://substackcdn.com/image/fetch/$s_!jeez!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/$s_!jeez!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png\\\" width=\\\"244\\\" height=\\\"429.5299539170507\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:764,&quot;width&quot;:434,&quot;resizeWidth&quot;:244,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Image&quot;,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}\\\" class=\\\"sizing-normal\\\" alt=\\\"Image\\\" title=\\\"Image\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!jeez!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png 424w, https://substackcdn.com/image/fetch/$s_!jeez!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png 848w, https://substackcdn.com/image/fetch/$s_!jeez!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png 1272w, https://substackcdn.com/image/fetch/$s_!jeez!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F98d21d15-54c6-44ad-a522-1fa775badc59_434x764.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><div class=\\\"pencraft pc-display-flex pc-gap-8 pc-reset\\\"><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container restack-image\\\"><svg role=\\\"img\\\" style=\\\"height:20px;width:20px\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 20 20\\\" fill=\\\"none\\\" stroke-width=\\\"1.5\\\" stroke=\\\"var(--color-fg-primary)\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\"><g><title></title><path d=\\\"M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882\\\"></path></g></svg></button><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container view-image\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 lucide-maximize-2\\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></button></div></div></div></a></figure></div><p>Since wave quantization depends a lot on the actual kernel parameters, we must look at what kernels are actually being run.</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/$s_!ceIo!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!ceIo!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png 424w, https://substackcdn.com/image/fetch/$s_!ceIo!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png 848w, https://substackcdn.com/image/fetch/$s_!ceIo!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png 1272w, https://substackcdn.com/image/fetch/$s_!ceIo!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/$s_!ceIo!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png\\\" width=\\\"1456\\\" height=\\\"173\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:173,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Image&quot;,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}\\\" class=\\\"sizing-normal\\\" alt=\\\"Image\\\" title=\\\"Image\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!ceIo!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png 424w, https://substackcdn.com/image/fetch/$s_!ceIo!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png 848w, https://substackcdn.com/image/fetch/$s_!ceIo!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png 1272w, https://substackcdn.com/image/fetch/$s_!ceIo!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F81f276b8-3a39-418f-b586-8c016abb4285_2532x300.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div></div></div></a></figure></div><p>Using the profiler, we see that we're running a CUTLASS-based matmul with a tile size of 256x128. Note that our matmul kernel *doesn't change at all*, but our perf drops from 60+ TF/s at N=1791 to 43 TF/s at N=1793. </p><p>Now, some basic arithmetic. Our tile grid has dimensions 1792/256 = 7 and 1792/128 = 14. That gives us 7 * 14 = 98 tiles. Since an A100 has 108 SMs, that's still one wave. However, with N=1793 we need to increase the size of our grid. (7+1)*(14+1) = 120 tiles, or 2 waves!</p><p>Now, let\u2019s look at the previous (mysterious) stripes. Specifically, we\u2019ll look at N=3200.</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link image2 is-viewable-img\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/$s_!pblj!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!pblj!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png 424w, https://substackcdn.com/image/fetch/$s_!pblj!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png 848w, https://substackcdn.com/image/fetch/$s_!pblj!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png 1272w, https://substackcdn.com/image/fetch/$s_!pblj!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/$s_!pblj!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png\\\" width=\\\"476\\\" height=\\\"262.81516587677726\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:466,&quot;width&quot;:844,&quot;resizeWidth&quot;:476,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Image&quot;,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}\\\" class=\\\"sizing-normal\\\" alt=\\\"Image\\\" title=\\\"Image\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!pblj!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png 424w, https://substackcdn.com/image/fetch/$s_!pblj!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png 848w, https://substackcdn.com/image/fetch/$s_!pblj!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png 1272w, https://substackcdn.com/image/fetch/$s_!pblj!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0c110a2b-9845-4305-b9f0-40c2d61b7831_844x466.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div class=\\\"image-link-expand\\\"><div class=\\\"pencraft pc-display-flex pc-gap-8 pc-reset\\\"><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container restack-image\\\"><svg role=\\\"img\\\" style=\\\"height:20px;width:20px\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 20 20\\\" fill=\\\"none\\\" stroke-width=\\\"1.5\\\" stroke=\\\"var(--color-fg-primary)\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\"><g><title></title><path d=\\\"M2.53001 7.81595C3.49179 4.73911 6.43281 2.5 9.91173 2.5C13.1684 2.5 15.9537 4.46214 17.0852 7.23684L17.6179 8.67647M17.6179 8.67647L18.5002 4.26471M17.6179 8.67647L13.6473 6.91176M17.4995 12.1841C16.5378 15.2609 13.5967 17.5 10.1178 17.5C6.86118 17.5 4.07589 15.5379 2.94432 12.7632L2.41165 11.3235M2.41165 11.3235L1.5293 15.7353M2.41165 11.3235L6.38224 13.0882\\\"></path></g></svg></button><button tabindex=\\\"0\\\" type=\\\"button\\\" class=\\\"pencraft pc-reset pencraft icon-container view-image\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"20\\\" height=\\\"20\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" class=\\\"lucide lucide-maximize2 lucide-maximize-2\\\"><polyline points=\\\"15 3 21 3 21 9\\\"></polyline><polyline points=\\\"9 21 3 21 3 15\\\"></polyline><line x1=\\\"21\\\" x2=\\\"14\\\" y1=\\\"3\\\" y2=\\\"10\\\"></line><line x1=\\\"3\\\" x2=\\\"10\\\" y1=\\\"21\\\" y2=\\\"14\\\"></line></svg></button></div></div></div></a><figcaption class=\\\"image-caption\\\">Mysterious no more!</figcaption></figure></div><p>Profiling it, we see that the <em>proximal</em> cause is not actually wave quantization. Instead, CuBLAS decided to  change algorithms. But, why did CuBLAS decide to change algorithms?</p><div class=\\\"captioned-image-container\\\"><figure><a class=\\\"image-link image2\\\" target=\\\"_blank\\\" href=\\\"https://substackcdn.com/image/fetch/$s_!zEMy!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png\\\" data-component-name=\\\"Image2ToDOM\\\"><div class=\\\"image2-inset\\\"><picture><source type=\\\"image/webp\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!zEMy!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png 424w, https://substackcdn.com/image/fetch/$s_!zEMy!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png 848w, https://substackcdn.com/image/fetch/$s_!zEMy!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png 1272w, https://substackcdn.com/image/fetch/$s_!zEMy!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png 1456w\\\" sizes=\\\"100vw\\\"><img src=\\\"https://substackcdn.com/image/fetch/$s_!zEMy!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png\\\" width=\\\"1456\\\" height=\\\"244\\\" data-attrs=\\\"{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:244,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Image&quot;,&quot;title&quot;:&quot;Image&quot;,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}\\\" class=\\\"sizing-normal\\\" alt=\\\"Image\\\" title=\\\"Image\\\" srcset=\\\"https://substackcdn.com/image/fetch/$s_!zEMy!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png 424w, https://substackcdn.com/image/fetch/$s_!zEMy!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png 848w, https://substackcdn.com/image/fetch/$s_!zEMy!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png 1272w, https://substackcdn.com/image/fetch/$s_!zEMy!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4ccbbbd2-2f3f-46a1-b542-e575decf2f6d_1792x300.png 1456w\\\" sizes=\\\"100vw\\\" loading=\\\"lazy\\\"></picture><div></div></div></a></figure></div><p>Well, (3200/128) * (3200/128) = 625. 625/108 = 5.8 waves. Thus, at N=3232 we would create another wave.</p><p>In this case, though, it seems that 160x128 still isn't a great tile size. Since the resulting grid (26x21) results in 5.05 waves...</p><p>Well, CuBLAS isn't perfect!</p><p>Beyond the obvious matrix multiplication shape issues, performance loss due to wave quantization often ends up being tricky to find, since it depends upon things like the batch size as well. However, if you take a closer look at each matmul, you might find that there\u2019s another 10-15% performance you can squeeze out of it by choosing the shapes more carefully!</p><p>I will note that it\u2019s possible that wave quantization effects may soon be a thing of the past. New matrix multiplication technology like <a href=\\\"https://arxiv.org/abs/2301.03598\\\">stream-k</a> allow us to completely bypass wave quantization effects. Perhaps I\u2019ll explain the basic idea behind matmul implementation strategies someday.</p><h2>Why doesn\u2019t torch.compile just fix my problems so I don\u2019t have to think about this?</h2><p>As it turns out, torch.compile does try and pad your matmuls to have the right shape! See the code <a href=\\\"https://github.com/pytorch/pytorch/blob/6b1f13ea2f3b1bcd575620eecd7d84a4d2e3eb76/torch/_inductor/fx_passes/pad_mm.py#L90\\\">here</a>, or try this benchmark.</p><pre><code>import torch\\ntorch.set_default_device('cuda')\\nfrom triton.testing import do_bench\\n\\ndef f(a, b):\\n    return torch.mm(a, b)\\n\\na = torch.randn(4096, 4096, dtype=torch.bfloat16)\\nb = torch.randn(4096, 4095, dtype=torch.bfloat16)\\nprint(\\\"eager: \\\", do_bench(lambda: f(a, b)))\\ncf = torch.compile(f)\\nprint(\\\"compiled: \\\", do_bench(lambda: cf(a, b)))\\n&gt;&gt; eager: 1.4077268838882446\\n&gt;&gt; compiled: 0.6021425127983093</code></pre><p>However, there are still limitations that mean it makes sense for users to manually pad their shapes. </p><p>For one, padding requires a full copy! Although torch.compile can often fuse this into a preceding op, in the case where the matrix being padded comes from the input (like a weight matrix), there\u2019s no way to avoid this copy.</p><p>Second, resolving wave quantization is far more difficult.</p><h2>Conclusion</h2><p>Overall, I hope the topic of \\\"how do I squeeze the most out of my matmuls\\\" is an interesting one. There's still many more intricacies in matmul perf that I didn\u2019t have the time to get to, as well (I\u2019m sure) many more intricacies that I don\u2019t know! Here\u2019s the <a href=\\\"https://gist.github.com/Chillee/f86675147366a7a0c6e244eaa78660f7#file-4-matmul-bench-py\\\">main code</a> to replicate the results.</p><p>Also, here\u2019s some quiz questions to test your understanding! I will publish a brief explanation of the answers at some later point.</p><h3>Quiz Questions</h3><p><strong>1:</strong> Let's say I have a <code>[M x K] @ [K x N]</code> matmul. Which one of these configurations will have the best perf? Think about the actual ramifications of tiling! Both matrices are in row-major layout (i.e. K and N are the innermost dimensions)<br>A: M=2047, K=N=2048 <br>B: K=2047, M=N=2048 <br>C: N=2047, M=K=2048</p><div class=\\\"poll-embed\\\" data-attrs=\\\"{&quot;id&quot;:161737}\\\" data-component-name=\\\"PollToDOM\\\"></div><p><strong>2: </strong>Let\u2019s say I have an A100 with 108 SMs, and I want to benchmark a number of matmuls with no wave quantization. How would I go about constructing the shapes for these matmuls?</p><p><strong>3: </strong>Based off this post, would you expect that making your batch size a power of 2 leads to more efficient performance?</p><div class=\\\"poll-embed\\\" data-attrs=\\\"{&quot;id&quot;:161740}\\\" data-component-name=\\\"PollToDOM\\\"></div><p><strong>4: </strong>Similar to Question 1, let\u2019s say we have a A: [M x K] @ B: [K x N] matmul.  However, now, A is in column-major (i.e. <code>torch.randn(K, M).t()</code>) while B is still row-major. What is the best configuration now?<br><br>A: M=2047, K=N=2048 <br>B: K=2047, M=N=2048 <br>C: N=2047, M=K=2048</p><p><strong>5: </strong>Let\u2019s say that we have this code.</p><pre><code>A = torch.randn(4096, 4096)\\nB = torch.randn(4096, 4096)\\nB = B[:, :4095] # B now has shape [4096, 4095]</code></pre><p>Would you expect that we have good performance on a matmul between A and B?</p><p>Solutions can be found below<br></p><div class=\\\"digest-post-embed\\\" data-attrs=\\\"{&quot;nodeId&quot;:&quot;1b75e369-7d31-4ed7-858b-2db589bdc13c&quot;,&quot;caption&quot;:&quot;Note: The answer to question 1 is publicly available, but the answers to the rest are paywalled. However, if you write up your solutions to eaach question and message me, I\u2019ll send you the answer key for free. Question 1 Let's say I have a [M x K] @ [K x N]&quot;,&quot;cta&quot;:null,&quot;showBylines&quot;:true,&quot;size&quot;:&quot;lg&quot;,&quot;isEditorNode&quot;:true,&quot;title&quot;:&quot;Answer Key: What Shapes Do Matrix Multiplications Like?&quot;,&quot;publishedBylines&quot;:[{&quot;id&quot;:1514868,&quot;name&quot;:&quot;Horace He&quot;,&quot;bio&quot;:null,&quot;photo_url&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/fc8ac060-6949-4a91-b6b5-88460efd08bc_144x144.png&quot;,&quot;is_guest&quot;:false,&quot;bestseller_tier&quot;:null}],&quot;post_date&quot;:&quot;2024-04-08T14:43:31.466Z&quot;,&quot;cover_image&quot;:&quot;https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0bd02621-bbe2-44c9-8fa3-4809a5087400_1828x600.png&quot;,&quot;cover_image_alt&quot;:null,&quot;canonical_url&quot;:&quot;https://www.thonking.ai/p/answer-key-what-shapes-do-matrix&quot;,&quot;section_name&quot;:null,&quot;video_upload_id&quot;:null,&quot;id&quot;:143205705,&quot;type&quot;:&quot;newsletter&quot;,&quot;reaction_count&quot;:2,&quot;comment_count&quot;:0,&quot;publication_id&quot;:null,&quot;publication_name&quot;:&quot;Thonk From First Principles&quot;,&quot;publication_logo_url&quot;:&quot;https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F55e3b22f-cc6b-438a-be3d-8d17cc97c2f9_750x750.png&quot;,&quot;belowTheFold&quot;:true,&quot;youtube_url&quot;:null,&quot;show_links&quot;:null,&quot;feed_url&quot;:null}\\\"></div><div class=\\\"subscription-widget-wrap-editor\\\" data-attrs=\\\"{&quot;url&quot;:&quot;https://www.thonking.ai/subscribe?&quot;,&quot;text&quot;:&quot;Subscribe&quot;,&quot;language&quot;:&quot;en&quot;}\\\" data-component-name=\\\"SubscribeWidgetToDOM\\\"><div class=\\\"subscription-widget show-subscribe\\\"><div class=\\\"preamble\\\"><p class=\\\"cta-caption\\\">Thonk From First Principles is a reader-supported publication. To receive new posts and support my work, consider becoming a free or paid subscriber.</p></div><form class=\\\"subscription-widget-subscribe\\\"><input type=\\\"email\\\" class=\\\"email-input\\\" name=\\\"email\\\" placeholder=\\\"Type your email\u2026\\\" tabindex=\\\"-1\\\"><input type=\\\"submit\\\" class=\\\"button primary\\\" value=\\\"Subscribe\\\"><div class=\\\"fake-input-wrapper\\\"><div class=\\\"fake-input\\\"></div><div class=\\\"fake-button\\\"></div></div></form></div></div><div class=\\\"footnote\\\" data-component-name=\\\"FootnoteToDOM\\\"><a id=\\\"footnote-1\\\" href=\\\"#footnote-anchor-1\\\" class=\\\"footnote-number\\\" contenteditable=\\\"false\\\" target=\\\"_self\\\">1</a><div class=\\\"footnote-content\\\"><p>A cache line is a block of memory that\u2019s usually something like 128 bytes long, although in our examples, we\u2019re pretending that it\u2019s 4 elements long. You can pretend that a cache line is the \u201Cminimum memory access size\u201D. In other words, in order to load any of the elements from a cache line, you must load the entire cache line.</p></div></div><div class=\\\"footnote\\\" data-component-name=\\\"FootnoteToDOM\\\"><a id=\\\"footnote-2\\\" href=\\\"#footnote-anchor-2\\\" class=\\\"footnote-number\\\" contenteditable=\\\"false\\\" target=\\\"_self\\\">2</a><div class=\\\"footnote-content\\\"><p>In fact, earlier versions of CuBLAS (back when tensor cores were new) didn\u2019t even <em>use</em> tensor-cores unless the shapes were divisible by 8.</p></div></div>\",\"truncated_body_text\":\"A while back, Karpathy tweeted that increasing the size of his matmul made it run faster. Surprisingly, it\u2019s not just relatively faster, it takes less absolute time. In other words, despite doing more work, it is executing in less time.\",\"wordcount\":2128,\"postTags\":[{\"id\":\"4851de50-8160-4e9f-8ca0-8d31d580bb53\",\"publication_id\":1781836,\"name\":\"matmuls\",\"slug\":\"matmuls\",\"hidden\":false},{\"id\":\"56ed881f-72bb-496c-bb72-1d948a7d5b9a\",\"publication_id\":1781836,\"name\":\"short\",\"slug\":\"short\",\"hidden\":false},{\"id\":\"b051c96b-6196-42b4-b5fe-f32db23c7d96\",\"publication_id\":1781836,\"name\":\"torch.compile\",\"slug\":\"torchcompile\",\"hidden\":false}],\"postCountryBlocks\":[],\"headlineTest\":null,\"coverImagePalette\":{\"Vibrant\":{\"rgb\":[54.64285714285703,200.35714285714295,200.35714285714297],\"population\":0},\"DarkVibrant\":{\"rgb\":[28.414285714285658,104.18571428571433,104.18571428571434],\"population\":0},\"LightVibrant\":{\"rgb\":[244,252,252],\"population\":3},\"Muted\":{\"rgb\":[124,124,126],\"population\":79},\"DarkMuted\":{\"rgb\":[71,93,110],\"population\":56},\"LightMuted\":{\"rgb\":[176,193,212],\"population\":15}},\"publishedBylines\":[{\"id\":1514868,\"name\":\"Horace He\",\"handle\":\"chilli\",\"previous_name\":null,\"photo_url\":\"https://substack-post-media.s3.amazonaws.com/public/images/fc8ac060-6949-4a91-b6b5-88460efd08bc_144x144.png\",\"bio\":null,\"profile_set_up_at\":\"2023-02-27T20:47:55.806Z\",\"reader_installed_at\":\"2024-01-14T12:26:07.734Z\",\"publicationUsers\":[{\"id\":1764608,\"user_id\":1514868,\"publication_id\":1781836,\"role\":\"admin\",\"public\":true,\"is_primary\":true,\"publication\":{\"id\":1781836,\"name\":\"Thonk From First Principles\",\"subdomain\":\"thonking\",\"custom_domain\":\"www.thonking.ai\",\"custom_domain_optional\":false,\"hero_text\":\"ML Systems from first principles. Aims to be better than a ChatGPT summary.\",\"logo_url\":\"https://substack-post-media.s3.amazonaws.com/public/images/55e3b22f-cc6b-438a-be3d-8d17cc97c2f9_750x750.png\",\"author_id\":1514868,\"primary_user_id\":1514868,\"theme_var_background_pop\":\"#99A2F1\",\"created_at\":\"2023-07-06T02:56:13.729Z\",\"email_from_name\":null,\"copyright\":\"Horace He\",\"founding_plan_name\":\"Founding Member\",\"community_enabled\":true,\"invite_only\":false,\"payments_state\":\"enabled\",\"language\":null,\"explicit\":false,\"homepage_type\":\"newspaper\",\"is_personal_mode\":false}}],\"is_guest\":false,\"bestseller_tier\":null,\"status\":{\"bestsellerTier\":null,\"subscriberTier\":1,\"leaderboard\":null,\"vip\":false,\"badge\":{\"type\":\"subscriber\",\"tier\":1,\"accent_colors\":null},\"paidPublicationIds\":[89120,159369],\"subscriber\":null}}],\"reaction\":null,\"reaction_count\":91,\"comment_count\":2,\"child_comment_count\":2,\"audio_items\":[{\"post_id\":142904770,\"voice_id\":\"en-US-OnyxTurboMultilingualNeural\",\"audio_url\":\"https://substack-video.s3.amazonaws.com/video_upload/post/142904770/tts/c33a694d-beb8-4eed-9214-26fafc9eebce/en-US-OnyxTurboMultilingualNeural.mp3\",\"type\":\"tts\",\"status\":\"completed\"}],\"is_geoblocked\":false,\"hasCashtag\":false},\"comments\":[{\"id\":78734998,\"body\":\"Can you get Grant Sanderson to illustrate this with animations on 3Blue 1Brown?\",\"body_json\":{\"type\":\"doc\",\"attrs\":{\"schemaVersion\":\"v1\"},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"type\":\"text\",\"text\":\"Can you get Grant Sanderson to illustrate this with animations on 3Blue 1Brown?\"}]}]},\"publication_id\":1781836,\"post_id\":142904770,\"user_id\":42039806,\"ancestor_path\":\"\",\"type\":\"comment\",\"deleted\":false,\"date\":\"2024-11-25T05:58:55.037Z\",\"edited_at\":null,\"status\":\"published\",\"pinned_by_user_id\":null,\"restacks\":0,\"name\":\"Gregor Shapiro\",\"photo_url\":\"https://substack-post-media.s3.amazonaws.com/public/images/3f015139-8bba-4579-8d3b-0d7687eea901_144x144.png\",\"handle\":\"gregorshapiro772284\",\"reactor_names\":[\"Horace He\"],\"reaction\":null,\"reactions\":{\"\u2764\":6},\"reaction_count\":6,\"children\":[],\"bans\":[],\"suppressed\":false,\"user_banned\":false,\"user_banned_for_comment\":false,\"user_slug\":\"gregorshapiro772284\",\"metadata\":{\"is_author\":false,\"membership_state\":null,\"eligibleForGift\":true,\"author_on_other_pub\":{\"name\":\"Gregor Shapiro\",\"id\":7799183,\"base_url\":\"https://gregorshapiro772284.substack.com\"}},\"country_blocks\":[],\"user_bestseller_tier\":null,\"can_dm\":true,\"userStatus\":{\"bestsellerTier\":null,\"subscriberTier\":null,\"leaderboard\":null,\"vip\":false,\"badge\":null,\"subscriber\":null},\"score\":11,\"children_count\":0,\"reported_by_user\":false,\"restacked\":false},{\"id\":75778790,\"body\":\"It seems a lot closer on AMD/ROCM: https://imgur.com/a/iEv8Lu7 (No torch.compile) They probably always do size optimization to some extent. https://gist.github.com/FeepingCreature/aec0e569e83a436bed7f4516263cd9fc Code I had Sonnet make me.\",\"body_json\":{\"type\":\"doc\",\"attrs\":{\"schemaVersion\":\"v1\"},\"content\":[{\"type\":\"paragraph\",\"content\":[{\"type\":\"text\",\"text\":\"It seems a lot closer on AMD/ROCM: \"},{\"type\":\"text\",\"text\":\"https://imgur.com/a/iEv8Lu7\",\"marks\":[{\"type\":\"link\",\"attrs\":{\"href\":\"https://imgur.com/a/iEv8Lu7\"}}]},{\"type\":\"text\",\"text\":\" (No torch.compile) They probably always do size optimization to some extent. \"},{\"type\":\"text\",\"text\":\"https://gist.github.com/FeepingCreature/aec0e569e83a436bed7f4516263cd9fc\",\"marks\":[{\"type\":\"link\",\"attrs\":{\"href\":\"https://gist.github.com/FeepingCreature/aec0e569e83a436bed7f4516263cd9fc\"}}]},{\"type\":\"text\",\"text\":\" Code I had Sonnet make me.\"}]}]},\"publication_id\":1781836,\"post_id\":142904770,\"user_id\":11057353,\"ancestor_path\":\"\",\"type\":\"comment\",\"deleted\":false,\"date\":\"2024-11-06T13:32:51.215Z\",\"edited_at\":null,\"status\":\"published\",\"pinned_by_user_id\":null,\"restacks\":0,\"name\":\"FeepingCreature\",\"photo_url\":null,\"handle\":\"feepingcreature194766\",\"reactor_names\":[],\"reaction\":null,\"reactions\":{\"\u2764\":0},\"reaction_count\":0,\"children\":[],\"bans\":[],\"suppressed\":false,\"user_banned\":false,\"user_banned_for_comment\":false,\"user_slug\":\"feepingcreature194766\",\"metadata\":{\"is_author\":false,\"membership_state\":null,\"eligibleForGift\":true},\"country_blocks\":[],\"user_bestseller_tier\":null,\"can_dm\":true,\"userStatus\":{\"bestsellerTier\":null,\"subscriberTier\":null,\"leaderboard\":null,\"vip\":false,\"badge\":null,\"subscriber\":null},\"score\":1,\"children_count\":0,\"reported_by_user\":false,\"restacked\":false}],\"canonicalUrl\":\"https://www.thonking.ai/p/what-shapes-do-matrix-multiplications\",\"inlineComments\":false,\"readerIsSearchCrawler\":false,\"ogUrl\":\"https://www.thonking.ai/p/what-shapes-do-matrix-multiplications\",\"bannedFromNotes\":false,\"themeVariables\":{\"color_theme_bg_pop\":\"#99A2F1\",\"background_pop\":\"#99A2F1\",\"color_theme_bg_web\":null,\"cover_bg_color\":\"#FFFFFF\",\"cover_bg_color_secondary\":\"#f0f0f0\",\"background_pop_darken\":\"#838eee\",\"print_on_pop\":\"#ffffff\",\"color_theme_bg_pop_darken\":\"#838eee\",\"color_theme_print_on_pop\":\"#ffffff\",\"color_theme_bg_pop_20\":\"rgba(153, 162, 241, 0.2)\",\"color_theme_bg_pop_30\":\"rgba(153, 162, 241, 0.3)\",\"print_pop\":\"#99a2f1\",\"color_theme_accent\":\"#99a2f1\",\"cover_print_primary\":\"#363737\",\"cover_print_secondary\":\"#757575\",\"cover_print_tertiary\":\"#b6b6b6\",\"cover_border_color\":\"#99a2f1\",\"home_hero\":\"newspaper\",\"home_posts\":\"list\",\"background_contrast_1\":\"#f0f0f0\",\"background_contrast_2\":\"#dddddd\",\"background_contrast_3\":\"#b7b7b7\",\"background_contrast_4\":\"#929292\",\"background_contrast_5\":\"#515151\",\"color_theme_detail\":\"#e6e6e6\",\"background_contrast_pop\":\"rgba(153, 162, 241, 0.4)\",\"color_theme_bg_contrast_pop\":\"rgba(153, 162, 241, 0.4)\",\"theme_bg_is_dark\":\"0\",\"background_pop_rgb\":\"153, 162, 241\",\"color_theme_bg_pop_rgb\":\"153, 162, 241\",\"color_theme_accent_rgb\":\"153, 162, 241\"},\"recentEpisodes\":null,\"trackFrontendVisit\":true,\"activeLiveStream\":null,\"freeTrialCoupon\":{\"id\":\"9f420262\"},\"isChatActive\":false,\"isMeetingsActive\":false,\"publicationPageAlert\":null,\"features\":{},\"browser\":{},\"showCookieBanner\":false,\"disabledCookies\":[],\"dd_env\":\"prod\",\"dd_ti\":true}")</script>
        <script>window._analyticsConfig = JSON.parse("{\"properties\":{\"subdomain\":\"thonking\",\"publication_id\":1781836,\"has_plans\":true,\"pub_community_enabled\":true,\"is_personal_publication\":false,\"is_subscribed\":false,\"is_free_subscribed\":false,\"is_author\":false,\"is_contributor\":false,\"is_admin\":false,\"is_founding\":false},\"adwordsAccountId\":\"AW-316245675\",\"adwordsEventSendTo\":\"Tf76CKqcyL4DEKuN5pYB\"}")</script>

        
        
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/lib-router.3584a832.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/92520.83f84267.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/43876.745e4151.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/75058.15ca3cb4.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/6663.548303af.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/21283.c60c3e68.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/91217.2a8df522.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/23553.c95dd7e6.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/43429.dce8c200.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/54897.9acf3a36.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/97957.39e06153.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/27994.7dd99f13.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/67562.cff82cea.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/19971.04a24b71.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/92536.21822b7d.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/46393.ea14da07.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/10091.1e739b1a.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/33063.f6f1d4ec.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/78634.cd1f3c9e.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/99795.10d8d86d.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/72937.ac747f7d.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/69890.27f04135.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/37458.f707d843.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/54900.64562c90.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/91989.91c663fc.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/59163.9bcc3b6e.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/96846.18e20804.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/44078.96d94c9e.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/38470.36011abd.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/79783.487b8da0.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/79264.04fa5bc2.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/382.65355765.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/56938.02eeb0cc.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/43995.553f6f99.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/96809.94393625.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/56417.3d12c641.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/52144.a22893ab.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/56208.050766bd.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/51743.e685182b.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/3000.cf9106f1.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/36519.9b22a919.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/87142.4d96d745.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/76206.cb5ba73d.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/34036.a6b47a72.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/80205.2522e81f.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/19861.2115d7be.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/61092.79d0c3af.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/86258.d1df828e.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/55753.10d6b953.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/75460.ebec26be.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/22309.97420987.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/75353.9190b33d.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/83034.bca7267b.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/26973.a7584231.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/60734.1b3940da.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/41091.b10eca37.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/71414.82d94079.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/91525.905d762b.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/82295.d2c275c0.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/96109.7fac76d4.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/21337.35e42034.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/43302.6f6356a1.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/92815.47f4a96c.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/4486.eb0848a8.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/36385.69018b6f.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/12259.9a731085.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/39966.93129aa2.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/35840.a46e699c.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/67571.a4f201b0.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/45636.8b9d52c5.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/42928.81ad6033.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/55263.68ec3816.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/96998.8ba7fbe6.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/39494.2525199b.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/30474.9f613bc8.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/64868.2c0ff117.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/78176.2a6e910f.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/20711.8833a173.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/28178.ee78b268.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/98651.49b7c961.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/1116.1f32e081.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/9049.fd0f1784.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/90883.54df9d9b.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/83774.4c58d392.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/63042.358f9717.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/23447.9416874a.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/15289.5646bc1e.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/31608.67f8d675.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/76229.7f384f8c.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/main.e9a34558.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/98651.49b7c961.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/28178.ee78b268.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/9049.fd0f1784.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/1116.1f32e081.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/20711.8833a173.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/78176.2a6e910f.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/8006.c8b9f87e.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/30474.9f613bc8.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/39494.2525199b.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/96998.8ba7fbe6.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/48810.976625d5.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/55263.68ec3816.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/42928.81ad6033.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/45636.8b9d52c5.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/35840.a46e699c.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/39966.93129aa2.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/61219.044c2602.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/36385.69018b6f.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/4486.eb0848a8.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/92815.47f4a96c.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/43302.6f6356a1.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/21337.35e42034.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/96109.7fac76d4.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/93975.378d9bde.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/91525.905d762b.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/71414.82d94079.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/41091.b10eca37.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/60734.1b3940da.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/26973.a7584231.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/83034.bca7267b.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/75353.9190b33d.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/22309.97420987.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/75460.ebec26be.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/55753.10d6b953.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/61092.79d0c3af.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/19861.2115d7be.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/87142.4d96d745.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/36519.9b22a919.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/51743.e685182b.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/52144.a22893ab.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/56417.3d12c641.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/96809.94393625.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/43327.0fca409c.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/78604.e49b68d8.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/38470.36011abd.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/86379.46cc4a20.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/94551.6bb82677.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/44078.96d94c9e.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/96846.18e20804.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/59163.9bcc3b6e.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/54900.64562c90.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/96869.dab60cd3.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/37458.f707d843.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/69890.27f04135.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/72937.ac747f7d.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/99795.10d8d86d.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/78634.cd1f3c9e.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/33063.f6f1d4ec.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/10091.1e739b1a.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/92536.21822b7d.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/19971.04a24b71.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/97957.39e06153.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/43429.dce8c200.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/23553.c95dd7e6.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/91217.2a8df522.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/21283.c60c3e68.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/6663.548303af.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/75058.15ca3cb4.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/43876.745e4151.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/lib-router.3584a832.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/30372.4bed9052.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/98216.007bddfe.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/81669.008aff72.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/24144.444885d1.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/52902.3d5b9313.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/31608.67f8d675.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/14879.1b02f7a5.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/25363.36a6aafa.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/55674.6300693a.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/83774.4c58d392.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/90883.54df9d9b.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/33393.768966c7.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/63149.5e4d3fb8.js" charset="utf-8"></script>
            
                <script defer type="module" src="https://substackcdn.com/bundle/static/js/29108.60cab1f3.js" charset="utf-8"></script>
            
        
        <script nomodule>
            (function() {
                var message = 'Your browser does not support modern JavaScript modules. Please upgrade your browser for the best experience.';
                var warningDiv = document.createElement('div');
                warningDiv.style.color = 'red';
                warningDiv.style.padding = '10px';
                warningDiv.style.margin = '10px 0';
                warningDiv.style.border = '1px solid red';
                warningDiv.style.backgroundColor = 'lightyellow';
                warningDiv.innerText = message;
                document.body.prepend(warningDiv);
            })();
        </script>

        
            <!-- Datadog Analytics -->
            <script>
              (function(h,o,u,n,d) {
                h=h[d]=h[d]||{q:[],onReady:function(c){h.q.push(c)}}
                d=o.createElement(u);d.async=1;d.src=n
                n=o.getElementsByTagName(u)[0];n.parentNode.insertBefore(d,n)
              })(window,document,'script','https://www.datadoghq-browser-agent.com/us1/v5/datadog-rum.js','DD_RUM')
              window.DD_RUM.onReady(function() {
                window.DD_RUM.init({
                  clientToken: 'puba71073f072643721169b68f352438710',
                  applicationId: '2e321b35-c76b-4073-8d04-cc9a10461793',
                  site: 'datadoghq.com',
                  service: 'web',
                  env: window._preloads.dd_env,
                  version: 'd8143e8381634b92d138f597ba0ebcb86ec7eb98',
                  sessionSampleRate: 1,
                  sessionReplaySampleRate: 100,
                  trackUserInteractions: window._preloads.dd_ti,
                  trackResources: true,
                  trackLongTasks: true,
                  defaultPrivacyLevel: 'mask-user-input',
                  allowedTracingUrls: [/https?:\/\/(.+\/.)?substack(cdn)?\.com/]
                });
              })
            </script>
            <!-- End Datadog Analytics -->

            <!-- Cloudflare Web Analytics -->
            <script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token": "216309cffb464db4b0e02daf0b8e8060"}'></script>
            <!-- End Cloudflare Web Analytics -->
        

        <!-- Fallback tracking pixels -->
        

        

        <noscript>
    <style>
        #nojs-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            padding: 16px 16px 16px 32px;
            width: 100%;
            box-sizing: border-box;
            background: red;
            color: white;
            font-family: -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            font-size: 13px;
            line-height: 13px;
        }
        #nojs-banner a {
            color: inherit;
            text-decoration: underline;
        }
    </style>

    <div id="nojs-banner">
        This site requires JavaScript to run correctly. Please <a href="https://enable-javascript.com/" target="_blank">turn on JavaScript</a> or unblock scripts
    </div>
</noscript>


        

        

        
        
    </body>
</html>
